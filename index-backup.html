<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ≠Ê∫Ä ÂÑÑÂçÉ‰∏áÂÑÑÂçÉ‰∏á by watokiryuu</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #game-container {
            position: relative;
            width: 800px;
            height: 500px;
            background-color: #000;
            overflow: hidden;
            border: 4px solid #444;
        }
        
        #game-canvas {
            background-color: #000;
        }
        
        #start-screen, #game-over-screen, #win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 10;
        }
        
        #game-over-screen, #win-screen {
            display: none;
        }
        
        h1 {
            color: #4af;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #4af;
        }
        
        button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4af;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        button:hover {
            background-color: #6cf;
        }
        
        #health-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
        }
        
        #health-fill {
            height: 100%;
            width: 100%;
            background-color: #4af;
            transition: width 0.3s;
        }
        
        #boss-health-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
            display: none;
        }
        
        #boss-health-fill {
            height: 100%;
            width: 100%;
            background-color: #ccc;
            transition: width 0.3s;
        }
        
        #score {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            font-size: 18px;
            z-index: 5;
        }
        
        #camera-debug {
            position: absolute;
            top: 70px;
            left: 10px;
            color: white;
            font-size: 12px;
            z-index: 5;
        }
        
        #win-screen h1 div {
            text-align: center;
        }
    </style>
</head>
<body>
    <audio id="bgm" src="bgm.mp3" loop style="display:none"></audio>
    <audio id="shoot-audio" src="shoot.mp3" style="display:none"></audio>
    <audio id="game-over-audio" src="game-over.mp3" style="display:none"></audio>
    <audio id="charge-audio" src="charge.mp3" loop style="display:none"></audio>
    <audio id="boom-audio" src="boom.mp3" style="display:none"></audio>
    <audio id="hurt-audio" src="hurt.mp3" style="display:none"></audio>
    <audio id="bossdie-audio" src="bossdie.mp3" style="display:none"></audio>
    <audio id="outro-audio" src="outro.mp3" style="display:none"></audio>
    <audio id="boss-audio" src="boss.mp3" style="display:none"></audio>
    <div id="game-container">
        <button id="lang-toggle" style="position:absolute;top:10px;right:10px;z-index:30;background:#222;color:#fff;border-radius:6px;padding:4px 12px;font-size:14px;">üåê</button>
        <div id="language-select" style="position:absolute;top:40px;right:10px;z-index:29;background:#222;padding:12px 24px;border-radius:10px;box-shadow:0 2px 12px #0008;display:none;flex-direction:column;align-items:center;">
            <h2 style="color:#fff;margin-bottom:10px;font-size:16px;">ÈÅ∏ÊìáË™ûË®Ä / Ë®ÄË™û„ÇíÈÅ∏Êäû / Select Language</h2>
            <div style="display:flex;gap:12px;">
                <button id="lang-zh">‰∏≠Êñá</button>
                <button id="lang-ja">Êó•Êú¨Ë™û</button>
                <button id="lang-en">English</button>
            </div>
        </div>
        <canvas id="game-canvas" width="800" height="500"></canvas>
        
        <div id="health-bar">
            <div id="health-fill"></div>
        </div>
        
        <div id="boss-health-container">
            <div id="boss-health-fill"></div>
        </div>
        
        <div id="score">score: 0</div>
        <div id="camera-debug"></div>
        
        <div id="start-screen">
            <h1>ÂÑÑÂçÉ‰∏áÂÑÑÂçÉ‰∏á</h1>
            <p>Á©∫ÁôΩÈçµÂ∞ÑÊìä</p>
            <p>Â∑¶Âè≥ÁßªÂãï</p>
            <p>‰∏äË∑≥Ë∫ç</p>
            <button id="start-button">START</button>
        </div>
        
        <div id="game-over-screen">
            <h1 style="color:#800;">Êâì‰∏çÂÄíÁöÑÁ©∫Ê∞£‰∫∫</h1>
            <p id="final-score">score: 0</p>
            <button id="restart-button">ÂÜçtrytry</button>
        </div>
        
        <div id="win-screen">
            <h1>ÂãùÂà©!</h1>
            <p id="win-score">score: 0</p>
            <button id="play-again-button">‰Ω†ÊÉ≥ÂÜçÁé©‰∏ÄÊ¨°‰πüÊòØÂèØ‰ª•...</button>
            <div id="by-watoki" style="position:absolute;right:18px;bottom:10px;color:#fff;font-size:18px;z-index:20;text-shadow:0 0 4px #000a;">by Watoki</div>
        </div>
    </div>
    <div id="flash-effect" style="position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:100;display:none;"></div>
    <img id="tornado-img" src="tornadoes.png" style="display:none" />

    <script>
        // ===== ÈÅäÊà≤Ë®≠ÂÆöÔºàÈõÜ‰∏≠Êï¥ÁêÜÔºâ =====
        // È°èËâ≤Ë®≠ÂÆö
        const COLOR_PLATFORM_NORMAL = '#444';
        const COLOR_PLATFORM_BOSS   = '#800';
        const COLOR_PLATFORM_HIGH   = '#666';
        const COLOR_PLAYER          = '#4af';
        const COLOR_BOSS            = '#2196f3';
        const COLOR_BOSS_FAN        = '#ffe082';
        const COLOR_BOSS_FAN_CENTER = '#fff';
        const COLOR_BULLET_NORMAL   = '#b3f0ff';
        const COLOR_BULLET_CHARGE   = '#ff0';
        const COLOR_BULLET_ENEMY    = '#f8f';
        const COLOR_BULLET_BOSS     = '#f4a';
        // Èü≥ÈáèË®≠ÂÆö
        const VOLUME_BGM      = 0.55;
        const VOLUME_SHOOT    = 0.55;
        const VOLUME_CHARGE   = 0.55;
        const VOLUME_BOOM     = 0.45;
        const VOLUME_HURT     = 0.70;
        const VOLUME_GAMEOVER = 0.75;
        const VOLUME_BOSSDIE  = 0.40;
        const VOLUME_BOSS     = 0.85;
        const VOLUME_OUTRO    = 0.55;
        // ÈÅäÊà≤Â∏∏Êï∏
        const GRAVITY         = 0.6; // ‰øùÊåÅÂéüÊú¨
        const JUMP_POWER      = -11.5; // Êñ∞ÂàùÈÄüÂ∫¶ÔºåËÆìÈï∑ÊåâÊúÄÈ´òÁ¥Ñ250
        const JUMP_EXTRA      = -0.35; // ÊØèÂπÄÂ¢ûÂäõ
        const JUMP_EXTRA_FRAMES = 12; // 0.2Áßí@60fps
        const WORLD_WIDTH     = 2700 * 2;  // ‰∏ñÁïåÂØ¨Â∫¶2ÂÄç
        const WORLD_HEIGHT    = 500;
        const BOSS_AREA_X     = 2000 + 2700 * 1; // BossÂçÄÂüüËµ∑Èªû5400
        const CHARGE_MIN_FRAME = 42; // 0.7Áßí
        const CHARGE_CANCEL_FRAME = 12; // 0.2Áßí
        // 223Ë°åÈñãÂßãÔºåÈõÜ‰∏≠ÊâÄÊúâÂú∞ÊùøÂèÉÊï∏ÔºàÊòéÁ¢∫Â±ïÈñãÂÖ©Ëº™ÔºåÁÑ° for Ëø¥ÂúàËá™ÂãïË§áË£ΩÔºâ
        const basePlatforms = [
            // Á¨¨‰∏ÄÂçÄÔºà0~2700Ôºâ
            { x: 0, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 50, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 100, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 150, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 200, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 250, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 300, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 350, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 400, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 450, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 500, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 550, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 600, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 650, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 700, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 750, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // ‰∏≠ÈñìÂçÄÂüü
            { x: 850, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 900, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 950, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 1000, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            // { x: 1050, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 1100, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1150, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1200, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 1250, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 1300, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1350, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 1400, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 1450, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1500, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 1550, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 1600, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1650, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1700, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1750, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 1800, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 1850, y: 200, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1900, y: 200, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 1950, y: 200, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 2000, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 2050, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 2100, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2150, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 2200, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 2250, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2300, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 2350, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 2400, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2450, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2500, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2550, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 2600, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            // { x: 2650, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 2700, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2750, y: 300, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2800, y: 300, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2850, y: 300, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2900, y: 300, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 2950, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 3000, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 3050, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3100, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3150, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3200, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3250, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3300, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3350, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 3400, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 3450, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3500, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3550, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3600, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3650, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3700, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3750, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            // { x: 3800, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 3850, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 3900, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 3950, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 4000, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 4050, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 4100, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 4150, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            // { x: 4200, y: 350, width: 50, height: 50, color: COLOR_PLATFORM_HIGH },
            { x: 4250, y: 150, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 4300, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 4350, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            { x: 4400, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 4450, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // { x: 4500, y: 400, width: 50, height: 50, color: COLOR_PLATFORM_NORMAL },
            // Boss ÂçÄÂüüÂú∞ÊùøÔºàx=4600 ‰πãÂæåÔºâ
            { x: 4550, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4600, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4650, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4700, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4750, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4800, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4850, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4900, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 4950, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5000, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5050, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5100, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5150, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5200, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5250, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5300, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5350, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5400, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
            { x: 5400, y: 450, width: 50, height: 50, color: COLOR_PLATFORM_BOSS },
        ];
        // ===== DOM ÂÖÉÁ¥†ÈÅ∏Âèñ =====
        const canvas              = document.getElementById('game-canvas');
        const ctx                 = canvas.getContext('2d');
        
        const startScreen         = document.getElementById('start-screen');
        const gameOverScreen      = document.getElementById('game-over-screen');
        const winScreen           = document.getElementById('win-screen');
        
        const startButton         = document.getElementById('start-button');
        const restartButton       = document.getElementById('restart-button');
        const playAgainButton     = document.getElementById('play-again-button');
        
        const healthFill          = document.getElementById('health-fill');
        const bossHealthContainer = document.getElementById('boss-health-container');
        const bossHealthFill      = document.getElementById('boss-health-fill');
        
        const scoreElement        = document.getElementById('score');
        const finalScoreElement   = document.getElementById('final-score');
        const winScoreElement     = document.getElementById('win-score');
        const cameraDebugElement  = document.getElementById('camera-debug');
        
        // ===== ÈÅäÊà≤ÁãÄÊÖã =====
        let gameRunning  = false;
        let score        = 0;
        let playerMaxHealth = 100; // Êñ∞Â¢ûÊúÄÂ§ßË°ÄÈáè
        let playerHealth = playerMaxHealth;
        let bossHealth   = 300;  // Â¢ûÂº∑BossË°ÄÈáè
        let bossActive   = false;
        let bossTimer    = 0;
        let reachedBossArea = false; // Áé©ÂÆ∂ÊòØÂê¶Â∑≤Á∂ìÊäµÈÅîÈÅébossÂçÄÂüü
        let charging = false; // ÊòØÂê¶Ê≠£Âú®ÈõÜÊ∞£
        let chargeFrame = 0; // ÈõÜÊ∞£ÊåÅÁ∫åÂπÄÊï∏
        let chargeReady = false; // ÊòØÂê¶ÈõÜÊ∞£ÂÆåÊàê
        let bossHitFlash = 0; // BossË¢´Êìä‰∏≠ÈñÉÁàçË®àÊï∏
        let upPressed = false; // ËøΩËπ§‰∏äÈçµÊòØÂê¶Â∑≤Á∂ìÊåâ‰∏ã
        let chargeAudioTimeout = null;
        let bossCanAttack = false;
        let bossCanMove = false;
        let bossHpAnimating = false;
        let canShoot = true;
        let midEventTriggered = false;
        
        // ===== Èè°È†≠Á≥ªÁµ± =====
        const camera = {
            x: 0,
            y: 0,
            width: canvas.width,
            height: canvas.height,
            // Âπ≥ÊªëË∑üÈö®Áé©ÂÆ∂
            follow: function(target) {
                const centerX = target.x + target.width/2;
                const centerY = target.y + target.height/2;
                
                // Ê∞¥Âπ≥Ë∑üÈö®
                this.x = centerX - this.width/2;
                
                // Áï∂Áé©ÂÆ∂ÊäµÈÅîbossÂçÄÂüüÂæåÔºåÈè°È†≠Â∑¶ÈÇäÁïåÈéñÂÆöÂú®BOSS_AREA_X
                if (target.x >= BOSS_AREA_X) {
                    this.x = Math.max(BOSS_AREA_X, this.x);
                }
                
                // ÂûÇÁõ¥Ë∑üÈö® (‰ΩÜÈôêÂà∂‰∏çËÆìÁé©ÂÆ∂ÁúãÂà∞Âú∞ÂúñÂ§ñ)
                const maxY = WORLD_HEIGHT - this.height;
                this.y = Math.min(maxY, Math.max(0, centerY - this.height/2));
                
                // ÈôêÂà∂‰∏çË∂ÖÂá∫‰∏ñÁïåÈÇäÁïå
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
            }
        };
        
        // ===== Áé©ÂÆ∂Áâ©‰ª∂ =====
        const player = {
            x: 100,
            y: 0,             // Êñº startGame() ÊîæÁΩÆÊñºÂπ≥Âè∞‰∏ä
            width: 40,
            height: 40,
            speed: 5,
            vy: 0,            // ÂûÇÁõ¥ÈÄüÂ∫¶
            onGround: false,  // ÊòØÂê¶ËëóÂú∞
            color: '#4af',
            isShooting: false,
            shootCooldown: 0,
            shootDelay: 15,
            direction: 1,    // 1=ÂêëÂè≥ / -1=ÂêëÂ∑¶
            invincible: 0,    // ÁÑ°ÊïµÊôÇÈñì
            
            // Êõ¥Êñ∞Áé©ÂÆ∂‰ΩçÁΩÆ
            update: function() {
                // ÊòØÂê¶ÊäµÈÅîÈÅébossÂçÄÂüü
                if (this.x >= BOSS_AREA_X) {
                    reachedBossArea = true;
                }
                // Ê∞¥Âπ≥ÁßªÂãï
                if (keys.ArrowLeft)  {
                    if (reachedBossArea) {
                        this.x -= this.speed;
                        if (this.x < BOSS_AREA_X) this.x = BOSS_AREA_X;
                    } else {
                        this.x -= this.speed;
                        if (this.x < 0) this.x = 0;
                    }
                    this.direction = -1;
                }
                if (keys.ArrowRight) { this.x += this.speed; this.direction =  1; }
                
                // Ë∑≥Ë∫ç
                if (keys.ArrowUp && this.onGround && !upPressed) {
                    this.vy = JUMP_POWER;
                    this.onGround = false;
                    upPressed = true;
                    isJumping = true;
                    jumpHoldFrames = 0;
                }
                if (!keys.ArrowUp) upPressed = false;
                
                // ÈáçÂäõËàáÊñ∞ y ‰ΩçÁΩÆ
                this.vy += GRAVITY;
                let newY = this.y + this.vy;
                
                // Âπ≥Âè∞Á¢∞ÊíûÊ™¢Ê∏¨
                this.onGround = false;
                for (let p of platforms) {
                    const overlapX = this.x + this.width > p.x && this.x < p.x + p.width;
                    if (overlapX && this.y + this.height <= p.y && newY + this.height >= p.y) {
                        newY = p.y - this.height;
                        this.vy = 0;
                        this.onGround = true;
                    }
                }
                
                // Êõ¥Êñ∞‰ΩçÁΩÆ
                this.y = newY;
                
                // ÈÇäÁïåÈôêÂà∂
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                
                // ÊéâËêΩÊ≠ª‰∫°
                if (this.y >= WORLD_HEIGHT) {
                    gameOver();
                    return;
                }
                
                // ÁÑ°ÊïµÊôÇÈñìÊõ¥Êñ∞
                if (this.invincible > 0) {
                    this.invincible--;
                }
                // Ë∑≥Ë∫çÂ¢ûÂäõÔºàÂèØËÆäÈ´òÂ∫¶Ôºâ
                if (isJumping && !this.onGround && this.vy < 0 && jumpHoldFrames < JUMP_EXTRA_FRAMES) {
                    this.vy += JUMP_EXTRA;
                    jumpHoldFrames++;
                } else if (jumpHoldFrames >= JUMP_EXTRA_FRAMES) {
                    isJumping = false;
                }
                // ÈôêÂà∂ÊúÄÈ´ò‰∏äÂçá250ÂÉèÁ¥†
                if (isJumping && jumpStartY - this.y >= 250) {
                    isJumping = false;
                    if (this.vy < 0) this.vy = 0; // Á´ãÂç≥ÂÅúÊ≠¢‰∏äÂçá
                }
            },
            
            // Áé©ÂÆ∂Â∞ÑÊìä
            shoot: function() {
                if (!canShoot) return;
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                    return;
                }
                // Â¶ÇÊûúÈõÜÊ∞£ÂΩàÂç≥Â∞áÁôºÂ∞ÑÔºå‰∏çÁôºÂ∞ÑÊôÆÈÄöÂ≠êÂΩà
                if (chargeReady) return;
                // ÈõÜÊ∞£ÁãÄÊÖã‰∏ãÔºåÂè™ÊúâÈõÜÊ∞£Ë∂ÖÈÅé0.7ÁßíÊâç‰∏çÁôºÂ∞ÑÊôÆÈÄöÂ≠êÂΩà
                if (charging && chargeFrame >= CHARGE_CANCEL_FRAME) return;
                if (this.isShooting && this.shootCooldown === 0) {
                    bullets.push({
                        x: this.x + (this.direction === 1 ? this.width : -10),
                        y: this.y + this.height / 2 - 3,
                        width: 10,
                        height: 6,
                        speed: 10 * this.direction,
                        color: '#b3f0ff',
                        isCharge: false
                    });
                    this.shootCooldown = this.shootDelay;
                }
            },
            
            // ÂèóÂÇ∑ËôïÁêÜ
            takeDamage: function(amount) {
                if (this.invincible > 0) return;
                // Êí≠ÊîæÂèóÂÇ∑Èü≥Êïà
                const hurtAudio = document.getElementById('hurt-audio');
                if (hurtAudio) {
                    hurtAudio.currentTime = 0;
                    hurtAudio.volume = VOLUME_HURT;
                    hurtAudio.play();
                }
                playerHealth -= amount;
                updateHealthBar();
                this.invincible = 30; // 30ÂπÄÁÑ°ÊïµÊôÇÈñì
                if (playerHealth <= 0) {
                    gameOver();
                }
            }
        };
        
        // ===== Â≠êÂΩàÁ≥ªÁµ± =====
        const bullets = [];
        const enemyBullets = [];
        
        // ===== Êïµ‰∫∫È°ûÂûã =====
        const ENEMY_TYPES = {
            // È£õË°åÁ≥ªÂàóÔºàÂúìÂΩ¢Ôºâ
            FLY_RED: {
                color: '#f44',
                speed: 1.5,
                health: 1,
                score: 60,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                    // Â∞èÂπÖÂ∫¶‰∏ä‰∏ã
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 600 + enemy._id) * 18;
                },
                isFlying: true,
                eye: { color: '#222', type: 'circle' }
            },
            FLY_ORANGE: {
                color: '#f84',
                speed: 2.25, // ÊØîÁ¥ÖËâ≤Âø´0.5ÂÄç
                health: 1,
                score: 80,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                    // Â§ßÂπÖÂ∫¶‰∏ä‰∏ã
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 300 + enemy._id) * 48;
                },
                isFlying: true,
                eye: { color: '#222', type: 'circle' }
            },
            // Âú∞‰∏äÁ≥ªÂàóÔºàÂçäÂúìÂΩ¢Ôºâ
            GROUND_RED: {
                color: '#f44',
                speed: 0.75, // ÂéüÊú¨1.5ÔºåÁèæÂú®ÊÖ¢‰∏ÄÂÄç
                health: 1,
                score: 50,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                },
                isFlying: false,
                eye: { color: '#222', type: 'semi' }
            },
            GROUND_ORANGE: {
                color: '#f84',
                speed: 0.75, // ÂéüÊú¨1.5ÔºåÁèæÂú®ÊÖ¢‰∏ÄÂÄç
                health: 1,
                score: 70,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                    if (enemy.onGround && Math.random() < 0.02) {
                        enemy.vy = -12;
                        enemy.onGround = false;
                    }
                },
                isFlying: false,
                eye: { color: '#222', type: 'semi' }
            },
            GROUND_PINK: {
                color: '#f8c',
                speed: 0,
                health: 1,
                score: 100,
                shootDelay: 180, // Â∞ÑÊìäÈ†ªÁéáÊ∏õÂçäÔºàÂéüÊú¨90Ôºâ
                behavior: function(enemy) {
                    // Âõ∫ÂÆöÈªûÂ∞ÑÊìä
                    if (enemy.shootCooldown > 0) {
                        enemy.shootCooldown--;
                    } else {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (enemy.y + enemy.height/2),
                            player.x + player.width/2 - (enemy.x + enemy.width/2)
                        );
                        // Â∞ÑÊìäÊ¨°Êï∏Ê∏õÂçäÔºåÂéüÊú¨1ÁôºÔºåÁèæÂú®ÊØè2Ê¨°ÊâçÂ∞Ñ1Áôº
                        if (!enemy._shootToggle) enemy._shootToggle = false;
                        enemy._shootToggle = !enemy._shootToggle;
                        if (enemy._shootToggle) {
                            enemyBullets.push({
                                x: enemy.x + enemy.width/2 - 3,
                                y: enemy.y + enemy.height/2 - 3,
                                width: 6,
                                height: 6,
                                speedX: Math.cos(angle) * 1.3,
                                speedY: Math.sin(angle) * 1.3,
                                color: '#f8c'
                            });
                        }
                        enemy.shootCooldown = enemy.shootDelay;
                    }
                },
                isFlying: false,
                eye: { color: '#fff', type: 'semi' }
            }
        };
        
        // ===== Êïµ‰∫∫Èô£Âàó =====
        const enemies = [];
        // ===== Êïµ‰∫∫ÈñÉÁàçÁãÄÊÖã =====
        const enemyHitFlash = new WeakMap(); // Map<enemy, frame>
        
        // ===== Boss Áâ©‰ª∂ =====
        const boss = {
            x: 2500 + 2700 * 1,
            y: 350, // Âõ∫ÂÆöÂàùÂßãÂ∫ßÊ®ô
            width: 100,
            height: 100,
            speed: 2,
            vy: 0, // ‰∏çÂÜçÈúÄË¶ÅÈáçÂäõ
            color: '#2196f3', // ‰∏ªÈ´îËóçËâ≤ÔºàAirman‰∏ªËâ≤Ôºâ
            shootCooldown: 0,
            shootDelay: 200, // ‚Üê ÈÄôË£°Â∞±ÊòØÁôºÂ∞ÑÈñìÈöîÔºåÊï∏Â≠óË∂äÂ∞èË∂äÈ†ªÁπÅ
            pattern: 0,
            patternTimer: 0,
            health: 300,
            maxHealth: 300,
            onGround: false, // ‰∏çÂÜçÈúÄË¶ÅonGround
            pauseTimer: 0, // Êñ∞Â¢ûÔºöÊö´ÂÅúË®àÊôÇÂô®
            
            // Boss Ë°åÁÇ∫Ê®°Âºè
            update: function() {
                // Êñ∞Â¢ûÔºöÊö´ÂÅúÁãÄÊÖã
                if (this.pauseTimer > 0) {
                    this.pauseTimer--;
                    return;
                }
                // Ê®°ÂºèË®àÊôÇÂô®
                this.patternTimer++;
                if (this.patternTimer > 180) {
                    this.pattern = (this.pattern + 1) % 4;
                    this.patternTimer = 0;
                }
                if (!bossCanMove) return; // 0.7ÁßíÂÖß‰∏çËÉΩÁßªÂãï
                // ‰∏çÂèóÈáçÂäõÂΩ±ÈüøÔºåÁõ¥Êé•Ê†πÊìöË°åÁÇ∫Ê®°ÂºèË™øÊï¥yÂ∫ßÊ®ô
                switch (this.pattern) {
                    case 0: // ‰∏ä‰∏ãÁßªÂãï
                        this.y += this.speed;
                        if (this.y < 50 || this.y > WORLD_HEIGHT - this.height - 50) {
                            this.speed *= -1;
                        }
                        break;
                    case 1: // ËøΩËπ§Áé©ÂÆ∂
                        if (this.y < player.y) {
                            this.y += this.speed;
                        } else if (this.y > player.y) {
                            this.y -= this.speed;
                        }
                        break;
                    case 2: // Ë∑≥Ë∫çÊîªÊìäÔºàÊîπÁÇ∫Âø´ÈÄü‰∏ä‰∏ãÁßªÂãïÔºâ
                        if (this.patternTimer % 60 < 30) {
                            this.y -= 8; // Âêë‰∏äÈ£Ñ
                        } else {
                            this.y += 8; // Âêë‰∏ãÈ£Ñ
                        }
                        // ÈôêÂà∂ÁØÑÂúç
                        this.y = Math.max(50, Math.min(WORLD_HEIGHT - this.height - 50, this.y));
                        break;
                    case 3: // Ë°ùÂà∫ÊîªÊìä
                        if (this.patternTimer < 60) {
                            this.x -= 5;
                        } else if (this.patternTimer < 120) {
                            this.x += 5;
                        }
                        break;
                }
                // Boss Â∞ÑÊìä
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                } else if (bossCanAttack) {
                    // ‰∏âÊñπÂêëÂ∞ÑÊìä
                    for (let i = -1; i <= 1; i++) {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (this.y + this.height/2),
                            player.x + player.width/2 - (this.x + this.width/2)
                        ) + (i * 0.3);
                        enemyBullets.push({
                            x: this.x + this.width/2 - 3.4125,
                            y: this.y + this.height/2 - 13.65,
                            width: 10,
                            height: 20,
                            speedX: Math.cos(angle) * 3,
                            speedY: Math.sin(angle) * 3,
                            color: '#f4a'
                        });
                    }
                    this.shootCooldown = this.shootDelay; // ‚Üê ÊØèÊ¨°ÁôºÂ∞ÑÂæåÈáçË®≠ÂÜ∑Âçª
                }
            }
        };
        
        // ===== Âπ≥Âè∞Èô£Âàó =====
        const platforms = basePlatforms.slice();
        
        // ===== ÊéßÂà∂Á≥ªÁµ± =====
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            ' ': false,
            'Enter': false
        };
        
        // ===== ‰∫ã‰ª∂Áõ£ËÅΩ =====
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        playAgainButton.addEventListener('click', startGame);
        
        // Ë∑≥Ë∫çÈçµÊåâ‰∏ãÊôÇÈñìË®òÈåÑ
        let jumpKeyDownTime = 0;
        let jumpKeyPressed = false;
        let isJumping = false;
        let jumpHoldFrames = 0;
        const jumpMaxHoldTime = 300; // ÊúÄÈï∑0.3Áßí
        let jumpStartY = 0; // Ëµ∑Ë∑≥ÊôÇyÂ∫ßÊ®ô
        
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
                if (e.key === 'ArrowUp' && !jumpKeyPressed) {
                    jumpKeyDownTime = Date.now();
                    jumpKeyPressed = true;
                }
                if (e.key === 'Enter' && !gameRunning) {
                    startGame();
                }
                if (e.key === ' ' && gameRunning) {
                    // Êåâ‰∏ãÁ©∫ÁôΩÈçµÔºåÁ´ãÂç≥ÂïüÂãïÊôÆÈÄöÂ∞ÑÊìä
                    if (!charging) {
                        charging = true;
                        chargeFrame = 0;
                        chargeReady = false;
                        player.isShooting = true;
                        // Êí≠ÊîæÂ∞ÑÊìäÈü≥Êïà
                        const shootAudio = document.getElementById('shoot-audio');
                        if (shootAudio) {
                            shootAudio.currentTime = 0;
                            shootAudio.volume = VOLUME_SHOOT;
                            shootAudio.play();
                        }
                        // Âª∂ÈÅ≤0.5ÁßíÂæåÊâçÊí≠ÊîæÈõÜÊ∞£Èü≥Êïà
                        if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                        chargeAudioTimeout = setTimeout(() => {
                            if (charging) {
                                const chargeAudio = document.getElementById('charge-audio');
                                if (chargeAudio) {
                                    chargeAudio.currentTime = 0;
                                    chargeAudio.volume = VOLUME_CHARGE;
                                    chargeAudio.play();
                                }
                            }
                        }, 500);
                    }
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
                if (e.key === 'ArrowUp' && jumpKeyPressed) {
                    const pressDuration = Date.now() - jumpKeyDownTime;
                    if (pressDuration < 200 && player.vy < 0) {
                        // 0.2Áßí‰ª•‰∏ãÔºå1/4È´òÂ∫¶
                        player.vy /= 4;
                    } else if (pressDuration < 300 && player.vy < 0) {
                        // 0.2~0.3ÁßíÔºå1/3È´òÂ∫¶
                        player.vy /= 3;
                    } else if (pressDuration < 400 && player.vy < 0) {
                        // 0.3~0.4ÁßíÔºå‰∏ÄÂçäÈ´òÂ∫¶
                        player.vy /= 2;
                    }
                    // Ë∂ÖÈÅé0.4ÁßíÔºåÁ∂≠ÊåÅÂéüÊú¨ÊúÄÈ´òÈ´òÂ∫¶
                    jumpKeyPressed = false;
                }
                if (e.key === ' ') {
                    // ÊîæÈñãÁ©∫ÁôΩÈçµÊôÇÔºåÊ†πÊìöÈõÜÊ∞£ÊôÇÈñìÊ±∫ÂÆöÁôºÂ∞Ñ‰ªÄÈ∫º
                    if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                        chargeReady = true; // ÁôºÂ∞ÑÈõÜÊ∞£ÂΩà
                    } else if (charging && chargeFrame < CHARGE_CANCEL_FRAME && !chargeReady) {
                        // Âè™Êúâ chargeReady ÁÇ∫ false ÊâçË£úÁôºÊôÆÈÄöÂΩà
                        player.isShooting = true;
                    }
                    charging = false;
                    setTimeout(() => { player.isShooting = false; }, 0); // ‰∏ã‰∏ÄÂπÄÈóúÈñâÊôÆÈÄöÂ∞ÑÊìä
                    // ÂÅúÊ≠¢ÈõÜÊ∞£Èü≥Êïà
                    if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                    const chargeAudio = document.getElementById('charge-audio');
                    if (chargeAudio) {
                        chargeAudio.pause();
                        chargeAudio.currentTime = 0;
                        chargeAudio.volume = VOLUME_CHARGE;
                    }
                }
            }
        });
        
        // ===== ÈÅäÊà≤ÂàùÂßãÂåñ =====
        const bgm = document.getElementById('bgm');
        function startGame() {
            // ÂÅúÊ≠¢outroÈü≥Ê®Ç
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.pause();
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                outroAudio.onended = null;
            }
            // Èü≥Ê®ÇÊí≠ÊîæÊéßÂà∂
            if (bgm) {
                bgm.currentTime = 0;
                bgm.volume = VOLUME_BGM;
                bgm.play();
            }
            // ÈáçÁΩÆÈÅäÊà≤ÁãÄÊÖã
            gameRunning = true;
            score = 0;
            playerHealth = playerMaxHealth;
            boss.health = boss.maxHealth;
            boss.x = 2500 + 2700 * 1;
            boss.y = 350;
            bossActive = false;
            reachedBossArea = false;
            
            // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆ
            player.x = 100;
            player.y = platforms[0].y - player.height;
            player.vy = 0;
            player.onGround = true;
            player.direction = 1;
            player.invincible = 0;
            
            // Ê∏ÖÁ©∫Èô£Âàó
            bullets.length = 0;
            enemyBullets.length = 0;
            enemies.length = 0;
            
            // Èö±Ëóè‰ªãÈù¢ÂÖÉÁ¥†
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            bossHealthContainer.style.display = 'none';
            
            // Êõ¥Êñ∞UI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // ÂïüÂãïÈÅäÊà≤Âæ™Áí∞
            requestAnimationFrame(gameLoop);
            langToggle.style.display = 'none';
            langSelect.style.display = 'none';
            canShoot = false;
            charging = false;
            player.isShooting = false;
            chargeFrame = 0;
            chargeReady = false;
            if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
            setTimeout(() => { canShoot = true; }, 200);
        }
        
        // ===== ÈÅäÊà≤‰∏ªÂæ™Áí∞ =====
        function gameLoop() {
            if (!gameRunning) return;
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // ===== ÈÅäÊà≤ÁãÄÊÖãÊõ¥Êñ∞ =====
        function update() {
            // ÈõÜÊ∞£ÁãÄÊÖãË®àÊï∏
            if (charging) {
                chargeFrame++;
            }
            // ÂÖàËôïÁêÜÈõÜÊ∞£ÂΩà
            if (chargeReady) {
                // ÁôºÂ∞ÑÈõÜÊ∞£ÂΩà
                bullets.push({
                    x: player.x + (player.direction === 1 ? player.width : -40),
                    y: player.y + player.height / 2 - 12,
                    width: 40,
                    height: 24,
                    speed: 10 * player.direction,
                    color: '#ff0',
                    isCharge: true // Ê®ôË®òÁÇ∫ÈõÜÊ∞£ÂΩà
                });
                player.shootCooldown = player.shootDelay; // Áµ¶‰∏ÄÈªûÂÜ∑Âçª
                // Êí≠ÊîæshootÈü≥Êïà
                const shootAudio = document.getElementById('shoot-audio');
                if (shootAudio) {
                    shootAudio.currentTime = 0;
                    shootAudio.volume = VOLUME_SHOOT;
                    shootAudio.play();
                }
                chargeReady = false;
            }
            // Êõ¥Êñ∞Áé©ÂÆ∂
            player.update();
            player.shoot();
            
            // Áõ£ÊéßÁé©ÂÆ∂‰ΩçÁΩÆ - ÂÉÖÂú®Êìç‰ΩúÊñπÂêëÈçµÊôÇËº∏Âá∫
            if (keys.ArrowLeft || keys.ArrowRight || keys.ArrowUp) {
                // console.log('Áé©ÂÆ∂‰ΩçÁΩÆ:', { x: player.x, y: player.y, onGround: player.onGround });
            }
            
            // Êõ¥Êñ∞Èè°È†≠
            camera.follow(player);
            
            // BossÂçÄÂüüÊïàÊûú
            if (player.x >= BOSS_AREA_X && !bossActive && bossTimer === 0) {
                // ÂÖà‰∏çÈ°ØÁ§∫Ê≠£ÂºèbossË°ÄÊ¢ù
                bossHealthContainer.style.display = 'none';
                // ÂÖàÁßªÈô§ÊâÄÊúâËàäÁöÑ fake hp Ê¢ù
                let oldFakeBar = document.getElementById('boss-fake-bar');
                if (oldFakeBar) oldFakeBar.remove();
                // Êñ∞ fake hp Ê¢ùÂãïÁï´
                let fakeBar = document.createElement('div');
                fakeBar.style.position = 'absolute';
                fakeBar.style.top = '10px';
                fakeBar.style.right = '10px';
                fakeBar.style.width = '200px';
                fakeBar.style.height = '20px';
                fakeBar.style.background = '#333';
                fakeBar.style.border = '2px solid #444';
                fakeBar.style.zIndex = 5;
                fakeBar.id = 'boss-fake-bar';
                let fakeFill = document.createElement('div');
                fakeFill.style.height = '100%';
                fakeFill.style.width = '1%';
                fakeFill.style.background = '#ccc';
                fakeFill.style.transition = 'none';
                fakeBar.appendChild(fakeFill);
                document.getElementById('game-container').appendChild(fakeBar);
                let animPercent = 1;
                const animStep = (100 - 1) / (1500 / 16); // 1.5Áßí 1%~100%
                const anim = setInterval(() => {
                    animPercent += animStep;
                    if (animPercent >= 100) {
                        animPercent = 100;
                        clearInterval(anim);
                        // ÁßªÈô§ fake hp Ê¢ùÔºåÈ°ØÁ§∫Ê≠£Âºè boss hp Ê¢ù
                        let oldFakeBar2 = document.getElementById('boss-fake-bar');
                        if (oldFakeBar2) oldFakeBar2.remove();
                        bossHealthContainer.style.display = 'block';
                        updateBossHealthBar();
                    }
                    fakeFill.style.width = animPercent + '%';
                }, 16);
                bossTimer = 1;
                enemies.length = 0;
                enemyBullets.length = 0;
            }
            
            // Ë®àÊôÇÂô®ÈÅãË°åÔºå3 ÁßíÂæåÊøÄÊ¥ª BOSS
            if (bossTimer > 0 && bossTimer < 250) {
                bossTimer++;
                if (bossTimer === 200) {
                    // Êí≠ÊîæbossÂá∫Â†¥Èü≥Êïà
                    const bossAudio = document.getElementById('boss-audio');
                    if (bossAudio) {
                        bossAudio.currentTime = 0;
                        bossAudio.volume = VOLUME_BOSS;
                        bossAudio.play();
                    }
                    // Âª∂ÈÅ≤0.4ÁßíÂæåÊâçËÆìbossÂá∫Áèæ
                    setTimeout(() => {
                        bossActive = true;
                        bossTimer = 0;
                        bossCanAttack = false;
                        bossCanMove = false;
                        setTimeout(() => {
                            bossCanAttack = true;
                            bossCanMove = true;
                        }, 700);
                    }, 400);
                }
            }
            
            // ÁîüÊàêÊïµ‰∫∫
            if (Math.random() < 0.015 && enemies.length < 8 && !bossActive && player.x < WORLD_WIDTH - 1000) {
                // Âè™ÂæûÊñ∞ÂÖ≠Á®ÆÂ∞èÊÄ™Èö®Ê©üÈÅ∏‰∏ÄÁ®Æ
                const enemyTypes = Object.values(ENEMY_TYPES);
                let type;
                let tryCount = 0;
                do {
                    type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    // Â¶ÇÊûúÊòØÁ≤âÁ¥ÖËâ≤Âú∞Èù¢ÊÄ™ÔºåÂè™ÊúâÁé©ÂÆ∂ÂæÄÂè≥ÊôÇÊâçÂÖÅË®±ÁîüÊàê
                    if (type === ENEMY_TYPES.GROUND_PINK && !keys.ArrowRight) {
                        tryCount++;
                        continue;
                    }
                    break;
                } while (tryCount < 10);
                // Áµ¶ÊØèÈöªÊïµ‰∫∫‰∏ÄÂÄãÂîØ‰∏Ä id ‰æõÈ£ÑÊµÆÁî®
                const enemy = {
                    x: camera.x + camera.width + 50,
                    y: type.isFlying ? (Math.random() * (WORLD_HEIGHT - 200) + 50) : (Math.random() * (WORLD_HEIGHT - 100) + 50),
                    width: 30,
                    height: 30,
                    speed: type.speed,
                    health: type.health,
                    score: type.score,
                    color: type.color,
                    behavior: type.behavior,
                    onGround: false,
                    vy: 0,
                    shootCooldown: 0,
                    shootDelay: type.shootDelay || 0,
                    isFlying: type.isFlying,
                    eye: type.eye,
                    _id: Math.random() * 1000000 | 0 // È£ÑÊµÆÁî®
                };
                enemies.push(enemy);
            }
            
            // Êõ¥Êñ∞Êïµ‰∫∫
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (enemy.isFloating) {
                    // È£ÑÊµÆÂ∞èÂÖµÔºö‰∏ä‰∏ãÈ£ÑÂãïÔºå‰∏çÂèóÈáçÂäõËàáÂπ≥Âè∞ÂΩ±Èüø
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 400 + i) * 40;
                    enemy.x -= enemy.speed;
                } else {
                    // ÂéüÊú¨Âú∞Èù¢Â∞èÂÖµ
                    enemy.vy += GRAVITY;
                    let newY = enemy.y + enemy.vy;
                    enemy.onGround = false;
                    for (let p of platforms) {
                        const overlapX = enemy.x + enemy.width > p.x && enemy.x < p.x + p.width;
                        if (overlapX && enemy.y + enemy.height <= p.y && newY + enemy.height >= p.y) {
                            newY = p.y - enemy.height;
                            enemy.vy = 0;
                            enemy.onGround = true;
                        }
                    }
                    enemy.y = newY;
                    enemy.behavior(enemy);
                }
                // Êõ¥Êñ∞Êïµ‰∫∫ÈñÉÁàçÁãÄÊÖã
                if (enemyHitFlash.has(enemy)) {
                    let frame = enemyHitFlash.get(enemy);
                    frame--;
                    if (frame <= 0) {
                        enemyHitFlash.delete(enemy);
                    } else {
                        enemyHitFlash.set(enemy, frame);
                    }
                }
                // ÁßªÈô§Â±èÂπïÂ§ñÁöÑÊïµ‰∫∫
                if (enemy.x < camera.x - 100 || enemy.x > camera.x + camera.width + 100) {
                    enemies.splice(i, 1);
                    continue;
                }
                // Ê™¢Ê∏¨Áé©ÂÆ∂Á¢∞Êíû
                if (checkCollision(player, enemy)) {
                    player.takeDamage(10);
                    enemies.splice(i, 1);
                    continue;
                }
            }
            
            // Êõ¥Êñ∞Boss
            if (bossActive) {
                boss.update();
                
                // Ê™¢Ê∏¨Áé©ÂÆ∂Á¢∞Êíû
                if (checkCollision(player, boss)) {
                    player.takeDamage(15);
                }
            }
            
            // Êõ¥Êñ∞Â≠êÂΩà
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.speed;
                
                // ÁßªÈô§Â±èÂπïÂ§ñÁöÑÂ≠êÂΩà
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // Ê™¢Ê∏¨Êïµ‰∫∫Á¢∞Êíû
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        if (bullet.isCharge) {
                            enemy.health -= 5; // ÈõÜÊ∞£ÂΩàÊîªÊìäÂäõ5ÂÄç
                        } else {
                            enemy.health--;
                        }
                        enemyHitFlash.set(enemy, 12); // 0.2ÁßíÈñÉÁàç
                        // Êí≠ÊîæboomÈü≥ÊïàÔºàÈõÜÊ∞£ÂΩà‰πüÊúâÔºâ
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            boomAudio.currentTime = 0;
                            boomAudio.volume = VOLUME_BOOM;
                            boomAudio.play();
                        }
                        if (enemy.health <= 0) {
                            enemy.health = 0;
                            enemies.splice(j, 1);
                            score += enemy.score;
                            updateScore();
                        }
                        bullets.splice(i, 1);
                        break;
                    }
                }
                
                // Ê™¢Ê∏¨BossÁ¢∞Êíû
                if (bossActive && checkCollision(bullet, boss)) {
                    if (bullet.isCharge) {
                        boss.health -= 15; // ÈõÜÊ∞£ÂΩàÊîªÊìäÂäõ5ÂÄç
                        boss.pauseTimer = 42; // Êñ∞Â¢ûÔºöÊö´ÂÅú0.7Áßí
                    } else {
                        boss.health -= 5;
                    }
                    bossHitFlash = 12; // 0.2ÁßíÈñÉÁàç
                    updateBossHealthBar();
                    if (boss.health > 0) {
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            boomAudio.currentTime = 0;
                            boomAudio.volume = VOLUME_BOOM;
                            boomAudio.play();
                        }
                    }
                    bullets.splice(i, 1);
                    score += bullet.isCharge ? 100 : 20;
                    updateScore();
                    if (boss.health <= 0) {
                        boss.health = 0;
                        updateBossHealthBar();
                        bossActive = false;
                        gameRunning = false;
                        // ÂÅúÊ≠¢BGM
                        if (bgm) {
                            bgm.pause();
                            bgm.currentTime = 0;
                        }
                        // Êí≠ÊîæbossdieÈü≥Êïà
                        const bossdieAudio = document.getElementById('bossdie-audio');
                        if (bossdieAudio) {
                            bossdieAudio.currentTime = 0;
                            bossdieAudio.volume = VOLUME_BOSSDIE;
                            bossdieAudio.play();
                        }
                        // 1. ÈªÉÁôΩÈñÉÁàç2Áßí
                        const flashDiv = document.getElementById('flash-effect');
                        const winScreen = document.getElementById('win-screen');
                        if (flashDiv) {
                            flashDiv.style.display = 'block';
                            let flashFrame = 0;
                            flashDiv.style.opacity = 1;
                            const flashInterval = setInterval(() => {
                                flashDiv.style.background = (flashFrame % 2 === 0) ? 'rgba(255,255,0,0.7)' : 'rgba(255,255,255,0.7)';
                                flashFrame++;
                            }, 100);
                            setTimeout(() => {
                                clearInterval(flashInterval);
                                // 2. 3ÁßíÊº∏Â±§ËÆäÂÖ®ÁôΩ
                                let opacity = 0.7;
                                flashDiv.style.background = '#fff';
                                const fadeInStep = 0.0067; // 0.0067*20ms*150Ê¨° ‚âà 1
                                const fadeIn = setInterval(() => {
                                    opacity += fadeInStep;
                                    flashDiv.style.opacity = opacity;
                                    if (opacity >= 1) {
                                        clearInterval(fadeIn);
                                        // 3. ÂÖ®ÁôΩÊôÇÊí≠Êîæoutro‰∏¶È°ØÁ§∫ÂãùÂà©Áï´Èù¢ÔºåÂãùÂà©Áï´Èù¢opacity=0
                                        winGame();
                                        winScreen.style.opacity = 0;
                                        // Êí≠ÊîæoutroÈü≥Ê®Ç
                                        const outroAudio = document.getElementById('outro-audio');
                                        if (outroAudio) {
                                            outroAudio.currentTime = 0;
                                            outroAudio.volume = VOLUME_OUTRO;
                                            outroAudio.play();
                                        }
                                        // 4. 2ÁßíÂÖßÁôΩËâ≤ÈÅÆÁΩ©Ê∑°Âá∫„ÄÅÂãùÂà©Áï´Èù¢ÂêåÊ≠•Ê∑°ÂÖ•
                                        let outOpacity = 1;
                                        let winOpacity = 0;
                                        const fadeOut = setInterval(() => {
                                            outOpacity -= 0.02;
                                            winOpacity += 0.02;
                                            flashDiv.style.opacity = outOpacity;
                                            winScreen.style.opacity = winOpacity;
                                            if (outOpacity <= 0) {
                                                clearInterval(fadeOut);
                                                flashDiv.style.display = 'none';
                                                winScreen.style.opacity = 1;
                                            }
                                        }, 20);
                                    }
                                }, 20);
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                winGame();
                            }, 3000);
                        }
                    }
                }
            }
            
            // Êõ¥Êñ∞ÊïµÊñπÂ≠êÂΩà
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                bullet.x += bullet.speedX;
                bullet.y += bullet.speedY;
                
                // ÁßªÈô§Â±èÂπïÂ§ñÁöÑÂ≠êÂΩà
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50 ||
                    bullet.y < camera.y - 50 || bullet.y > camera.y + camera.height + 50) {
                    enemyBullets.splice(i, 1);
                    continue;
                }
                
                // Ê™¢Ê∏¨Áé©ÂÆ∂Á¢∞Êíû
                if (checkCollision(bullet, player)) {
                    player.takeDamage(5);
                    enemyBullets.splice(i, 1);
                }
            }
            
            // Âú®update()ÊúÄÂæåÂä†‰∏äbossHitFlashÈÅûÊ∏õ
            if (bossHitFlash > 0) bossHitFlash--;
        }
        
        // ===== Ê∏≤ÊüìÈÅäÊà≤ =====
        function render() {
            // Ê∏ÖÈô§Áï´Â∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ‰øùÂ≠òÁï∂ÂâçÁãÄÊÖã
            ctx.save();
            
            // ÊáâÁî®Èè°È†≠ËÆäÊèõ
            ctx.translate(-camera.x, -camera.y);
            
            // Áπ™Ë£ΩËÉåÊôØ (Á∞°ÂñÆÁöÑÊòüÁ©∫ÊïàÊûú)
            ctx.fillStyle = '#112';
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
            
            // Áπ™Ë£ΩÊòüÊòü
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 24 + (camera.x / 2)) % WORLD_WIDTH;
                const y = (i * 19 + (camera.y / 2)) % WORLD_HEIGHT;
                const size = 1 + (i % 3);
                ctx.fillRect(x, y, size, size);
            }
            
            // Áπ™Ë£ΩÂπ≥Âè∞
            platforms.forEach(platform => {
                // x>4500 ÊîπÊàêÊöóÁ¥ÖËâ≤
                if (platform.x > 4500) {
                    ctx.fillStyle = '#800';
                } else {
                    ctx.fillStyle = platform.color;
                }
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });
            
            // Áπ™Ë£ΩÁé©ÂÆ∂ (ÁÑ°ÊïµÊôÇÈñÉÁàç)
            // ÈõÜÊ∞£ÊôÇÈñÉÁàçÔºàÂè™ÊúâÈõÜÊ∞£Ë∂ÖÈÅé0.7ÁßíÊâçÈñÉÁàçÔºâ
            if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                if (Math.floor(Date.now() / 100) % 2 === 0) {
                    ctx.fillStyle = '#cfbb3a'; // Ê∑∫ÈªÉËâ≤
                } else {
                    ctx.fillStyle = player.color;
                }
            } else {
                ctx.fillStyle = player.color;
            }
            if (player.invincible <= 0 || Math.floor(player.invincible / 5) % 2 === 0) {
                ctx.fillRect(player.x, player.y, player.width, player.height);
                // Âè™Áï´Â§ßÁúºÁôΩÔºå‰∏çÁï´ÁúºÁè†
                ctx.beginPath();
                if (player.direction === 1) {
                    ctx.ellipse(player.x + player.width - 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                } else {
                    ctx.ellipse(player.x + 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                }
                ctx.fillStyle = '#fff';
                ctx.fill();
            }
            ctx.globalAlpha = 1;
            
            // Áπ™Ë£ΩÂ≠êÂΩà
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                if (bullet.isCharge) {
                    ctx.save();
                    ctx.shadowColor = '#ff0';
                    ctx.shadowBlur = 20;
                    // ÈõÜÊ∞£ÂΩàÔºö‰∏ä‰∏ãÁ™ÑÁöÑÊ©¢Âúì
                    ctx.beginPath();
                    ctx.ellipse(
                        bullet.x + bullet.width / 2,
                        bullet.y + bullet.height / 2,
                        bullet.width / 2,
                        bullet.height / 1.5,
                        0, 0, Math.PI * 2
                    );
                    ctx.fill();
                    ctx.restore();
                } else {
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // Áπ™Ë£ΩÊïµ‰∫∫
            enemies.forEach(enemy => {
                // ÈñÉÁàçÊïàÊûú
                if (enemyHitFlash.has(enemy)) {
                    if (Math.floor(Date.now() / 50) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
                if (enemy.isFlying) {
                    // È£õË°åÊïµ‰∫∫ÔºöÂúìÂΩ¢
                    ctx.save();
                    ctx.beginPath();
                    ctx.ellipse(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, enemy.height/2, 0, 0, Math.PI*2);
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // ÁúºÁùõÔºàÊ©¢ÂúìÂè≥ÂâçÊñπÔºâ
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.75, enemy.y + enemy.height/2, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                } else {
                    // Ë∑ØÈù¢Êïµ‰∫∫ÔºöÂçäÂúìÔºàÊúùÂè≥Ôºâ
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height, enemy.width/2, Math.PI, 0, false);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x, enemy.y + enemy.height);
                    ctx.closePath();
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // ÁúºÁùõÔºàÂ∑¶ÂâçÊñπÔºâ
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.25, enemy.y + enemy.height*0.75, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                }
                ctx.globalAlpha = 1;
            });
            
            // Áπ™Ë£ΩBoss
            if (bossActive) {
                if (bossHitFlash > 0) {
                    if (Math.floor(Date.now() / 50) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
                // ‰∏ªÈ´îÔºöÂúìËßíÁü©ÂΩ¢
                const r = 28; // ÂúìËßíÂçäÂæë
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y);
                ctx.lineTo(boss.x + boss.width - r, boss.y);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y, boss.x + boss.width, boss.y + r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + r);
                ctx.quadraticCurveTo(boss.x, boss.y, boss.x + r, boss.y);
                ctx.closePath();
                ctx.fillStyle = boss.color;
                ctx.fill();
                // Â∫ï‰∏ã1/5ÁÇ∫Êõ¥ÈÆÆÊòéÁöÑÈªÉËâ≤
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y + boss.height * 0.8);
                ctx.lineTo(boss.x + boss.width - r, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height * 0.8, boss.x + boss.width, boss.y + boss.height - r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height * 0.8, boss.x + r, boss.y + boss.height * 0.8);
                ctx.closePath();
                ctx.fillStyle = '#ffd600'; // Êõ¥ÈÆÆÊòéÁöÑÈªÉËâ≤
                ctx.fill();
                ctx.restore();
                // ÁúºÁùõÔºà‰∏äÊñπÂÖ©ÂÄãÔºåÁôΩËâ≤ÁúºÁôΩ„ÄÅÁ¥ÖËâ≤ÁúºÁè†Ôºâ
                // Â∑¶Áúº
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // Âè≥Áúº
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // È¢®ÊâáÔºàÈªÉËâ≤ÂúìÂΩ¢Ôºâ
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 20, 0, Math.PI*2);
                ctx.fillStyle = '#ffe082'; // ÈªÉËâ≤
                ctx.fill();
                // È¢®Êâá‰∏≠ÂøÉ
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 7, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.restore();
                ctx.globalAlpha = 1;
            }
            
            // Áπ™Ë£ΩÊïµÊñπÂ≠êÂΩà
            enemyBullets.forEach(bullet => {
                // BossÂ≠êÂΩàÔºàtornadoÔºâ
                if (bullet.color === '#f4a') {
                    const tornadoImg = document.getElementById('tornado-img');
                    if (tornadoImg && tornadoImg.complete) {
                        ctx.save();
                        // ÊóãËΩâÊñπÂêë
                        const angle = Math.atan2(bullet.speedY, bullet.speedX);
                        ctx.translate(bullet.x + 3.4125, bullet.y + 13.65); // 6.825x27.3‰∏≠ÂøÉ
                        ctx.rotate(angle + Math.PI);
                        ctx.drawImage(tornadoImg, -5, -5, 30, 30); //ÈæçÊç≤È¢®Â∞∫ÂØ∏
                        ctx.restore();
                    } else {
                        ctx.fillStyle = bullet.color;
                        ctx.fillRect(bullet.x, bullet.y, 10, 20);
                    }
                } else {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // ÊÅ¢Âæ©ÁãÄÊÖã
            ctx.restore();
            
            // Áπ™Ë£ΩUI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // Ë™øË©¶‰ø°ÊÅØ
            cameraDebugElement.textContent = `moved: (${Math.floor(camera.x)})`;
        }
        
        // ===== Â∑•ÂÖ∑ÂáΩÊï∏ =====
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }
        
        function updateHealthBar() {
            const percent = (playerHealth / playerMaxHealth) * 100;
            healthFill.style.width = `${percent}%`;
            if (percent <= 20) {
                healthFill.style.backgroundColor = '#f44'; // Á¥ÖËâ≤
            } else {
                healthFill.style.backgroundColor = '#4af'; // ËóçËâ≤
            }
        }
        
        function updateBossHealthBar() {
            if (window.bossHpAnimating) return;
            const percent = (boss.health / boss.maxHealth) * 100;
            bossHealthFill.style.width = `${percent}%`;
        }
        
        function updateScore() {
            scoreElement.textContent = `score: ${score}`;
        }
        
        function gameOver() {
            gameRunning = false;
            finalScoreElement.textContent = `score: ${score}`;
            gameOverScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // ÂÅúÊ≠¢BGM‰∏¶Êí≠ÊîæGame OverÈü≥Êïà
            if (bgm) {
                bgm.pause();
                bgm.currentTime = 0;
            }
            const gameOverAudio = document.getElementById('game-over-audio');
            if (gameOverAudio) {
                gameOverAudio.currentTime = 0;
                gameOverAudio.volume = VOLUME_GAMEOVER;
                gameOverAudio.play();
            }
        }
        
        function winGame() {
            gameRunning = false;
            if (currentLang === 'zh') {
                winScoreElement.innerHTML = '<div>score: ÂàÜÊï∏È´òÂà∞ÁÑ°Ê≥ïË®àÁÆó</div>';
            } else if (currentLang === 'ja') {
                winScoreElement.innerHTML = '<div>score: Âêõ„ÅÆ„Çπ„Ç≥„Ç¢„ÅØÈ´ò„Åô„Åé„Å¶Ë®àÁÆó„Åß„Åç„Å™„ÅÑ„ÄÇ</div>';
            } else {
                winScoreElement.innerHTML = '<div>score: Your score is incalculably high.</div>';
            }
            winScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // Êí≠ÊîæÂãùÂà©Èü≥Ê®Ç
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                outroAudio.play();
                // Á¢∫‰øùonended‰∫ã‰ª∂Ë®≠ÁΩÆ
                outroAudio.onended = function() {
                    setTimeout(() => {
                        outroAudio.currentTime = 0;
                        outroAudio.play();
                    }, 1000);
                };
            }
            winScoreElement.innerHTML = LANGUAGES[currentLang].winScore;
            playAgainButton.textContent = LANGUAGES[currentLang].playagain;
        }
        
        // ===== Ë™ûË®ÄË≥áÊñô =====
        const LANGUAGES = {
            zh: {
                title: 'Â•ßÂè§ÂçÉËê¨Â•ßÂè§ÂçÉËê¨',
                shoot: 'Á©∫ÁôΩÈçµ Â∞ÑÊìä',
                move: ' ‚Üê ‚Üí ÁßªÂãï',
                jump: ' ‚Üë Ë∑≥Ë∫ç',
                start: 'START',
                gameover: '‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ„Ç®„Ç¢„Éº„Åæ„Çì„Åå...',
                retry: 'ÂÜçtrytry',
                win: '<div>ÂëΩÈÅãË©¶ÂúñÈòªÊ≠¢‰Ω†...</div><div>‰ΩÜ‰Ω†Êà∞Âãù‰∫ÜÔºÅ</div><div>Ë´ãÁõ∏‰ø°Ëá™Â∑±ÔºÅ</div><div>‰∏çÁÆ°Â§öÂ§ßÂõ∞Èõ£ÔºÅ‰Ω†ÈÉΩËÉΩÂÖãÊúçÔºÅ</div>',
                winScore: '<div>SCORE: ÁÑ°‰∫∫ËÉΩÂÆöÁæ©‰Ω†ÁöÑÂàÜÊï∏ÔºåÈÇ£‰∫õÁúã‰∏çË¶ãÁöÑÂä™ÂäõÔºåÊâçÊòØ‰Ω†ÊúÄÁúüÂØ¶ÁöÑÂØ¶Âäõ!</div>',
                playagain: '‰Ω†ÊÉ≥ÂÜçÁé©‰∏ÄÊ¨°‰πüÊòØÂèØ‰ª•...'
            },
            ja: {
                title: 'ÂÑÑÂçÉ‰∏áÂÑÑÂçÉ‰∏á',
                shoot: '„Çπ„Éö„Éº„Çπ„Ç≠„Éº „Ç∑„Éß„ÉÉ„Éà',
                move: ' ‚Üê ‚Üí „Ç≠„Éº ÁßªÂãï',
                jump: '‚Üë „Ç≠„Éº „Ç∏„É£„É≥„Éó',
                start: '„Çπ„Çø„Éº„Éà',
                gameover: '‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ„Ç®„Ç¢„Éº„Åæ„Çì„Åå...',
                retry: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶',
                win: '<div>ÈÅãÂëΩ„ÅØÂêõ„ÇíÊ≠¢„ÇÅ„Åü„Åå„ÄÅ</div><div>Âêõ„ÅåÂãù„Å£„ÅüÔºÅ</div><div>Ëá™ÂàÜ„Çí‰ø°„Åò„Å¶ÔºÅ</div>„Å©„Çì„Å™Âõ∞Èõ£„Åß„ÇÇÂøÖ„Åö‰πó„ÇäË∂ä„Åà„Çâ„Çå„ÇãÔºÅ<div></div>',
                winScore: '<div>SCORE: Âêõ„ÅÆ‰æ°ÂÄ§„ÇíÁÇπÊï∞„ÅßÊ±∫„ÇÅ„Çâ„Çå„Çã„Çè„Åë„Åå„Å™„ÅÑÔºÅ</div>',
                playagain: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å≥„Åæ„Åô„ÅãÔºü'
            },
            en: {
                title: 'Mega AI',
                shoot: 'Press SPACE to Shoot',
                move: 'Press ‚Üê ‚Üí to Move',
                jump: 'Press ‚Üë to Jump',
                start: 'START',
                gameover: 'The Untouchable Airman',
                retry: 'Retry',
                win: '<div>Fate tried to stop you...</div><div>but you prevailed ÔºÅ</div><div>Believe in yourself ÔºÅ</div><div>And overcome any difficulty !</div>',
                winScore: '<div>SCORE: Scores are for tests. You‚Äôre not a test‚Äîyou‚Äôre a force.</div>',
                playagain: 'Play again?'
            }
        };
        let currentLang = localStorage.getItem('lang') || 'zh';
        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            const L = LANGUAGES[lang];
            document.querySelector('#start-screen h1').textContent = L.title;
            document.querySelectorAll('#start-screen p')[0].textContent = L.shoot;
            document.querySelectorAll('#start-screen p')[1].textContent = L.move;
            document.querySelectorAll('#start-screen p')[2].textContent = L.jump;
            startButton.textContent = L.start;
            document.querySelector('#game-over-screen h1').textContent = L.gameover;
            restartButton.textContent = L.retry;
            document.querySelector('#win-screen h1').innerHTML = L.win;
            winScoreElement.innerHTML = L.winScore;
            playAgainButton.textContent = L.playagain;
        }
        // ===== Ë™ûË®ÄÈÅ∏ÊìáUI =====
        const langSelect = document.getElementById('language-select');
        const langToggle = document.getElementById('lang-toggle');
        langToggle.onclick = () => {
            langSelect.style.display = (langSelect.style.display === 'flex') ? 'none' : 'flex';
        };
        document.getElementById('lang-zh').onclick = () => { setLang('zh'); langSelect.style.display = 'none'; };
        document.getElementById('lang-ja').onclick = () => { setLang('ja'); langSelect.style.display = 'none'; };
        document.getElementById('lang-en').onclick = () => { setLang('en'); langSelect.style.display = 'none'; };
        // È†êË®≠Ë™ûË®Ä
        window.addEventListener('DOMContentLoaded', () => {
            setLang(currentLang);
            langSelect.style.display = 'none';
            langToggle.style.display = 'block';
        });
    </script>
</body>
</html>