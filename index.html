<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…­æº€ å„„åƒä¸‡å„„åƒä¸‡ by watokiryuu</title>
    <link rel="icon" href="/favicon.ico" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #game-wrapper {
            width: 800px;
            height: 500px;
            position: relative;
            margin: 0 auto;
            background: transparent;
        }
        
        #game-container {
            width: 800px;
            height: 500px;
            position: relative;
            background: #000;
        }
        
        #game-canvas {
            background-color: #000;
        }
        
        #start-screen, #game-over-screen, #win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 10;
        }
        
        #game-over-screen, #win-screen {
            display: none;
        }
        
        h1 {
            color: #4af;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #4af;
        }
        
        button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4af;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            /* margin-top: 20px; */
        }
        
        button:hover {
            background-color: #6cf;
        }
        
        #health-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
        }
        
        #health-fill {
            height: 100%;
            width: 100%;
            background-color: #4af;
            transition: width 0.3s;
        }
        
        #boss-health-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
            display: none;
        }
        
        #boss-health-fill {
            height: 100%;
            width: 100%;
            background-color: #ccc;
            transition: width 0.3s;
        }
        
        #score {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            font-size: 18px;
            z-index: 5;
        }
        
        #camera-debug {
            position: absolute;
            top: 70px;
            left: 10px;
            color: white;
            font-size: 12px;
            z-index: 5;
        }
        
        #fps-display {
            position: absolute;
            top: 70px;
            right: 10px;
            color: white;
            font-size: 14px;
            z-index: 5;
        }
        
        #win-screen h1 div {
            text-align: center;
        }
        
        #touch-controls {
            position: absolute;
            left: 0;
            right: 0;
            top: 340px; /*æ•´é«”æŒ‰éˆ•é«˜åº¦ æ‰‹æ©Ÿæ§åˆ¶éˆ•é«˜åº¦ touché«˜åº¦*/
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            touch-action: none;
        }
        #touch-controls .touch-left, #touch-controls .touch-right {
            display: flex;
            gap: 8px; /* æ›´é è¿‘ */
            margin: 0 2vw; /* é è¿‘ä¸­é–“ */
        }
        #touch-controls button {
            pointer-events: auto;
            width: 60px;
            height: 60px;
            font-size: 24.2px;
            border-radius: 50%;
            border: none;
            background: #333a;
            color: #fff;
            box-shadow: 0 2px 8px #0006;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #touch-controls button:active {
            background: #4af;
            color: #fff;
        }
        @media (max-width: 900px) {
            #game-container { width: 800px; height: 500px; }
            #touch-controls { height: 90px; }
            #touch-controls .touch-left, #touch-controls .touch-right { margin: 0 6vw; }
            #touch-controls button { width: 60px; height: 60px; font-size: 24.2px; }
        }
        #touch-controls .touch-right {
            display: flex;
            gap: 8px;
            margin: 0 2vw;
            /* position: relative; */
            /* top: -100px; */
        }
        #btn-shoot {
            position: relative;
            top: -100px;
        }
        #settings-panel {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            color: #fff;
            padding: 32px 32px 24px 32px;
            border-radius: 16px;
            box-shadow: 0 4px 32px #000a;
            z-index: 2000;
            display: none;
            min-width: 320px;
            max-width: 96vw;
            max-height: 96vh;
            overflow: auto;
            font-size: calc(16px + 1vw);
        }
        @media (max-width: 600px) {
            #settings-panel {
                min-width: 0;
                width: 98vw;
                padding: 2vw 2vw 2vw 2vw;
                font-size: calc(12px + 2vw);
            }
            #settings-panel h2 {
                font-size: calc(18px + 2vw);
            }
        }
        #settings-panel *:not(h2) {
            font-size: 70% !important;
        }
        #language-select {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 12px 24px;
            border-radius: 10px;
            box-shadow: 0 2px 12px #0008;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 3000;
        }
        #custom-lang-select-list, #custom-lang-select-list li {
            font-size: 12px !important;
            line-height: 1.6;
        }
        #start-button,  #play-again-button{
            margin-top: 50px;
        }
        
    </style>
</head>
<body>
    <audio id="bgm" src="bgm.mp3" loop style="display:none"></audio>
    <audio id="shoot-audio" src="shoot.mp3" style="display:none"></audio>
    <audio id="game-over-audio" src="game-over.mp3" style="display:none"></audio>
    <audio id="charge-audio" src="charge.mp3" loop style="display:none"></audio>
    <audio id="boom-audio" src="boom.mp3" style="display:none"></audio>
    <audio id="hurt-audio" src="hurt.mp3" style="display:none"></audio>
    <audio id="bossdie-audio" src="bossdie.mp3" style="display:none"></audio>
    <audio id="outro-audio" src="outro.mp3" style="display:none"></audio>
    <audio id="boss-audio" src="boss.mp3" style="display:none"></audio>
    <div id="game-wrapper">
        <div id="game-container">
            <button id="lang-toggle" style="position:absolute;top:10px;right:10px;z-index:30;background:#222;color:#fff;border-radius:6px;padding:4px 12px;font-size:14px;">ğŸŒ</button>
            <div id="language-select" style="position:absolute;top:40px;right:10px;z-index:29;background:#222;padding:12px 24px;border-radius:10px;box-shadow:0 2px 12px #0008;display:none;flex-direction:column;align-items:center;">
                <h2 style="color:#fff;margin-bottom:10px;font-size:16px;">é¸æ“‡èªè¨€ / è¨€èªã‚’é¸æŠ / Select Language</h2>
                <div style="display:flex;gap:12px;">
                    <button id="lang-zh">ä¸­æ–‡</button>
                    <button id="lang-ja">æ—¥æœ¬èª</button>
                    <button id="lang-en">English</button>
                </div>
            </div>
            <canvas id="game-canvas" width="800" height="500"></canvas>
            
            <div id="health-bar">
                <div id="health-fill"></div>
            </div>
            
            <div id="boss-health-container">
                <div id="boss-health-fill"></div>
            </div>
            
            <div id="score">score: 0</div>
            <div id="camera-debug"></div>
            <div id="fps-display" style="position:absolute;top:70px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="xy-display" style="position:absolute;top:90px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="nxy-display" style="position:absolute;top:110px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="entity-counts" style="position:absolute;top:130px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            
            <!-- éŠæˆ²é–‹å§‹ç•«é¢ï¼ˆStart Screenï¼‰ -->
            <div id="start-screen">
                <h1></h1>
                <p></p>
                <p></p>
                <p></p>
                <button id="start-button">START</button>
            </div>
            
            <!-- éŠæˆ²çµæŸç•«é¢ï¼ˆGame Over Screenï¼‰ -->
            <div id="game-over-screen">
                <h1 style="color:#800;">gameover</h1>
                <p id="final-score">score: 0</p>
                <button id="restart-button">again?</button>
            </div>
            
            <!-- å‹åˆ©ç•«é¢ï¼ˆWin Screenï¼‰ -->
            <div id="win-screen">
                <h1>win!</h1>
                <p id="win-score">score: </p>
                <button id="play-again-button">play again</button>
                <div id="by-watoki" style="position:absolute;right:70px;bottom:10px;color:#fff;font-size:18px;z-index:20;text-shadow:0 0 4px #000a;">by Watoki</div>
            </div>
        </div>
        <div id="flash-effect" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100;display:none;"></div>
        <img id="tornado-img" src="tornadoes.png" style="display:none" />
        <!-- è§¸æ§æ“ä½œå€ -->
        <div id="touch-controls">
            <div class="touch-left">
                <button id="btn-left">â†</button>
                <button id="btn-right">â†’</button>
            </div>
            <div class="touch-right">
                <button id="btn-jump">â†‘</button>
                <button id="btn-shoot">S</button>
            </div>
        </div>
        <!-- <div id="settings-btn" style="position:absolute;right:10px;bottom:10px;width:45px;height:45px;border-radius:50%;background:#333a;color:#fff;box-shadow:0 2px 8px #0006;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;z-index:1000;font-size:22px;">âš™ï¸</div> -->
    </div>

    <script>

        // ===== éŠæˆ²è¨­å®šï¼ˆé›†ä¸­æ•´ç†ï¼‰ =====

        // é¡è‰²è¨­å®š
        const COLOR_PLATFORM_NORMAL = '#444';      // ä¸€èˆ¬å¹³å°é¡è‰²
        const COLOR_PLATFORM_BOSS   = '#800';      // Bosså€åŸŸå¹³å°é¡è‰²
        const COLOR_PLATFORM_HIGH   = '#666';      // é«˜å°å¹³å°é¡è‰²
        const COLOR_PLAYER          = '#4af';      // ç©å®¶é¡è‰²
        const COLOR_BOSS            = '#2196f3';   // Bossä¸»é«”é¡è‰²
        const COLOR_BOSS_FAN        = '#ffe082';   // Bossé¢¨æ‰‡é¡è‰²
        const COLOR_BOSS_FAN_CENTER = '#fff';      // Bossé¢¨æ‰‡ä¸­å¿ƒé¡è‰²
        const COLOR_BULLET_NORMAL   = '#b3f0ff';   // ç©å®¶æ™®é€šå­å½ˆé¡è‰²
        const COLOR_BULLET_CHARGE   = '#ff0';      // ç©å®¶é›†æ°£å½ˆé¡è‰²
        const COLOR_BULLET_ENEMY    = '#f8f';      // æ•µäººå­å½ˆé¡è‰²
        const COLOR_BULLET_BOSS     = '#f4a';      // Bosså­å½ˆé¡è‰²

        // éŸ³é‡è¨­å®š
        let VOLUME_BGM      = 0.55;  // èƒŒæ™¯éŸ³æ¨‚éŸ³é‡
        let VOLUME_SHOOT    = 0.55;  // å°„æ“ŠéŸ³æ•ˆéŸ³é‡
        let VOLUME_CHARGE   = 0.55;  // é›†æ°£éŸ³æ•ˆéŸ³é‡
        let VOLUME_BOOM     = 0.45;  // çˆ†ç‚¸éŸ³æ•ˆéŸ³é‡
        let VOLUME_HURT     = 0.70;  // å—å‚·éŸ³æ•ˆéŸ³é‡
        let VOLUME_GAMEOVER = 0.75;  // éŠæˆ²çµæŸéŸ³æ•ˆéŸ³é‡
        let VOLUME_BOSSDIE  = 0.40;  // Bossæ­»äº¡éŸ³æ•ˆéŸ³é‡
        let VOLUME_BOSS     = 0.85;  // Bosså‡ºå ´éŸ³æ•ˆéŸ³é‡
        let VOLUME_OUTRO    = 0.55;  // å‹åˆ©éŸ³æ¨‚éŸ³é‡

        // éŠæˆ²å¸¸æ•¸
        let GRAVITY         = 1;         // é‡åŠ›åŠ é€Ÿåº¦
        let JUMP_POWER      = -15; // è·³èºåˆé€Ÿåº¦
        let JUMP_EXTRA      = -0.5; // é•·æŒ‰è·³èºæ™‚æ¯å¹€é¡å¤–åŠ é€Ÿåº¦
        let JUMP_EXTRA_FRAMES = 12;      // è·³èºé¡å¤–åŠ é€Ÿæœ€å¤§å¹€æ•¸
        const WORLD_WIDTH     = 5400;    // ä¸–ç•Œå¯¬åº¦
        const WORLD_HEIGHT    = 500;       // ä¸–ç•Œé«˜åº¦
        const BOSS_AREA_X     = 4600;      // Bosså€åŸŸèµ·é»Xåº§æ¨™
        let CHARGE_MIN_FRAME = 42;       // é›†æ°£å½ˆæœ€å°‘éœ€è¦çš„å¹€æ•¸
        let CHARGE_CANCEL_FRAME = 12;    // é›†æ°£å–æ¶ˆçš„æœ€çŸ­å¹€æ•¸

        // ===== éŠæˆ²ç‹€æ…‹ =====
        let MAX_FPS = 70; // æœ€å¤§FPSè¨­å®š
        let startx = 0;
        let starty = 0;
        let gameRunning  = false; // éŠæˆ²æ˜¯å¦æ­£åœ¨é€²è¡Œä¸­
        let score        = 0;     // ç©å®¶åˆ†æ•¸
        let playerMaxHealth = 100; // æ–°å¢æœ€å¤§è¡€é‡
        let playerHealth = playerMaxHealth; // ç©å®¶ç›®å‰è¡€é‡
        let bossHealth   = 300;  // å¢å¼·Bossè¡€é‡
        let bossActive   = false; // Bossæ˜¯å¦å•Ÿå‹•
        let bossTimer    = 0;     // Bosså‡ºå ´å‹•ç•«è¨ˆæ™‚å™¨
        let reachedBossArea = false; // ç©å®¶æ˜¯å¦å·²ç¶“æŠµé”ébosså€åŸŸ
        let charging = false; // æ˜¯å¦æ­£åœ¨é›†æ°£
        let chargeFrame = 0; // é›†æ°£æŒçºŒå¹€æ•¸
        let chargeReady = false; // æ˜¯å¦é›†æ°£å®Œæˆ
        let bossHitFlash = 0; // Bossè¢«æ“Šä¸­é–ƒçˆè¨ˆæ•¸
        let upPressed = false; // è¿½è¹¤ä¸Šéµæ˜¯å¦å·²ç¶“æŒ‰ä¸‹
        let chargeAudioTimeout = null; // é›†æ°£éŸ³æ•ˆå»¶é²è¨ˆæ™‚å™¨
        let bossCanAttack = false; // Bossæ˜¯å¦å¯ä»¥æ”»æ“Š
        let bossCanMove = false; // Bossæ˜¯å¦å¯ä»¥ç§»å‹•
        let bossHpAnimating = false; // Bossè¡€æ¢æ˜¯å¦æ­£åœ¨å‹•ç•«
        let canShoot = true; // ç©å®¶æ˜¯å¦å¯ä»¥å°„æ“Š
        let midEventTriggered = false; // ä¸­é€”äº‹ä»¶æ˜¯å¦å·²è§¸ç™¼
        let playerDead = false; // æ–°å¢ï¼šç©å®¶æ­»äº¡ç‹€æ…‹
        let playerDeadX = 0;   // æ–°å¢ï¼šæ­»äº¡æ™‚çš„X
        let playerDeadY = 0;   // æ–°å¢ï¼šæ­»äº¡æ™‚çš„Y
        let weaponPower = 100;   // æ­¦å™¨æ”»æ“ŠåŠ›è¨­å®šï¼Œæ–¹ä¾¿çµ±ä¸€èª¿æ•´ç©å®¶å­å½ˆå‚·å®³ 1ç‚ºæ­£å¸¸æ•¸å­—è¶Šå¤§å‚·å®³è¶Šé«˜
        let playerMoveSpeed = 6; // ç©å®¶ç§»å‹•é€Ÿåº¦è¨­å®šï¼Œæ•¸å€¼è¶Šå¤§ç§»å‹•è¶Šå¿«ï¼Œé è¨­6
        let showScore = 1; // score:0 é¡¯ç¤º1 éš±è—0
        let showMoved = 0; // moved:(0) é¡¯ç¤º1 éš±è—0
        let showFPS = 1; //showfps
        let showXY = 0; //show xy
        let showNXY = 0; //show new xy
        let showEntityCounts = 0; //show äººç‰©æ€ªç‰©å­å½ˆæ•¸é‡
        let showMobileTouch = 1; // æ–°å¢ï¼šæ˜¯å¦é¡¯ç¤ºæ‰‹æ©Ÿè§¸æ§æŒ‰éˆ•ï¼ˆ1=é¡¯ç¤ºï¼Œ0=éš±è—ï¼‰
        let isBgmOn = 1;  // BGMï¼ˆåŒ…å« OUTROï¼‰æ˜¯å¦é–‹å•Ÿï¼Œ1=é–‹å•Ÿï¼Œ0=é—œé–‰
        let isSfxOn = 1; // æ•ˆæœéŸ³æ˜¯å¦é–‹å•Ÿï¼Œ1=é–‹å•Ÿï¼Œ0=é—œé–‰

        // ===== æ–°å¢ fakeBoss å…¨åŸŸè®Šæ•¸ =====
        let fakeBoss = null;
        let fakeBossFlashFrame = 0;

        // ä»¥æ ¼æ•¸è¨­è¨ˆçš„å¹³å°è³‡æ–™ åœ°æ¿
        const platformGrid = [
            // ç¬¬ä¸€å€ï¼ˆ0~2700ï¼‰
            { x: 0, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 1, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 2, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 3, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 4, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 5, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 6, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 7, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 8, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 9, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 10, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 11, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 12, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 13, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 14, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 15, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 16, y: 1, color: COLOR_PLATFORM_NORMAL },
            // ä¸­é–“å€åŸŸ
            { x: 17, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 18, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 19, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 20, y: 3, color: COLOR_PLATFORM_HIGH },
            // { x: 21, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 22, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 23, y: 3, color: COLOR_PLATFORM_NORMAL },
            { x: 24, y: 3, color: COLOR_PLATFORM_NORMAL },
            // { x: 25, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 26, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 27, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 28, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 29, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 30, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 31, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 32, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 33, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 34, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 35, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 36, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 37, y: 6, color: COLOR_PLATFORM_NORMAL },
            { x: 38, y: 6, color: COLOR_PLATFORM_NORMAL },
            { x: 39, y: 6, color: COLOR_PLATFORM_NORMAL },
            // { x: 40, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 41, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 42, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 43, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 44, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 45, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 46, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 47, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 48, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 49, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 50, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 51, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 52, y: 3, color: COLOR_PLATFORM_HIGH },
            // { x: 53, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 54, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 55, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 56, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 57, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 58, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 59, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 60, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 61, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 62, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 63, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 64, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 65, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 66, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 67, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 68, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 69, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 70, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 71, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 72, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 73, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 74, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 75, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 76, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 77, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 78, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 79, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 80, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 81, y: 7, color: COLOR_PLATFORM_NORMAL },
            // { x: 82, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 83, y: 7, color: COLOR_PLATFORM_HIGH },
            // { x: 84, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 85, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 86, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 87, y: 9, color: COLOR_PLATFORM_NORMAL },
            // { x: 88, y: 9, color: COLOR_PLATFORM_NORMAL },
            { x: 89, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 90, y: 2, color: COLOR_PLATFORM_NORMAL },

            // Boss å€åŸŸåœ°æ¿ï¼ˆx=4600 ä¹‹å¾Œï¼‰
            { x: 91, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 92, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 93, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 94, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 95, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 96, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 97, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 98, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 99, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 100, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 101, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 102, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 103, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 104, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 105, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 106, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 107, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 108, y: 1, color: COLOR_PLATFORM_BOSS },
        ];
        // è‡ªå‹•è½‰æ›
        const basePlatforms = platformGrid.map(p => ({
            x: p.x * 50,
            y: 500 - p.y * 50,
            width: 50,
            height: 50,
            color: p.color
        }));
        
        // ===== DOM å…ƒç´ é¸å– =====
        const canvas              = document.getElementById('game-canvas');
        const ctx                 = canvas.getContext('2d');
        
        const startScreen         = document.getElementById('start-screen');
        const gameOverScreen      = document.getElementById('game-over-screen');
        const winScreen           = document.getElementById('win-screen');
        
        const startButton         = document.getElementById('start-button');
        const restartButton       = document.getElementById('restart-button');
        const playAgainButton     = document.getElementById('play-again-button');
        
        const healthFill          = document.getElementById('health-fill');
        const bossHealthContainer = document.getElementById('boss-health-container');
        const bossHealthFill      = document.getElementById('boss-health-fill');
        
        const scoreElement        = document.getElementById('score');
        const finalScoreElement   = document.getElementById('final-score');
        const winScoreElement     = document.getElementById('win-score');
        const cameraDebugElement  = document.getElementById('camera-debug');

        
        // ===== é¡é ­ç³»çµ± =====
        const camera = {
            x: 0,
            y: 0,
            width: canvas.width,
            height: canvas.height,
            // å¹³æ»‘è·Ÿéš¨ç©å®¶
            follow: function(target) {
                const centerX = target.x + target.width/2;
                const centerY = target.y + target.height/2;
                
                // æ°´å¹³è·Ÿéš¨
                this.x = centerX - this.width/2;
                
                // ç•¶ç©å®¶æŠµé”bosså€åŸŸå¾Œï¼Œé¡é ­å·¦é‚Šç•Œé–å®šåœ¨BOSS_AREA_X
                if (target.x >= BOSS_AREA_X) {
                    this.x = Math.max(BOSS_AREA_X, this.x);
                }
                
                // å‚ç›´è·Ÿéš¨ (ä½†é™åˆ¶ä¸è®“ç©å®¶çœ‹åˆ°åœ°åœ–å¤–)
                const maxY = WORLD_HEIGHT - this.height;
                this.y = Math.min(maxY, Math.max(0, centerY - this.height/2));
                
                // é™åˆ¶ä¸è¶…å‡ºä¸–ç•Œé‚Šç•Œ
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
            }
        };
        
        // ===== ç©å®¶ç‰©ä»¶ =====
        let player = {
            x: startx,                // ç©å®¶Xåº§æ¨™ï¼ˆé€£å‹• startxï¼‰
            y: starty,                // ç©å®¶Yåº§æ¨™ï¼ˆé€£å‹• startyï¼‰
            width: 40,             // ç©å®¶å¯¬åº¦
            height: 40,            // ç©å®¶é«˜åº¦
            get speed() { return playerMoveSpeed; }, // ç©å®¶ç§»å‹•é€Ÿåº¦ï¼ˆå–è‡ªå…¨åŸŸè®Šæ•¸ï¼‰
            vy: 0,                 // å‚ç›´é€Ÿåº¦
            onGround: false,       // æ˜¯å¦åœ¨åœ°é¢ä¸Š
            color: '#4af',         // ç©å®¶é¡è‰²
            isShooting: false,     // æ˜¯å¦æ­£åœ¨å°„æ“Š
            shootCooldown: 0,      // å°„æ“Šå†·å»è¨ˆæ™‚å™¨
            shootDelay: Math.round(15 / 1.1), // å°„æ“Šé–“éš”
            direction: 1,          // ç©å®¶é¢å‘æ–¹å‘ï¼ˆ1=å³ï¼Œ-1=å·¦ï¼‰
            invincible: 0,         // ç„¡æ•µå‰©é¤˜å¹€æ•¸
            
            // æ›´æ–°ç©å®¶ä½ç½®
            update: function() {
                if (playerDead) {
                    this.x = playerDeadX;
                    this.y = playerDeadY;
                    return; // æ­»äº¡æ™‚ä¸èƒ½å‹•ä½œä¸”ç¶­æŒåœ¨æ­»äº¡ä½ç½®
                }
                // ===== é£›è¡Œæ¨¡å¼ =====
                if (isFlyingMode === 1) {
                    // å·¦å³ç§»å‹•
                    if (keys.ArrowLeft)  { this.x -= this.speed; this.direction = -1; }
                    if (keys.ArrowRight) { this.x += this.speed; this.direction =  1; }
                    // ä¸Šä¸‹ç§»å‹•
                    if (keys.ArrowUp)    { this.y -= this.speed; }
                    if (keys.ArrowDown)  { this.y += this.speed; }
                    // é‚Šç•Œé™åˆ¶
                    this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                    this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
                    this.onGround = false;
                    return;
                }
                // æ˜¯å¦æŠµé”ébosså€åŸŸ
                if (this.x >= BOSS_AREA_X) {
                    reachedBossArea = true;
                }
                // æ°´å¹³ç§»å‹•
                if (keys.ArrowLeft)  {
                    if (reachedBossArea) {
                        this.x -= this.speed;
                        if (this.x < BOSS_AREA_X) this.x = BOSS_AREA_X;
                    } else {
                        this.x -= this.speed;
                        if (this.x < 0) this.x = 0;
                    }
                    this.direction = -1;
                }
                if (keys.ArrowRight) { this.x += this.speed; this.direction =  1; }
                
                // è·³èº
                if (keys.ArrowUp && this.onGround && !upPressed) {
                    this.vy = JUMP_POWER;
                    this.onGround = false;
                    upPressed = true;
                    isJumping = true;
                    jumpHoldFrames = 0;
                }
                if (!keys.ArrowUp) upPressed = false;
                
                // é‡åŠ›èˆ‡æ–° y ä½ç½®
                this.vy += GRAVITY;
                let newY = this.y + this.vy;
                
                // å¹³å°ç¢°æ’æª¢æ¸¬
                this.onGround = false;
                for (let p of platforms) {
                    const overlapX = this.x + this.width > p.x && this.x < p.x + p.width;
                    if (overlapX && this.y + this.height <= p.y && newY + this.height >= p.y) {
                        newY = p.y - this.height;
                        this.vy = 0;
                        this.onGround = true;
                    }
                }
                
                // æ›´æ–°ä½ç½®
                this.y = newY;
                
                // é‚Šç•Œé™åˆ¶
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                
                // æ‰è½æ­»äº¡
                if (this.y >= WORLD_HEIGHT) {
                    gameOver();
                    return;
                }
                
                // ç„¡æ•µæ™‚é–“æ›´æ–°
                if (this.invincible > 0) {
                    this.invincible--;
                }
                // è·³èºå¢åŠ›ï¼ˆå¯è®Šé«˜åº¦ï¼‰
                if (isJumping && !this.onGround && this.vy < 0 && jumpHoldFrames < JUMP_EXTRA_FRAMES) {
                    this.vy += JUMP_EXTRA;
                    jumpHoldFrames++;
                } else if (jumpHoldFrames >= JUMP_EXTRA_FRAMES) {
                    isJumping = false;
                }
                // é™åˆ¶æœ€é«˜ä¸Šå‡250åƒç´ 
                if (isJumping && jumpStartY - this.y >= 250) {
                    isJumping = false;
                    if (this.vy < 0) this.vy = 0; // ç«‹å³åœæ­¢ä¸Šå‡
                }
            },
            
            // ç©å®¶å°„æ“Š
            shoot: function() {
                if (playerDead) return; // æ­»äº¡æ™‚ä¸èƒ½å°„æ“Š
                if (!canShoot) return;
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                    return;
                }
                // å¦‚æœé›†æ°£å½ˆå³å°‡ç™¼å°„ï¼Œä¸ç™¼å°„æ™®é€šå­å½ˆ
                if (chargeReady) return;
                // é›†æ°£ç‹€æ…‹ä¸‹ï¼Œåªæœ‰é›†æ°£è¶…é0.7ç§’æ‰ä¸ç™¼å°„æ™®é€šå­å½ˆ
                if (charging && chargeFrame >= CHARGE_CANCEL_FRAME) return;
                if (this.isShooting && this.shootCooldown === 0) {
                    bullets.push({
                        x: this.x + (this.direction === 1 ? this.width : -10),
                        y: this.y + this.height / 2 - 3,
                        width: 10,
                        height: 6,
                        speed: 10 * 1.1 * this.direction, // 1.1å€
                        color: '#b3f0ff',
                        isCharge: false
                    });
                    this.shootCooldown = this.shootDelay;
                }
            },
            
            // å—å‚·è™•ç†
            takeDamage: function(amount) {
                if (isWinInvincible) return;
                if (this.invincible > 0) return;
                // æ’­æ”¾å—å‚·éŸ³æ•ˆ
                const hurtAudio = document.getElementById('hurt-audio');
                if (hurtAudio) {
                    hurtAudio.currentTime = 0;
                    hurtAudio.volume = VOLUME_HURT;
                    if (isSfxOn) hurtAudio.play();
                }
                playerHealth -= amount;
                updateHealthBar();
                this.invincible = 30; // 30å¹€ç„¡æ•µæ™‚é–“
                if (playerHealth <= 0) {
                    gameOver();
                }
            }
        };
        const players = [player];
        
        // ===== å­å½ˆç³»çµ± =====
        const bullets = [];
        const enemyBullets = [];
        
        // ===== æ•µäººé¡å‹ =====
        // é™¤éŒ¯ï¼šå®šç¾©æ‰€æœ‰å°å…µçš„å±¬æ€§èˆ‡è¡Œç‚ºï¼Œæ–¹ä¾¿çµ±ä¸€ç®¡ç†èˆ‡æ“´å……
        const ENEMY_TYPES = {
            // é£›è¡Œç³»åˆ—ï¼ˆåœ“å½¢ï¼‰
            FLY_RED: {
                color: '#f44', // é¡è‰²
                speed: 1.5 * 1.1, // ç§»å‹•é€Ÿåº¦
                health: 1, // è¡€é‡
                score: 60, // æ“Šæ®ºå¾—åˆ†
                behavior: function(enemy) { // è¡Œç‚ºå‡½æ•¸
                    enemy.x -= enemy.speed;
                    // å°å¹…åº¦ä¸Šä¸‹
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 600 + enemy._id) * 18;
                },
                isFlying: true, // æ˜¯å¦ç‚ºé£›è¡Œæ•µäºº
                eye: { color: '#222', type: 'circle' } // çœ¼ç›æ¨£å¼
            },
            FLY_ORANGE: {
                color: '#f84', // é¡è‰²
                speed: 2.25 * 1.1, // ç§»å‹•é€Ÿåº¦
                health: 1, // è¡€é‡
                score: 80, // æ“Šæ®ºå¾—åˆ†
                behavior: function(enemy) { // è¡Œç‚ºå‡½æ•¸
                    enemy.x -= enemy.speed;
                    // å¤§å¹…åº¦ä¸Šä¸‹
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 300 + enemy._id) * 48;
                },
                isFlying: true, // æ˜¯å¦ç‚ºé£›è¡Œæ•µäºº
                eye: { color: '#222', type: 'circle' } // çœ¼ç›æ¨£å¼
            },
            // åœ°ä¸Šç³»åˆ—ï¼ˆåŠåœ“å½¢ï¼‰
            GROUND_RED: {
                color: '#f44', // é¡è‰²
                speed: 0.75 * 1.1, // ç§»å‹•é€Ÿåº¦
                health: 1, // è¡€é‡
                score: 50, // æ“Šæ®ºå¾—åˆ†
                behavior: function(enemy) { // è¡Œç‚ºå‡½æ•¸
                    enemy.x -= enemy.speed;
                },
                isFlying: false, // æ˜¯å¦ç‚ºé£›è¡Œæ•µäºº
                eye: { color: '#222', type: 'semi' } // çœ¼ç›æ¨£å¼
            },
            GROUND_ORANGE: {
                color: '#f84', // é¡è‰²
                speed: 0.75 * 1.1, // ç§»å‹•é€Ÿåº¦
                health: 1, // è¡€é‡
                score: 70, // æ“Šæ®ºå¾—åˆ†
                behavior: function(enemy) { // è¡Œç‚ºå‡½æ•¸
                    enemy.x -= enemy.speed;
                    if (enemy.onGround && Math.random() < 0.02) {
                        enemy.vy = -12;
                        enemy.onGround = false;
                    }
                },
                isFlying: false, // æ˜¯å¦ç‚ºé£›è¡Œæ•µäºº
                eye: { color: '#222', type: 'semi' } // çœ¼ç›æ¨£å¼
            },
            GROUND_PINK: {
                color: '#f8c', // é¡è‰²
                speed: 0, // ç§»å‹•é€Ÿåº¦
                health: 1, // è¡€é‡
                score: 100, // æ“Šæ®ºå¾—åˆ†
                shootDelay: Math.round(120), // å°„æ“Šé–“éš” æ•¸å­—è¶Šå°å°„æ“Šè¶Šå¿«
                behavior: function(enemy) { // è¡Œç‚ºå‡½æ•¸
                    // å›ºå®šé»å°„æ“Š
                    if (enemy.shootCooldown > 0) {
                        enemy.shootCooldown--;
                    } else {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (enemy.y + enemy.height/2),
                            player.x + player.width/2 - (enemy.x + enemy.width/2)
                        );
                        // å°„æ“Šæ¬¡æ•¸æ¸›åŠï¼ŒåŸæœ¬1ç™¼ï¼Œç¾åœ¨æ¯2æ¬¡æ‰å°„1ç™¼
                        if (!enemy._shootToggle) enemy._shootToggle = false;
                        enemy._shootToggle = !enemy._shootToggle;
                        if (enemy._shootToggle) {
                            enemyBullets.push({
                                x: enemy.x + enemy.width/2 - 3,
                                y: enemy.y + enemy.height/2 - 3,
                                width: 6,
                                height: 6,
                                speedX: Math.cos(angle) * 1.3,
                                speedY: Math.sin(angle) * 1.3,
                                color: '#f8c'
                            });
                        }
                        enemy.shootCooldown = enemy.shootDelay;
                    }
                },
                isFlying: false, // æ˜¯å¦ç‚ºé£›è¡Œæ•µäºº
                eye: { color: '#fff', type: 'semi' } // çœ¼ç›æ¨£å¼
            }
        };
        
        // ===== æ•µäººé™£åˆ— =====
        const enemies = [];
        // ===== æ•µäººé–ƒçˆç‹€æ…‹ =====
        const enemyHitFlash = new WeakMap(); // Map<enemy, frame>
        
        // ===== Boss ç‰©ä»¶ =====
        const boss = {
            x: 2500 + 2700 * 1,
            y: 350, // å›ºå®šåˆå§‹åº§æ¨™
            width: 100,
            height: 100,
            speed: 2 * 1.1, // 1.1å€
            vy: 0, // ä¸å†éœ€è¦é‡åŠ›
            color: '#2196f3', // ä¸»é«”è—è‰²ï¼ˆAirmanä¸»è‰²ï¼‰
            shootCooldown: 0,
            shootDelay: Math.round(200 / 1.1), // é–“éš”ç¸®çŸ­
            pattern: 0,
            patternTimer: 0,
            health: 300,
            maxHealth: 300,
            onGround: false, // ä¸å†éœ€è¦onGround
            pauseTimer: 0, // æ–°å¢ï¼šæš«åœè¨ˆæ™‚å™¨
            
            // Boss è¡Œç‚ºæ¨¡å¼
            update: function() {
                // æ–°å¢ï¼šæš«åœç‹€æ…‹
                if (this.pauseTimer > 0) {
                    this.pauseTimer--;
                    return;
                }
                // æ¨¡å¼è¨ˆæ™‚å™¨
                this.patternTimer++;
                if (this.patternTimer > 180) {
                    this.pattern = (this.pattern + 1) % 4;
                    this.patternTimer = 0;
                }
                if (!bossCanMove) return; // 0.7ç§’å…§ä¸èƒ½ç§»å‹•
                // ä¸å—é‡åŠ›å½±éŸ¿ï¼Œç›´æ¥æ ¹æ“šè¡Œç‚ºæ¨¡å¼èª¿æ•´yåº§æ¨™
                switch (this.pattern) {
                    case 0: // ä¸Šä¸‹ç§»å‹•
                        this.y += this.speed;
                        if (this.y < 50 || this.y > 350) { // bosså‡ºå ´å¾Œçš„æœ€åº•ç¯„åœ
                            this.speed *= -1;
                        }
                        break;
                    case 1: // è¿½è¹¤ç©å®¶
                        if (this.y < player.y) {
                            this.y += this.speed;
                        } else if (this.y > player.y) {
                            this.y -= this.speed;
                        }
                        break;
                    case 2: // å¿«é€Ÿä¸Šä¸‹ç§»å‹•
                        if (this.patternTimer % 60 < 30) {
                            this.y -= 8; // å‘ä¸Šé£„
                        } else {
                            this.y += 8; // å‘ä¸‹é£„
                        }
                        // é™åˆ¶ç¯„åœ
                        this.y = Math.max(50, Math.min(350, this.y)); // bosså‡ºå ´å¾Œçš„æœ€åº•ç¯„åœ
                        break;
                    case 3: // è¡åˆºæ”»æ“Š
                        if (this.patternTimer < 60) {
                            this.x -= 5;
                        } else if (this.patternTimer < 120) {
                            this.x += 5;
                        }
                        break;
                }
                // Boss å°„æ“Š
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                } else if (bossCanAttack) {
                    // ä¸‰æ–¹å‘å°„æ“Š
                    for (let i = -1; i <= 1; i++) {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (this.y + this.height/2),
                            player.x + player.width/2 - (this.x + this.width/2)
                        ) + (i * 0.3);
                        enemyBullets.push({
                            x: this.x + this.width/2 - 3.4125,
                            y: this.y + this.height/2 - 13.65,
                            width: 10,
                            height: 20,
                            speedX: Math.cos(angle) * 3,
                            speedY: Math.sin(angle) * 3,
                            color: '#f4a'
                        });
                    }
                    this.shootCooldown = this.shootDelay; // â† æ¯æ¬¡ç™¼å°„å¾Œé‡è¨­å†·å»
                }
                // === åŠ å…¥é‚Šç•Œé™åˆ¶ ===
                this.x = Math.max(BOSS_AREA_X, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(350, this.y)); // bosså‡ºå ´å¾Œçš„æœ€åº•ç¯„åœ
            }
        };
        const bosses = [boss];
        
        // ===== å¹³å°é™£åˆ— =====
        const platforms = basePlatforms.slice();
        
        // ===== æ§åˆ¶ç³»çµ± =====
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            ' ': false,
            'Enter': false
        };
        
        // ===== äº‹ä»¶ç›£è½ =====
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        playAgainButton.addEventListener('click', startGame);
        
        // è·³èºéµæŒ‰ä¸‹æ™‚é–“è¨˜éŒ„
        let jumpKeyDownTime = 0;
        let jumpKeyPressed = false;
        let isJumping = false;
        let jumpHoldFrames = 0;
        const jumpMaxHoldTime = 300; // æœ€é•·0.3ç§’
        let jumpStartY = 0; // èµ·è·³æ™‚yåº§æ¨™
        
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
                if (e.key === 'ArrowUp' && !jumpKeyPressed) {
                    jumpKeyDownTime = Date.now();
                    jumpKeyPressed = true;
                }
                if (e.key === 'Enter' && !gameRunning) {
                    startGame();
                }
                if (e.key === ' ' && gameRunning) {
                    // æŒ‰ä¸‹ç©ºç™½éµï¼Œç«‹å³å•Ÿå‹•æ™®é€šå°„æ“Š
                    if (!charging) {
                        charging = true;
                        chargeFrame = 0;
                        chargeReady = false;
                        player.isShooting = true;
                        // æ’­æ”¾å°„æ“ŠéŸ³æ•ˆ
                        const shootAudio = document.getElementById('shoot-audio');
                        if (shootAudio) {
                            shootAudio.currentTime = 0;
                            shootAudio.volume = VOLUME_SHOOT;
                            if (isSfxOn) shootAudio.play();
                        }
                        // å»¶é²0.5ç§’å¾Œæ‰æ’­æ”¾é›†æ°£éŸ³æ•ˆ
                        if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                        chargeAudioTimeout = setTimeout(() => {
                            if (charging) {
                                const chargeAudio = document.getElementById('charge-audio');
                                if (chargeAudio) {
                                    chargeAudio.currentTime = 0;
                                    chargeAudio.volume = VOLUME_CHARGE;
                                    if (isSfxOn) chargeAudio.play();
                                }
                            }
                        }, 500);
                    }
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
                if (e.key === 'ArrowUp' && jumpKeyPressed) {
                    const pressDuration = Date.now() - jumpKeyDownTime;
                    if (pressDuration < 200 && player.vy < 0) {
                        // 0.2ç§’ä»¥ä¸‹ï¼Œ1/4é«˜åº¦
                        player.vy /= 4;
                    } else if (pressDuration < 300 && player.vy < 0) {
                        // 0.2~0.3ç§’ï¼Œ1/3é«˜åº¦
                        player.vy /= 3;
                    } else if (pressDuration < 400 && player.vy < 0) {
                        // 0.3~0.4ç§’ï¼Œä¸€åŠé«˜åº¦
                        player.vy /= 2;
                    }
                    // è¶…é0.4ç§’ï¼Œç¶­æŒåŸæœ¬æœ€é«˜é«˜åº¦
                    jumpKeyPressed = false;
                }
                if (e.key === ' ') {
                    // æ”¾é–‹ç©ºç™½éµæ™‚ï¼Œæ ¹æ“šé›†æ°£æ™‚é–“æ±ºå®šç™¼å°„ä»€éº¼
                    if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                        chargeReady = true; // ç™¼å°„é›†æ°£å½ˆ
                    } else if (charging && chargeFrame < CHARGE_CANCEL_FRAME && !chargeReady) {
                        // åªæœ‰ chargeReady ç‚º false æ‰è£œç™¼æ™®é€šå½ˆ
                        player.isShooting = true;
                    }
                    charging = false;
                    setTimeout(() => { player.isShooting = false; }, 0); // ä¸‹ä¸€å¹€é—œé–‰æ™®é€šå°„æ“Š
                    // åœæ­¢é›†æ°£éŸ³æ•ˆ
                    if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                    const chargeAudio = document.getElementById('charge-audio');
                    if (chargeAudio) {
                        chargeAudio.pause();
                        chargeAudio.currentTime = 0;
                        chargeAudio.volume = VOLUME_CHARGE;
                    }
                }
            }
        });
        
        // ===== éŠæˆ²åˆå§‹åŒ– =====
        const bgm = document.getElementById('bgm');
        /**
         * éŠæˆ²åˆå§‹åŒ–ï¼Œé‡è¨­æ‰€æœ‰ç‹€æ…‹ä¸¦é–‹å§‹éŠæˆ²ä¸»å¾ªç’°
         */
        function startGame() {
            // åœæ­¢outroéŸ³æ¨‚
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.pause();
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                outroAudio.onended = null;
            }
            // éŸ³æ¨‚æ’­æ”¾æ§åˆ¶
            if (bgm) {
                bgm.currentTime = 0;
                bgm.volume = VOLUME_BGM;
                if (isBgmOn) bgm.play();
            }
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameRunning = true;
            score = 0;
            playerHealth = playerMaxHealth;
            boss.health = boss.maxHealth;
            boss.x = 2500 + 2700 * 1;
            boss.y = 350;
            bossActive = false;
            reachedBossArea = false;
            
            // é‡ç½®ç©å®¶ä½ç½®
            player.x = startx;
            player.y = starty;
            player.vy = 0;
            player.onGround = true;
            player.direction = 1;
            player.invincible = 0;
            
            // æ¸…ç©ºé™£åˆ—
            bullets.length = 0;
            enemyBullets.length = 0;
            enemies.length = 0;
            
            // éš±è—ä»‹é¢å…ƒç´ 
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            bossHealthContainer.style.display = 'none';
            
            // æ›´æ–°UI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // å•Ÿå‹•éŠæˆ²å¾ªç’°
            requestAnimationFrame(gameLoop);
            langToggle.style.display = 'none';
            langSelect.style.display = 'none';
            canShoot = false;
            charging = false;
            player.isShooting = false;
            chargeFrame = 0;
            chargeReady = false;
            if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
            setTimeout(() => { canShoot = true; }, 200);
            playerDead = false; // é‡è¨­æ­»äº¡ç‹€æ…‹
            playerDeadX = 0;
            playerDeadY = 0;
            bossDefeated = false;
            isWinInvincible = false;
        }
        
        // ===== éŠæˆ²ä¸»å¾ªç’° =====
        let lastFrameTime = 0;
        function getFrameDuration() {
            return 1000 / MAX_FPS;
        }

        /**
         * éŠæˆ²ä¸»å¾ªç’°ï¼Œæ¯ä¸€å¹€å‘¼å«ä¸€æ¬¡
         * @param {DOMHighResTimeStamp} now - ç•¶å‰æ™‚é–“æˆ³ï¼ˆç”±requestAnimationFrameå‚³å…¥ï¼‰
         */
        function gameLoop(now) {
            requestAnimationFrame(gameLoop);
            if (isPaused) return; // æš«åœæ™‚ä¸æ›´æ–°éŠæˆ²
            if (now - lastFrameTime < getFrameDuration()) return;
            lastFrameTime = now;
            update();
            render();
            updateFPS();
        }
        
        // ===== éŠæˆ²ç‹€æ…‹æ›´æ–° =====
        /**
         * æ›´æ–°éŠæˆ²æ‰€æœ‰ç‹€æ…‹ï¼ˆç©å®¶ã€æ•µäººã€å­å½ˆã€Bossç­‰ï¼‰
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function update() {
            // é›†æ°£ç‹€æ…‹è¨ˆæ•¸
            if (charging) {
                chargeFrame++;
            }
            // å…ˆè™•ç†é›†æ°£å½ˆ
            if (chargeReady) {
                // ç™¼å°„é›†æ°£å½ˆ
                bullets.push({
                    x: player.x + (player.direction === 1 ? player.width : -40),
                    y: player.y + player.height / 2 - 12,
                    width: 40,
                    height: 24,
                    speed: 10 * 1.1 * player.direction, // 1.1å€
                    color: '#ff0',
                    isCharge: true // æ¨™è¨˜ç‚ºé›†æ°£å½ˆ
                });
                player.shootCooldown = player.shootDelay; // çµ¦ä¸€é»å†·å»
                // æ’­æ”¾shootéŸ³æ•ˆ
                const shootAudio = document.getElementById('shoot-audio');
                if (shootAudio) {
                    shootAudio.currentTime = 0;
                    shootAudio.volume = VOLUME_SHOOT;
                    shootAudio.play();
                }
                chargeReady = false;
            }
            // æ›´æ–°ç©å®¶
            player.update();
            player.shoot();
            
            // ç›£æ§ç©å®¶ä½ç½® - åƒ…åœ¨æ“ä½œæ–¹å‘éµæ™‚è¼¸å‡º
            if (keys.ArrowLeft || keys.ArrowRight || keys.ArrowUp) {
                // console.log('ç©å®¶ä½ç½®:', { x: player.x, y: player.y, onGround: player.onGround });
            }
            
            // æ›´æ–°é¡é ­
            camera.follow(player);
            
            // Bosså€åŸŸæ•ˆæœ
            if (player.x >= BOSS_AREA_X && !bossActive && bossTimer === 0 && !isWinScreen && !bossDefeated) {
                // å…ˆä¸é¡¯ç¤ºæ­£å¼bossè¡€æ¢
                bossHealthContainer.style.display = 'none';
                // å…ˆç§»é™¤æ‰€æœ‰èˆŠçš„ fake hp æ¢
                let oldFakeBar = document.getElementById('boss-fake-bar');
                if (oldFakeBar) oldFakeBar.remove();
                // æ–° fake hp æ¢å‹•ç•«
                let fakeBar = document.createElement('div');
                fakeBar.style.position = 'absolute';
                fakeBar.style.top = '10px';
                fakeBar.style.right = '10px';
                fakeBar.style.width = '200px';
                fakeBar.style.height = '20px';
                fakeBar.style.background = '#333';
                fakeBar.style.border = '2px solid #444';
                fakeBar.style.zIndex = 5;
                fakeBar.id = 'boss-fake-bar';
                let fakeFill = document.createElement('div');
                fakeFill.style.height = '100%';
                fakeFill.style.width = '1%';
                fakeFill.style.background = '#ccc';
                fakeFill.style.transition = 'none';
                fakeBar.appendChild(fakeFill);
                document.getElementById('game-container').appendChild(fakeBar);
                let animPercent = 1;
                const animStep = (100 - 1) / (1500 / 16); // 1.5ç§’ 1%~100%
                const anim = setInterval(() => {
                    animPercent += animStep;
                    if (animPercent >= 100) {
                        animPercent = 100;
                        clearInterval(anim);
                        // ç§»é™¤ fake hp æ¢ï¼Œé¡¯ç¤ºæ­£å¼ boss hp æ¢
                        let oldFakeBar2 = document.getElementById('boss-fake-bar');
                        if (oldFakeBar2) oldFakeBar2.remove();
                        bossHealthContainer.style.display = 'block';
                        updateBossHealthBar();
                    }
                    fakeFill.style.width = animPercent + '%';
                }, 16);
                bossTimer = 1;
                enemies.length = 0;
                enemyBullets.length = 0;
            }
            
            // è¨ˆæ™‚å™¨é‹è¡Œï¼Œ3 ç§’å¾Œæ¿€æ´» BOSS
            if (bossTimer > 0 && bossTimer < 250) {
                bossTimer++;
                if (bossTimer === 100) {
                    // æ’­æ”¾bosså‡ºå ´éŸ³æ•ˆ bosstimer æ˜¯bosså‡ºå ´å»¶é²æ™‚é–“
                    const bossAudio = document.getElementById('boss-audio');
                    if (bossAudio) {
                        bossAudio.currentTime = 0;
                        bossAudio.volume = VOLUME_BOSS;
                        if (isSfxOn) bossAudio.play();
                    }
                    // å»¶é²0.4ç§’å¾Œæ‰è®“bosså‡ºç¾
                    setTimeout(() => {
                        bossActive = true;
                        bossTimer = 0;
                        bossCanAttack = false;
                        bossCanMove = false;
                        setTimeout(() => {
                            bossCanAttack = true;
                            bossCanMove = true;
                        }, 700);
                    }, 400);
                }
            }
            
            // ç”Ÿæˆæ•µäºº
            if (Math.random() < 0.015 && enemies.length < 8 && !bossActive && player.x < WORLD_WIDTH - 1000) {
                // åªå¾æ–°å…­ç¨®å°æ€ªéš¨æ©Ÿé¸ä¸€ç¨®
                const enemyTypes = Object.values(ENEMY_TYPES);
                let type;
                let tryCount = 0;
                do {
                    type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    // å¦‚æœæ˜¯ç²‰ç´…è‰²åœ°é¢æ€ªï¼Œåªæœ‰ç©å®¶å¾€å³æ™‚æ‰å…è¨±ç”Ÿæˆ
                    if (type === ENEMY_TYPES.GROUND_PINK && !keys.ArrowRight) {
                        tryCount++;
                        continue;
                    }
                    break;
                } while (tryCount < 10);
                // çµ¦æ¯éš»æ•µäººä¸€å€‹å”¯ä¸€ id ä¾›é£„æµ®ç”¨
                const enemy = {
                    x: camera.x + camera.width + 50, // åˆå§‹Xåº§æ¨™ï¼ˆç”Ÿæˆåœ¨é¡é ­å³å´ï¼‰
                    y: type.isFlying ? (Math.random() * (WORLD_HEIGHT - 200) + 50) : (Math.random() * (WORLD_HEIGHT - 100) + 50), // åˆå§‹Yåº§æ¨™
                    width: 30, // å¯¬åº¦
                    height: 30, // é«˜åº¦
                    speed: type.speed, // ç§»å‹•é€Ÿåº¦
                    health: 3, // ç•¶å‰è¡€é‡
                    maxHealth: 3, // æœ€å¤§è¡€é‡
                    score: type.score, // æ“Šæ®ºå¾—åˆ†
                    color: type.color, // é¡è‰²
                    behavior: type.behavior, // è¡Œç‚ºå‡½æ•¸
                    onGround: false, // æ˜¯å¦åœ¨åœ°é¢ä¸Š
                    vy: 0, // å‚ç›´é€Ÿåº¦
                    shootCooldown: (type === ENEMY_TYPES.GROUND_PINK) ? 50 : 0, // ç²‰è‰²å°å…µç¬¬ä¸€ç™¼å»¶é²50åµï¼Œå…¶é¤˜ç‚º0
                    shootDelay: type.shootDelay || 0, // å°„æ“Šé–“éš”
                    isFlying: type.isFlying, // æ˜¯å¦ç‚ºé£›è¡Œæ•µäºº
                    eye: type.eye, // çœ¼ç›æ¨£å¼
                    _id: Math.random() * 1000000 | 0, // å”¯ä¸€IDï¼ˆé£„æµ®ç”¨ï¼‰
                    dying: false, // æ˜¯å¦é€²å…¥æ­»äº¡é–ƒçˆ
                    dyingFrame: 0 // æ­»äº¡é–ƒçˆè¨ˆæ•¸
                };
                enemies.push(enemy);
            }
            
            // æ›´æ–°æ•µäºº
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (enemy.isFloating) {
                    // é£„æµ®å°å…µï¼šä¸Šä¸‹é£„å‹•ï¼Œä¸å—é‡åŠ›èˆ‡å¹³å°å½±éŸ¿
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 400 + i) * 40;
                    enemy.x -= enemy.speed;
                } else {
                    // åŸæœ¬åœ°é¢å°å…µ
                    enemy.vy += GRAVITY;
                    let newY = enemy.y + enemy.vy;
                    enemy.onGround = false;
                    for (let p of platforms) {
                        const overlapX = enemy.x + enemy.width > p.x && enemy.x < p.x + p.width;
                        if (overlapX && enemy.y + enemy.height <= p.y && newY + enemy.height >= p.y) {
                            newY = p.y - enemy.height;
                            enemy.vy = 0;
                            enemy.onGround = true;
                        }
                    }
                    enemy.y = newY;
                    enemy.behavior(enemy);
                }
                // æ›´æ–°æ•µäººé–ƒçˆç‹€æ…‹
                if (enemyHitFlash.has(enemy)) {
                    let frame = enemyHitFlash.get(enemy);
                    frame--;
                    if (frame <= 0) {
                        enemyHitFlash.delete(enemy);
                    } else {
                        enemyHitFlash.set(enemy, frame);
                    }
                }
                // ç§»é™¤å±å¹•å¤–çš„æ•µäºº
                if (enemy.x < camera.x - 100 || enemy.x > camera.x + camera.width + 100) {
                    enemies.splice(i, 1);
                    continue;
                }
                // æª¢æ¸¬ç©å®¶ç¢°æ’
                if (checkCollision(player, enemy)) {
                    if (enemy.health > 0) {
                        player.takeDamage(10);
                    }
                    // å°å…µä¸æœƒå› ç¢°æ’ç©å®¶è€Œæ¶ˆå¤±
                    continue;
                }
                // åœ¨æ•µäººæ›´æ–°æ™‚ï¼Œè™•ç†æ­»äº¡é–ƒçˆèˆ‡è‡ªå‹•æ¶ˆå¤±
                if (enemy.dying) {
                    enemy.dyingFrame++;
                    // é–ƒçˆå…©ä¸‹ï¼ˆ12å¹€ï¼Œç´„0.2ç§’ï¼‰å¾Œè‡ªå‹•æ¶ˆå¤±
                    if (enemy.dyingFrame >= 12) {
                        enemies.splice(i, 1);
                        score += enemy.score;
                        updateScore();
                        continue;
                    }
                }
            }
            
            // æ›´æ–°Boss
            if (bossActive) {
                boss.update();
                
                // æª¢æ¸¬ç©å®¶ç¢°æ’
                if (checkCollision(player, boss)) {
                    player.takeDamage(15);
                }
            }
            
            // æ›´æ–°å­å½ˆ
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.speed;
                
                // ç§»é™¤å±å¹•å¤–çš„å­å½ˆ
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // æª¢æ¸¬æ•µäººç¢°æ’
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        if (bullet.isCharge) {
                            enemy.health -= weaponPower * 5; // é›†æ°£å½ˆæ”»æ“ŠåŠ›5å€
                        } else {
                            enemy.health -= weaponPower * 1.5; // æ™®é€šå­å½ˆæ”»æ“ŠåŠ›
                        }
                        enemyHitFlash.set(enemy, 12); // 0.2ç§’é–ƒçˆ
                        // æ’­æ”¾booméŸ³æ•ˆï¼ˆé›†æ°£å½ˆä¹Ÿæœ‰ï¼‰
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            const clone = boomAudio.cloneNode();
                            clone.volume = VOLUME_BOOM;
                            if (isSfxOn) clone.play();
                        }
                        if (enemy.health <= 0 && !enemy.dying) {
                            enemy.dying = true;
                            enemy.dyingFrame = 0;
                        }
                        bullets.splice(i, 1);
                        break;
                    }
                }
                
                // æª¢æ¸¬Bossç¢°æ’
                if (bossActive && checkCollision(bullet, boss)) {
                    if (bullet.isCharge) {
                        boss.health -= weaponPower * 3; // é›†æ°£å½ˆæ”»æ“ŠåŠ›3å€
                        boss.pauseTimer = 42; // æš«åœ42åµ
                        boss.lastHitCharge = true; // é›†æ°£å½ˆ
                    } else {
                        boss.health -= weaponPower; // æ™®é€šå­å½ˆæ”»æ“ŠåŠ›
                        boss.lastHitCharge = false; // æ–°å¢ï¼šè¨˜éŒ„é€™æ¬¡ä¸æ˜¯é›†æ°£å½ˆ
                    }
                    bossHitFlash = 12; // 0.2ç§’é–ƒçˆ
                    updateBossHealthBar();
                    if (boss.health > 0) {
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            boomAudio.currentTime = 0;
                            boomAudio.volume = VOLUME_BOOM;
                            if (isSfxOn) boomAudio.play();
                        }
                    }
                    bullets.splice(i, 1);
                    score += bullet.isCharge ? 100 : 20;
                    updateScore();
                    if (boss.health <= 0) {
                        boss.health = 0;
                        updateBossHealthBar();
                        bossActive = false;
                        bossDefeated = true;
                        gameRunning = false;
                        enemyBullets.length = 0; // æ–°å¢ï¼šBossæ­»äº¡æ™‚æ¸…ç©ºæ‰€æœ‰æ•µæ–¹å­å½ˆ
                        // åœæ­¢BGM
                        if (bgm) {
                            bgm.pause();
                            bgm.currentTime = 0;
                        }
                        // æ’­æ”¾bossdieéŸ³æ•ˆ
                        const bossdieAudio = document.getElementById('bossdie-audio');
                        if (bossdieAudio) {
                            bossdieAudio.currentTime = 0;
                            bossdieAudio.volume = VOLUME_BOSSDIE;
                            if (isSfxOn) bossdieAudio.play();
                        }
                        // 1. é»ƒç™½é–ƒçˆ2ç§’
                        const flashDiv = document.getElementById('flash-effect');
                        const winScreen = document.getElementById('win-screen');
                        // ===== æ–°å¢ fakeBoss =====
                        fakeBoss = {
                            x: boss.x,
                            y: boss.y,
                            width: boss.width,
                            height: boss.height,
                            color: boss.color
                        };
                        fakeBossFlashFrame = 0;
                        setTimeout(() => { fakeBoss = null; }, 2000);
                        // =========================
                        if (flashDiv) {
                            flashDiv.style.display = 'block';
                            let flashFrame = 0;
                            flashDiv.style.opacity = 1;
                            const flashInterval = setInterval(() => {
                                flashDiv.style.background = (flashFrame % 2 === 0) ? 'rgba(255,255,0,0.7)' : 'rgba(255,255,255,0.7)';
                                flashFrame++;
                            }, 100);
                            setTimeout(() => {
                                clearInterval(flashInterval);
                                // 2. 3ç§’æ¼¸å±¤è®Šå…¨ç™½
                                let opacity = 0.7;
                                flashDiv.style.background = '#fff';
                                const fadeInStep = 0.0067; // 0.0067*20ms*150æ¬¡ â‰ˆ 1
                                const fadeIn = setInterval(() => {
                                    opacity += fadeInStep;
                                    flashDiv.style.opacity = opacity;
                                    if (opacity >= 1) {
                                        clearInterval(fadeIn);
                                        // 3. å…¨ç™½æ™‚æ’­æ”¾outroä¸¦é¡¯ç¤ºå‹åˆ©ç•«é¢ï¼Œå‹åˆ©ç•«é¢opacity=0
                                        // å»¶é²120å¹€ï¼ˆç´„2ç§’ï¼‰å†é¡¯ç¤ºå‹åˆ©ç•«é¢
                                        setTimeout(() => {
                                            winGame();
                                            winScreen.style.opacity = 0;
                                            // æ’­æ”¾outroéŸ³æ¨‚
                                            const outroAudio = document.getElementById('outro-audio');
                                            if (outroAudio) {
                                                outroAudio.currentTime = 0;
                                                outroAudio.volume = VOLUME_OUTRO;
                                                if (isBgmOn) outroAudio.play();
                                            }
                                            // 4. 2ç§’å…§ç™½è‰²é®ç½©æ·¡å‡ºã€å‹åˆ©ç•«é¢åŒæ­¥æ·¡å…¥
                                            let outOpacity = 1;
                                            let winOpacity = 0;
                                            const fadeOut = setInterval(() => {
                                                outOpacity -= 0.02;
                                                winOpacity += 0.02;
                                                flashDiv.style.opacity = outOpacity;
                                                winScreen.style.opacity = winOpacity;
                                                if (outOpacity <= 0) {
                                                    clearInterval(fadeOut);
                                                    flashDiv.style.display = 'none';
                                                    winScreen.style.opacity = 1;
                                                }
                                            }, 20);
                                        }, 90 * (1000 / MAX_FPS)); // 90å¹€å»¶é²
                                    }
                                }, 20);
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                setTimeout(() => { winGame(); }, 90 * (1000 / MAX_FPS)); // 90å¹€å»¶é²
                            }, 3000);
                        }
                    }
                }
            }
            
            // æ›´æ–°æ•µæ–¹å­å½ˆ
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                bullet.x += bullet.speedX;
                bullet.y += bullet.speedY;
                
                // ç§»é™¤å±å¹•å¤–çš„å­å½ˆ
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50 ||
                    bullet.y < camera.y - 50 || bullet.y > camera.y + camera.height + 50) {
                    enemyBullets.splice(i, 1);
                    continue;
                }
                
                // æª¢æ¸¬ç©å®¶ç¢°æ’
                if (checkCollision(bullet, player)) {
                    player.takeDamage(5);
                    enemyBullets.splice(i, 1);
                }
            }
            
            // åœ¨update()æœ€å¾ŒåŠ ä¸ŠbossHitFlashéæ¸›
            if (bossHitFlash > 0) bossHitFlash--;

            // å‹åˆ©ç•«é¢ç„¡æ•µç‹€æ…‹ä¸‹ï¼Œè‹¥ç©å®¶ä¸åœ¨åœ°åœ–å¤–ï¼Œå¼·åˆ¶æ­¸ä½ (0,0)
            if (isWinInvincible) {
                if (!(player.x < 0 || player.x > WORLD_WIDTH || player.y < 0 || player.y > WORLD_HEIGHT)) {
                    player.x = 0;
                    player.y = 0;
                }
            }
        }
        
        // ===== æ¸²æŸ“éŠæˆ² =====
        /**
         * è² è²¬ç¹ªè£½æ‰€æœ‰ç•«é¢å…ƒç´ ï¼ˆèƒŒæ™¯ã€å¹³å°ã€ç©å®¶ã€æ•µäººã€å­å½ˆã€Bossã€UIç­‰ï¼‰
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function render() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ä¿å­˜ç•¶å‰ç‹€æ…‹
            ctx.save();
            
            // æ‡‰ç”¨é¡é ­è®Šæ›
            ctx.translate(-camera.x, -camera.y);
            
            // ç¹ªè£½èƒŒæ™¯ (ç°¡å–®çš„æ˜Ÿç©ºæ•ˆæœ)
            ctx.fillStyle = '#112';
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
            
            // ç¹ªè£½æ˜Ÿæ˜Ÿ
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 24 + (camera.x / 2)) % WORLD_WIDTH;
                const y = (i * 19 + (camera.y / 2)) % WORLD_HEIGHT;
                const size = 1 + (i % 3);
                ctx.fillRect(x, y, size, size);
            }
            
            // ç¹ªè£½å¹³å°
            platforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });
            
            // ç¹ªè£½ç©å®¶ (ç„¡æ•µæ™‚é–ƒçˆ)
            if (!playerDead) { // æ­»äº¡æ™‚ä¸ç¹ªè£½
                if (isWinInvincible) {
                    ctx.globalAlpha = 0.2;
                }
                if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                    if (Math.floor(Date.now() / 100) % 2 === 0) {
                        ctx.fillStyle = '#cfbb3a'; // æ·ºé»ƒè‰²
                    } else {
                        ctx.fillStyle = player.color;
                    }
                } else {
                    ctx.fillStyle = player.color;
                }
                if (player.invincible <= 0 || Math.floor(player.invincible / 5) % 2 === 0) {
                    ctx.fillRect(player.x, player.y, player.width, player.height);
                    // åªç•«å¤§çœ¼ç™½ï¼Œä¸ç•«çœ¼ç 
                    ctx.beginPath();
                    if (player.direction === 1) {
                        ctx.ellipse(player.x + player.width - 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                    } else {
                        ctx.ellipse(player.x + 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
            }
            
            // ç¹ªè£½å­å½ˆ
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                if (bullet.isCharge) {
                    ctx.save();
                    ctx.shadowColor = '#ff0';
                    ctx.shadowBlur = 20;
                    // é›†æ°£å½ˆï¼šä¸Šä¸‹çª„çš„æ©¢åœ“
                    ctx.beginPath();
                    ctx.ellipse(
                        bullet.x + bullet.width / 2,
                        bullet.y + bullet.height / 2,
                        bullet.width / 2,
                        bullet.height / 1.5,
                        0, 0, Math.PI * 2
                    );
                    ctx.fill();
                    ctx.restore();
                } else {
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // ç¹ªè£½æ•µäºº
            enemies.forEach(enemy => {
                // é–ƒçˆæ•ˆæœ
                if (enemyHitFlash.has(enemy)) {
                    if (Math.floor(Date.now() / 50) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
                if (enemy.isFlying) {
                    // é£›è¡Œæ•µäººï¼šåœ“å½¢
                    ctx.save();
                    ctx.beginPath();
                    ctx.ellipse(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, enemy.height/2, 0, 0, Math.PI*2);
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // çœ¼ç›ï¼ˆæ©¢åœ“å³å‰æ–¹ï¼‰
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.75, enemy.y + enemy.height/2, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                } else {
                    // è·¯é¢æ•µäººï¼šåŠåœ“ï¼ˆæœå³ï¼‰
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height, enemy.width/2, Math.PI, 0, false);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x, enemy.y + enemy.height);
                    ctx.closePath();
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // çœ¼ç›ï¼ˆå·¦å‰æ–¹ï¼‰
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.25, enemy.y + enemy.height*0.75, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                }
                ctx.globalAlpha = 1;
                // åœ¨ render() ç¹ªè£½æ•µäººæ™‚ï¼Œè‹¥ enemy.dyingï¼Œæ ¹æ“š dyingFrame é–ƒçˆ
                if (enemy.dying) {
                    if (Math.floor(enemy.dyingFrame / 6) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
            });
            
            // ç¹ªè£½Boss
            if (bossActive && !isWinScreen) {
                if (bossHitFlash > 0) {
                    if (boss.lastHitCharge) {
                        // é›†æ°£å½ˆï¼šé»ƒç™½é–ƒçˆ
                        ctx.globalAlpha = 1;
                        ctx.save();
                        if (Math.floor(Date.now() / 50) % 2 === 0) {
                            ctx.filter = 'brightness(1.5) sepia(1) hue-rotate(60deg)'; // é»ƒè‰²
                        } else {
                            ctx.filter = 'brightness(2)'; // ç™½è‰²
                        }
                    } else {
                        // æ™®é€šå½ˆï¼šåŸæœ¬çš„é€æ˜é–ƒçˆ
                        if (Math.floor(Date.now() / 50) % 2 === 0) {
                            ctx.globalAlpha = 0.3;
                        } else {
                            ctx.globalAlpha = 1;
                        }
                    }
                }
                // ä¸»é«”ï¼šåœ“è§’çŸ©å½¢
                const r = 28; // åœ“è§’åŠå¾‘
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y);
                ctx.lineTo(boss.x + boss.width - r, boss.y);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y, boss.x + boss.width, boss.y + r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + r);
                ctx.quadraticCurveTo(boss.x, boss.y, boss.x + r, boss.y);
                ctx.closePath();
                ctx.fillStyle = boss.color;
                ctx.fill();
                // åº•ä¸‹1/5ç‚ºæ›´é®®æ˜çš„é»ƒè‰²
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y + boss.height * 0.8);
                ctx.lineTo(boss.x + boss.width - r, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height * 0.8, boss.x + boss.width, boss.y + boss.height - r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height * 0.8, boss.x + r, boss.y + boss.height * 0.8);
                ctx.closePath();
                ctx.fillStyle = '#ffd600'; // æ›´é®®æ˜çš„é»ƒè‰²
                ctx.fill();
                ctx.restore();
                // çœ¼ç›ï¼ˆä¸Šæ–¹å…©å€‹ï¼Œç™½è‰²çœ¼ç™½ã€ç´…è‰²çœ¼ç ï¼‰
                // å·¦çœ¼
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // å³çœ¼
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // é¢¨æ‰‡ï¼ˆé»ƒè‰²åœ“å½¢ï¼‰
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 20, 0, Math.PI*2);
                ctx.fillStyle = '#ffe082'; // é»ƒè‰²
                ctx.fill();
                // é¢¨æ‰‡ä¸­å¿ƒ
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 7, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.restore();
                ctx.globalAlpha = 1;
                // boss ç¹ªè£½çµæŸå¾Œæ¢å¾© filter
                if (bossHitFlash > 0 && boss.lastHitCharge) {
                    ctx.restore();
                }
                ctx.globalAlpha = 1;
            }
            // ===== æ–°å¢ fakeBoss é–ƒçˆæ•ˆæœ =====
            if (fakeBoss) {
                fakeBossFlashFrame++;
                ctx.save();
                if (Math.floor(fakeBossFlashFrame / 6) % 2 === 0) {
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = "#fff";
                } else {
                    ctx.globalAlpha = 0.2;
                    ctx.fillStyle = fakeBoss.color;
                }
                // ä¸»é«”ï¼šåœ“è§’çŸ©å½¢
                const r = 28;
                ctx.beginPath();
                ctx.moveTo(fakeBoss.x + r, fakeBoss.y);
                ctx.lineTo(fakeBoss.x + fakeBoss.width - r, fakeBoss.y);
                ctx.quadraticCurveTo(fakeBoss.x + fakeBoss.width, fakeBoss.y, fakeBoss.x + fakeBoss.width, fakeBoss.y + r);
                ctx.lineTo(fakeBoss.x + fakeBoss.width, fakeBoss.y + fakeBoss.height - r);
                ctx.quadraticCurveTo(fakeBoss.x + fakeBoss.width, fakeBoss.y + fakeBoss.height, fakeBoss.x + fakeBoss.width - r, fakeBoss.y + fakeBoss.height);
                ctx.lineTo(fakeBoss.x + r, fakeBoss.y + fakeBoss.height);
                ctx.quadraticCurveTo(fakeBoss.x, fakeBoss.y + fakeBoss.height, fakeBoss.x, fakeBoss.y + fakeBoss.height - r);
                ctx.lineTo(fakeBoss.x, fakeBoss.y + r);
                ctx.quadraticCurveTo(fakeBoss.x, fakeBoss.y, fakeBoss.x + r, fakeBoss.y);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
            
            // ç¹ªè£½æ•µæ–¹å­å½ˆ
            enemyBullets.forEach(bullet => {
                // Bosså­å½ˆï¼ˆtornadoï¼‰
                if (bullet.color === '#f4a') {
                    const tornadoImg = document.getElementById('tornado-img');
                    if (tornadoImg && tornadoImg.complete) {
                        ctx.save();
                        // æ—‹è½‰æ–¹å‘
                        const angle = Math.atan2(bullet.speedY, bullet.speedX);
                        ctx.translate(bullet.x + 3.4125, bullet.y + 13.65); // 6.825x27.3ä¸­å¿ƒ
                        ctx.rotate(angle + Math.PI);
                        ctx.drawImage(tornadoImg, -5, -5, 30, 30); //é¾æ²é¢¨å°ºå¯¸
                        ctx.restore();
                    } else {
                        ctx.fillStyle = bullet.color;
                        ctx.fillRect(bullet.x, bullet.y, 10, 20);
                    }
                } else {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // æ¢å¾©ç‹€æ…‹
            ctx.restore();
            
            // ç¹ªè£½UI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // èª¿è©¦ä¿¡æ¯
            cameraDebugElement.textContent = `moved: (${Math.floor(camera.x)})`;
            cameraDebugElement.style.display = showMoved == 1 ? 'block' : 'none';
        }
        
        // ===== å·¥å…·å‡½æ•¸ =====
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                    a.x + a.width > b.x &&
                    a.y < b.y + b.height &&
                    a.y + a.height > b.y;
        }
        
        /**
         * æ›´æ–°ç©å®¶è¡€æ¢é¡¯ç¤º
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function updateHealthBar() {
            const percent = (playerHealth / playerMaxHealth) * 100;
            healthFill.style.width = `${percent}%`;
            if (percent <= 20) {
                healthFill.style.backgroundColor = '#f44'; // ç´…è‰²
            } else {
                healthFill.style.backgroundColor = '#4af'; // è—è‰²
            }
        }
        
        /**
         * æ›´æ–°Bossè¡€æ¢é¡¯ç¤º
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function updateBossHealthBar() {
            if (window.bossHpAnimating) return;
            const percent = (boss.health / boss.maxHealth) * 100;
            bossHealthFill.style.width = `${percent}%`;
        }
        
        /**
         * æ›´æ–°åˆ†æ•¸é¡¯ç¤º
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function updateScore() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                scoreDiv.textContent = `score: ${score}`;
                scoreDiv.style.display = showScore == 1 ? 'block' : 'none';
            }
        }
        
        /**
         * è™•ç†éŠæˆ²çµæŸï¼ˆGame Overï¼‰ç•«é¢èˆ‡éŸ³æ•ˆ
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function gameOver() {
            gameRunning = false;
            playerDeadX = player.x; // è¨˜éŒ„æ­»äº¡æ™‚ä½ç½®
            playerDeadY = player.y;
            playerDead = true; // è¨­ç‚ºæ­»äº¡ç‹€æ…‹
            finalScoreElement.textContent = `score: ${score}`;
            gameOverScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // åœæ­¢BGMä¸¦æ’­æ”¾Game OveréŸ³æ•ˆ
            if (bgm) {
                bgm.pause();
                bgm.currentTime = 0;
            }
            const gameOverAudio = document.getElementById('game-over-audio');
            if (gameOverAudio) {
                gameOverAudio.currentTime = 0;
                gameOverAudio.volume = VOLUME_GAMEOVER;
                if (isSfxOn) gameOverAudio.play();
            }
        }
        
        /**
         * è™•ç†å‹åˆ©ç•«é¢èˆ‡éŸ³æ•ˆ
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function winGame() {
            bossActive = false;
            // å°‡ç©å®¶ç§»å‡ºç•«é¢
            player.x = -9999;
            player.y = -9999;
            gameRunning = false;
            isWinInvincible = true;
            if (currentLang === 'zh') {
                winScoreElement.innerHTML = '<div style="font-size:80%">score: åˆ†æ•¸é«˜åˆ°ç„¡æ³•è¨ˆç®—</div>';
            } else if (currentLang === 'ja') {
                winScoreElement.innerHTML = '<div style="font-size:80%">score: å›ã®ã‚¹ã‚³ã‚¢ã¯é«˜ã™ãã¦è¨ˆç®—ã§ããªã„ã€‚</div>';
            } else {
                winScoreElement.innerHTML = '<div style="font-size:80%">score: Your score is incalculably high.</div>';
            }
            winScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // æ’­æ”¾å‹åˆ©éŸ³æ¨‚
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                if (isBgmOn) outroAudio.play();
                // ç¢ºä¿onendedäº‹ä»¶è¨­ç½®
                outroAudio.onended = function() {
                    setTimeout(() => {
                        outroAudio.currentTime = 0;
                        if (isBgmOn) outroAudio.play();
                    }, 1000);
                };
            }
            winScoreElement.innerHTML = LANGUAGES[currentLang].winScore;
            playAgainButton.textContent = LANGUAGES[currentLang].playagain;
        }
        
        // ===== èªè¨€è³‡æ–™ =====
        const LANGUAGES = {
            zh: {
                title: 'å¥§å¤åƒè¬å¥§å¤åƒè¬',
                shoot: 'ç©ºç™½éµ å°„æ“Š',
                move: ' â† â†’ ç§»å‹•',
                jump: ' â†‘ è·³èº',
                start: 'START',
                gameover: 'ä½•å›ã‚„ã£ã¦ã‚‚ã€€ä½•å›ã‚„ã£ã¦ã‚‚ã€€ã‚¨ã‚¢ãƒ¼ã¾ã‚“ãŒ...',
                retry: 'å†trytry',
                win: '<div style="font-size:80%">å‘½é‹è©¦åœ–é˜»æ­¢ä½ ...</div><div style="font-size:80%">ä½†ä½ æˆ°å‹äº†ï¼</div><div style="font-size:80%">è«‹ç›¸ä¿¡è‡ªå·±ï¼</div><div style="font-size:80%">ä¸ç®¡å¤šå¤§å›°é›£ï¼ä½ éƒ½èƒ½å…‹æœï¼</div>',
                winScore: '<div style="font-size:95%">SCORE: ç„¡äººèƒ½å®šç¾©ä½ çš„åˆ†æ•¸ï¼Œé‚£äº›çœ‹ä¸è¦‹çš„åŠªåŠ›ï¼Œæ‰æ˜¯ä½ æœ€çœŸå¯¦çš„å¯¦åŠ›!</div>',
                playagain: 'ä½ æƒ³å†ç©ä¸€æ¬¡ä¹Ÿæ˜¯å¯ä»¥...',
                // Settings å¤šèªè¨€
                settings: {
                    title: 'è¨­å®šé¸å–®',
                    selectLang: 'é¸æ“‡èªè¨€',
                    music: 'éŸ³æ¨‚',
                    sfx: 'éŸ³æ•ˆ',
                    startX: 'èµ·å§‹ X',
                    startY: 'èµ·å§‹ Y',
                    moveSpeed: 'ç©å®¶ç§»å‹•é€Ÿåº¦',
                    weaponPower: 'æ­¦å™¨æ”»æ“ŠåŠ›',
                    maxFps: 'æœ€å¤§ FPS',
                    gravity: 'é‡åŠ›',
                    jumpPower: 'è·³èºåˆé€Ÿåº¦',
                    jumpExtra: 'è·³èºé¡å¤–åŠ é€Ÿåº¦',
                    jumpExtraFrames: 'è·³èºé¡å¤–åŠ é€Ÿå¹€æ•¸',
                    showScore: 'é¡¯ç¤ºåˆ†æ•¸',
                    showMoved: 'é¡¯ç¤ºç§»å‹•',
                    showFps: 'é¡¯ç¤º FPS',
                    showXy: 'é¡¯ç¤º XY',
                    showNxy: 'é¡¯ç¤ºæ ¼æ•¸åº§æ¨™',
                    showEntityCounts: 'é¡¯ç¤ºç‰©ä»¶æ•¸é‡',
                    showMobileTouch: 'é¡¯ç¤ºæ‰‹æ©Ÿè§¸æ§',
                    ok: 'ç¢ºå®š'
                }
            },
            ja: {
                title: 'å„„åƒä¸‡å„„åƒä¸‡',
                shoot: 'ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ ã‚·ãƒ§ãƒƒãƒˆ',
                move: ' â† â†’ ã‚­ãƒ¼ ç§»å‹•',
                jump: 'â†‘ ã‚­ãƒ¼ ã‚¸ãƒ£ãƒ³ãƒ—',
                start: 'ã‚¹ã‚¿ãƒ¼ãƒˆ',
                gameover: 'ä½•å›ã‚„ã£ã¦ã‚‚ã€€ä½•å›ã‚„ã£ã¦ã‚‚ã€€ã‚¨ã‚¢ãƒ¼ã¾ã‚“ãŒ...',
                retry: 'ã‚‚ã†ä¸€åº¦',
                win: '<div style="font-size:80%">é‹å‘½ã¯å›ã‚’æ­¢ã‚ãŸãŒã€</div><div style="font-size:80%">å›ãŒå‹ã£ãŸï¼</div><div style="font-size:80%">è‡ªåˆ†ã‚’ä¿¡ã˜ã¦ï¼</div><div style="font-size:80%">ã©ã‚“ãªå›°é›£ã§ã‚‚å¿…ãšä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã‚‹ï¼</div>',
                winScore: '<div style="font-size:95%">SCORE: å›ã®ä¾¡å€¤ã‚’ç‚¹æ•°ã§æ±ºã‚ã‚‰ã‚Œã‚‹ã‚ã‘ãŒãªã„ï¼</div>',
                playagain: 'ã‚‚ã†ä¸€åº¦éŠã³ã¾ã™ã‹ï¼Ÿ',
                settings: {
                    title: 'è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼',
                    selectLang: 'è¨€èªã‚’é¸æŠ',
                    music: 'éŸ³æ¥½',
                    sfx: 'åŠ¹æœéŸ³',
                    startX: 'é–‹å§‹ X',
                    startY: 'é–‹å§‹ Y',
                    moveSpeed: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹•é€Ÿåº¦',
                    weaponPower: 'æ­¦å™¨ãƒ‘ãƒ¯ãƒ¼',
                    maxFps: 'æœ€å¤§ FPS',
                    gravity: 'é‡åŠ›',
                    jumpPower: 'ã‚¸ãƒ£ãƒ³ãƒ—åˆé€Ÿåº¦',
                    jumpExtra: 'ã‚¸ãƒ£ãƒ³ãƒ—è¿½åŠ åŠ é€Ÿåº¦',
                    jumpExtraFrames: 'ã‚¸ãƒ£ãƒ³ãƒ—è¿½åŠ ãƒ•ãƒ¬ãƒ¼ãƒ ',
                    showScore: 'ã‚¹ã‚³ã‚¢è¡¨ç¤º',
                    showMoved: 'ç§»å‹•è¡¨ç¤º',
                    showFps: 'FPSè¡¨ç¤º',
                    showXy: 'XYè¡¨ç¤º',
                    showNxy: 'ã‚°ãƒªãƒƒãƒ‰åº§æ¨™è¡¨ç¤º',
                    showEntityCounts: 'ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ•°è¡¨ç¤º',
                    showMobileTouch: 'ãƒ¢ãƒã‚¤ãƒ«ã‚¿ãƒƒãƒè¡¨ç¤º',
                    ok: 'OK'
                }
            },
            en: {
                title: 'Mega AI',
                shoot: 'Press SPACE to Shoot',
                move: 'Press â† â†’ to Move',
                jump: 'Press â†‘ to Jump',
                start: 'START',
                gameover: 'The Untouchable Airman',
                retry: 'Retry',
                win: '<div style="font-size:80%">Fate tried to stop you...</div><div style="font-size:80%">but you prevailed !</div><div style="font-size:80%">Believe in yourself !</div><div style="font-size:80%">And overcome any difficulty !</div>',
                winScore: '<div style="font-size:95%">SCORE: Scores are for tests. You\'re not a test-you\'re a force.</div>',
                playagain: 'Play again?',
                settings: {
                    title: 'Settings',
                    selectLang: 'Select Language',
                    music: 'Music',
                    sfx: 'Effects Sound',
                    startX: 'Start X',
                    startY: 'Start Y',
                    moveSpeed: 'Player Move Speed',
                    weaponPower: 'Weapon Power',
                    maxFps: 'Max FPS',
                    gravity: 'Gravity',
                    jumpPower: 'Jump Power',
                    jumpExtra: 'Jump Extra',
                    jumpExtraFrames: 'Jump Extra Frames',
                    showScore: 'Show Score',
                    showMoved: 'Show Moved',
                    showFps: 'Show FPS',
                    showXy: 'Show XY',
                    showNxy: 'Show NXY',
                    showEntityCounts: 'Show Entity Counts',
                    showMobileTouch: 'Show Mobile Touch',
                    ok: 'OK'
                }
            }
        };
        let currentLang = localStorage.getItem('lang') || 'zh';
        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            const L = LANGUAGES[lang];
            document.querySelector('#start-screen h1').textContent = L.title;
            document.querySelectorAll('#start-screen p')[0].textContent = L.shoot;
            document.querySelectorAll('#start-screen p')[1].textContent = L.move;
            document.querySelectorAll('#start-screen p')[2].textContent = L.jump;
            startButton.textContent = L.start;
            document.querySelector('#game-over-screen h1').textContent = L.gameover;
            restartButton.textContent = L.retry;
            document.querySelector('#win-screen h1').innerHTML = L.win;
            winScoreElement.innerHTML = L.winScore;
            playAgainButton.textContent = L.playagain;
        }
        // ===== èªè¨€é¸æ“‡UI =====
        const langSelect = document.getElementById('language-select');
        const langToggle = document.getElementById('lang-toggle');
        langToggle.onclick = () => {
            langSelect.style.display = (langSelect.style.display === 'flex') ? 'none' : 'flex';
        };
        document.getElementById('lang-zh').onclick = () => { setLang('zh'); langSelect.style.display = 'none'; updateSettingsPanelLang(); };
        document.getElementById('lang-ja').onclick = () => { setLang('ja'); langSelect.style.display = 'none'; updateSettingsPanelLang(); };
        document.getElementById('lang-en').onclick = () => { setLang('en'); langSelect.style.display = 'none'; updateSettingsPanelLang(); };
        // é è¨­èªè¨€
        window.addEventListener('DOMContentLoaded', () => {
            setLang(currentLang);
            langSelect.style.display = 'none';
            langToggle.style.display = 'block';
            updateSettingsPanelLang();
        });
        
        // ===== è§¸æ§æ“ä½œæ¨¡æ“¬éµç›¤ =====
        /**
         * æ–°å¢è§¸æ§æŒ‰éˆ•äº‹ä»¶ï¼Œæ¨¡æ“¬å°æ‡‰éµç›¤äº‹ä»¶
         * @param {string} btnId - æŒ‰éˆ•çš„DOM id
         * @param {string} key - å°æ‡‰çš„éµç›¤keyå€¼
         */
        function addTouchBtnEvent(btnId, key) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            // è§¸æ§
            btn.addEventListener('touchstart', e => { if (e.cancelable) e.preventDefault(); simulateKey(key, true); });
            btn.addEventListener('touchend',   e => { if (e.cancelable) e.preventDefault(); simulateKey(key, false); });
            // æ»‘é¼ 
            btn.addEventListener('mousedown',  e => { e.preventDefault(); simulateKey(key, true); });
            btn.addEventListener('mouseup',    e => { e.preventDefault(); simulateKey(key, false); });
            btn.addEventListener('mouseleave', e => { simulateKey(key, false); });
        }
        addTouchBtnEvent('btn-left',  'ArrowLeft');
        addTouchBtnEvent('btn-right', 'ArrowRight');
        addTouchBtnEvent('btn-jump',  'ArrowUp');
        addTouchBtnEvent('btn-shoot', ' ');
        
        /**
         * æ ¹æ“šè¦–çª—å¤§å°è‡ªå‹•ç¸®æ”¾éŠæˆ²ç•«é¢
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function resizeGame() {
            const baseWidth = 800;
            const baseHeight = 500;
            const scaleX = window.innerWidth / baseWidth;
            const scaleY = window.innerHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY);

            const wrapper = document.getElementById('game-wrapper');
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.transformOrigin = 'top left';
            wrapper.style.position = 'absolute';
            wrapper.style.left = `calc(50vw - ${(baseWidth * scale) / 2}px)`;
            wrapper.style.top = `calc(50vh - ${(baseHeight * scale) / 2}px)`;
            wrapper.style.width = baseWidth + 'px';
            wrapper.style.height = baseHeight + 'px';
        }
        window.addEventListener('resize', resizeGame);
        window.addEventListener('DOMContentLoaded', resizeGame);

        // ===== FPS è¨ˆç®—èˆ‡é¡¯ç¤º =====
        let lastFPSTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        /**
         * FPSè¨ˆç®—èˆ‡é¡¯ç¤ºï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡
         * ç„¡åƒæ•¸ï¼Œç„¡å›å‚³å€¼
         */
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastFPSTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFPSTime = now;
                const fpsDiv = document.getElementById('fps-display');
                if (fpsDiv) {
                    fpsDiv.textContent = `FPS: ${fps}`;
                    fpsDiv.style.display = showFPS == 1 ? 'block' : 'none';
                }
            }
            // æ¯å¹€æ›´æ–°ç©å®¶åº§æ¨™
            const xy = document.getElementById('xy-display');
            if (xy) {
                xy.textContent = `X: ${Math.round(player.x)}, Y: ${Math.round(player.y)}`;
                xy.style.display = showXY == 1 ? 'block' : 'none';
            }
            // æ¯å¹€æ›´æ–°ç©å®¶æ ¼æ•¸åº§æ¨™
            const nxy = document.getElementById('nxy-display');
            if (nxy) {
                const nx = Math.floor(player.x / 50);
                const ny = Math.floor((500 - player.y) / 50);
                nxy.textContent = `NX: ${nx}, NY: ${ny}`;
                nxy.style.display = showNXY == 1 ? 'block' : 'none';
            }
            // æ¯å¹€æ›´æ–°æ•¸é‡è³‡è¨Š
            const entityCounts = document.getElementById('entity-counts');
            if (entityCounts) {
                const bossCount = bosses.filter(b => b && bossActive).length;
                entityCounts.textContent = `P: ${players.length}, PS: ${bullets.length}, E: ${enemies.length}, ES: ${enemyBullets.length}, B: ${bossCount}`;
                entityCounts.style.display = showEntityCounts == 1 ? 'block' : 'none';
            }
        }

        // ===== ç©å®¶é£›è¡Œæ¨¡å¼ =====
        let isFlyingMode = 0; // é è¨­é—œé–‰

        let isWinScreen = false;
        let bossDefeated = false;

        // ====== è¨­å®šé¢æ¿ ======
        // 1. æ–°å¢è¨­å®šæŒ‰éˆ•
        const settingsBtn = document.createElement('div');
        settingsBtn.id = 'settings-btn';
        settingsBtn.style.position = 'absolute';
        settingsBtn.style.right = '10px';
        settingsBtn.style.bottom = '6px'; // è¨­å®šæŒ‰éˆ•é«˜åº¦
        settingsBtn.style.width = '45px';
        settingsBtn.style.height = '45px';
        settingsBtn.style.borderRadius = '50%';
        settingsBtn.style.background = '#333a';
        settingsBtn.style.color = '#fff';
        settingsBtn.style.boxShadow = '0 2px 8px #0006';
        settingsBtn.style.display = 'flex';
        settingsBtn.style.alignItems = 'center';
        settingsBtn.style.justifyContent = 'center';
        settingsBtn.style.cursor = 'pointer';
        settingsBtn.style.userSelect = 'none';
        settingsBtn.style.zIndex = 1000;
        settingsBtn.style.fontSize = '22px';
        settingsBtn.innerHTML = '<span style="font-size:22px;font-weight:bold;line-height:45px;display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:#fff;">âš™ï¸</span>';
        document.getElementById('game-wrapper').appendChild(settingsBtn);

        // 2. æ–°å¢è¨­å®šé¢æ¿
        const settingsPanel = document.createElement('div');
        settingsPanel.id = 'settings-panel';
        settingsPanel.style.position = 'fixed';
        settingsPanel.style.left = '50%';
        settingsPanel.style.top = '50%';
        settingsPanel.style.transform = 'translate(-50%, -50%)';
        settingsPanel.style.background = '#222';
        settingsPanel.style.color = '#fff';
        settingsPanel.style.padding = '32px 32px 24px 32px';
        settingsPanel.style.borderRadius = '16px';
        settingsPanel.style.boxShadow = '0 4px 32px #000a';
        settingsPanel.style.zIndex = 2000;
        settingsPanel.style.display = 'none';
        settingsPanel.style.minWidth = '320px';
        settingsPanel.innerHTML = `

            <div style="height:20px;"></div>

            <h2 style="margin-top:0;margin-bottom:18px;font-size:22px;text-align:center;">Settings</h2>

            <div style="margin-bottom:16px; display: flex; align-items: center; position:relative;">
                <div id="settings-lang-label" style="font-size:14px;min-width:80px; margin-right: 8px;display:flex;align-items:center;height:20px;">
                    é¸æ“‡èªè¨€
                </div>
                <div id="custom-lang-select-wrapper" style="position:relative;display:flex;align-items:center;height:20px;">
                    <button id="custom-lang-select-btn" style="font-size:14px;padding:2px 10px;border-radius:6px;background:#fff;color:#222;border:1px solid #888;min-width:60px;text-align:left;height:20px;display:flex;align-items:center;">ä¸­æ–‡ â–¼</button>
                    <ul id="custom-lang-select-list" style="display:none;position:absolute;top:110%;left:0;width:100%;background:#222;border-radius:8px;box-shadow:0 2px 12px #0008;z-index:9999;padding:0;margin:0;list-style:none;font-size:14px;">
                        <li data-lang="zh" style="padding:6px 10px;cursor:pointer;color:#fff">ä¸­æ–‡</li>
                        <li data-lang="ja" style="padding:6px 10px;cursor:pointer;color:#fff">æ—¥æœ¬èª</li>
                        <li data-lang="en" style="padding:6px 10px;cursor:pointer;color:#fff">English</li>
                    </ul>
                </div>
            </div>


            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-bgm-on"> Muisc</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-sfx-on"> Effects Sound</label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Start X <input id="setting-start-x" type="number" min="0" max="5400" step="1" style="width:60px;"> </label>
                <label style="margin-left:16px;">Start Y <input id="setting-start-y" type="number" min="0" max="500" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Player Move Speed <input id="setting-move-speed" type="number" min="1" max="100" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Weapon Power <input id="setting-weapon-power" type="number" min="1" max="20" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Max FPS <input id="setting-max-fps" type="number" min="10" max="240" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Gravity <input id="setting-gravity" type="number" min="0.1" max="10" step="0.1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Jump Power <input id="setting-jump-power" type="number" min="-50" max="0" step="0.1" style="width:80px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Jump Extra <input id="setting-jump-extra" type="number" min="-5" max="0" step="0.01" style="width:80px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Jump Extra Frames <input id="setting-jump-extra-frames" type="number" min="1" max="60" step="1" style="width:80px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-show-score"> Show Score</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-moved"> Show Moved</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-fps"> Show FPS</label>
            </div>

            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-show-xy"> Show XY</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-nxy"> Show NXY</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-entity-counts"> Show Entity Counts</label>
            </div>

            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-show-mobile-touch"> Show Mobile Touch</label>
            </div>
            
            <div style="text-align:center;margin-top:18px;">
                <button id="settings-close-btn" style="padding:6px 24px;font-size:16px;background:#4af;color:#fff;border:none;border-radius:6px;">OK</button>
            </div>

            <div style="height:20px;"></div>

        `;
        document.body.appendChild(settingsPanel);

        // 3. è¨­å®šæŒ‰éˆ•äº‹ä»¶
        settingsBtn.onclick = function() {
            // å…ˆå–å¾—æ‰€æœ‰ input
            var bgmOnInput = document.getElementById('setting-bgm-on');
            var sfxOnInput = document.getElementById('setting-sfx-on');
            var moveSpeedInput = document.getElementById('setting-move-speed');
            var weaponPowerInput = document.getElementById('setting-weapon-power');
            var maxFpsInput = document.getElementById('setting-max-fps');
            var gravityInput = document.getElementById('setting-gravity');
            var jumpPowerInput = document.getElementById('setting-jump-power');
            var jumpExtraInput = document.getElementById('setting-jump-extra');
            var jumpExtraFramesInput = document.getElementById('setting-jump-extra-frames');
            var showScoreInput = document.getElementById('setting-show-score');
            var showMovedInput = document.getElementById('setting-show-moved');
            var showFpsInput = document.getElementById('setting-show-fps');
            var showXYInput = document.getElementById('setting-show-xy');
            var showNXYInput = document.getElementById('setting-show-nxy');
            var showEntityCountsInput = document.getElementById('setting-entity-counts');
            var showMobileTouchInput = document.getElementById('setting-show-mobile-touch');
            var startXInput = document.getElementById('setting-start-x');
            var startYInput = document.getElementById('setting-start-y');
            if (settingsPanel.style.display === 'block') {
                if (bgmOnInput) isBgmOn = bgmOnInput.checked ? 1 : 0;
                if (sfxOnInput) isSfxOn = sfxOnInput.checked ? 1 : 0;
                if (moveSpeedInput) playerMoveSpeed = parseInt(moveSpeedInput.value) || 1;
                if (weaponPowerInput) weaponPower = parseInt(weaponPowerInput.value) || 1;
                if (maxFpsInput) MAX_FPS = parseInt(maxFpsInput.value) || 10;
                if (gravityInput) GRAVITY = parseFloat(gravityInput.value) || 1;
                if (jumpPowerInput) JUMP_POWER = parseFloat(jumpPowerInput.value) || -11.5*1.3;
                if (jumpExtraInput) JUMP_EXTRA = parseFloat(jumpExtraInput.value) || -0.35*1.3;
                if (jumpExtraFramesInput) JUMP_EXTRA_FRAMES = parseInt(jumpExtraFramesInput.value) || 12;
                if (showScoreInput) showScore = showScoreInput.checked ? 1 : 0;
                if (showMovedInput) showMoved = showMovedInput.checked ? 1 : 0;
                if (showFpsInput) showFPS = showFpsInput.checked ? 1 : 0;
                if (showXYInput) showXY = showXYInput.checked ? 1 : 0;
                if (showNXYInput) showNXY = showNXYInput.checked ? 1 : 0;
                if (showEntityCountsInput) showEntityCounts = showEntityCountsInput.checked ? 1 : 0;
                if (showMobileTouchInput) showMobileTouch = showMobileTouchInput.checked ? 1 : 0;
                settingsPanel.style.display = 'none';
                isPaused = false;
                if (startXInput) startx = parseInt(startXInput.value) || 0;
                if (startYInput) starty = parseInt(startYInput.value) || 0;
            } else {
                if (bgmOnInput) bgmOnInput.checked = !!isBgmOn;
                if (sfxOnInput) sfxOnInput.checked = !!isSfxOn;
                if (moveSpeedInput) moveSpeedInput.value = playerMoveSpeed;
                if (weaponPowerInput) weaponPowerInput.value = weaponPower;
                if (maxFpsInput) maxFpsInput.value = MAX_FPS;
                if (gravityInput) gravityInput.value = GRAVITY;
                if (jumpPowerInput) jumpPowerInput.value = JUMP_POWER;
                if (jumpExtraInput) jumpExtraInput.value = JUMP_EXTRA;
                if (jumpExtraFramesInput) jumpExtraFramesInput.value = JUMP_EXTRA_FRAMES;
                if (showScoreInput) showScoreInput.checked = !!showScore;
                if (showMovedInput) showMovedInput.checked = !!showMoved;
                if (showFpsInput) showFpsInput.checked = !!showFPS;
                if (showXYInput) showXYInput.checked = !!showXY;
                if (showNXYInput) showNXYInput.checked = !!showNXY;
                if (showEntityCountsInput) showEntityCountsInput.checked = !!showEntityCounts;
                if (showMobileTouchInput) showMobileTouchInput.checked = !!showMobileTouch;
                settingsPanel.style.display = 'block';
                isPaused = true;
                if (startXInput) startXInput.value = startx;
                if (startYInput) startYInput.value = starty;
            }
        };
        var settingsCloseBtn = document.getElementById('settings-close-btn');
        if (settingsCloseBtn) {
            settingsCloseBtn.onclick = function() {
                var bgmOnInput = document.getElementById('setting-bgm-on');
                var sfxOnInput = document.getElementById('setting-sfx-on');
                var moveSpeedInput = document.getElementById('setting-move-speed');
                var weaponPowerInput = document.getElementById('setting-weapon-power');
                var maxFpsInput = document.getElementById('setting-max-fps');
                var gravityInput = document.getElementById('setting-gravity');
                var jumpPowerInput = document.getElementById('setting-jump-power');
                var jumpExtraInput = document.getElementById('setting-jump-extra');
                var jumpExtraFramesInput = document.getElementById('setting-jump-extra-frames');
                var showScoreInput = document.getElementById('setting-show-score');
                var showMovedInput = document.getElementById('setting-show-moved');
                var showFpsInput = document.getElementById('setting-show-fps');
                var showXYInput = document.getElementById('setting-show-xy');
                var showNXYInput = document.getElementById('setting-show-nxy');
                var showEntityCountsInput = document.getElementById('setting-entity-counts');
                var showMobileTouchInput = document.getElementById('setting-show-mobile-touch');
                var startXInput = document.getElementById('setting-start-x');
                var startYInput = document.getElementById('setting-start-y');
                if (bgmOnInput) isBgmOn = bgmOnInput.checked ? 1 : 0;
                if (sfxOnInput) isSfxOn = sfxOnInput.checked ? 1 : 0;
                if (moveSpeedInput) playerMoveSpeed = parseInt(moveSpeedInput.value) || 1;
                if (weaponPowerInput) weaponPower = parseInt(weaponPowerInput.value) || 1;
                if (maxFpsInput) MAX_FPS = parseInt(maxFpsInput.value) || 10;
                if (gravityInput) GRAVITY = parseFloat(gravityInput.value) || 1;
                if (jumpPowerInput) JUMP_POWER = parseFloat(jumpPowerInput.value) || -11.5*1.3;
                if (jumpExtraInput) JUMP_EXTRA = parseFloat(jumpExtraInput.value) || -0.35*1.3;
                if (jumpExtraFramesInput) JUMP_EXTRA_FRAMES = parseInt(jumpExtraFramesInput.value) || 12;
                if (showScoreInput) showScore = showScoreInput.checked ? 1 : 0;
                if (showMovedInput) showMoved = showMovedInput.checked ? 1 : 0;
                if (showFpsInput) showFPS = showFpsInput.checked ? 1 : 0;
                if (showXYInput) showXY = showXYInput.checked ? 1 : 0;
                if (showNXYInput) showNXY = showNXYInput.checked ? 1 : 0;
                if (showEntityCountsInput) showEntityCounts = showEntityCountsInput.checked ? 1 : 0;
                if (showMobileTouchInput) showMobileTouch = showMobileTouchInput.checked ? 1 : 0;
                settingsPanel.style.display = 'none';
                isPaused = false; // é—œé–‰è¨­å®šæ™‚æ¢å¾©
                if (startXInput) startx = parseInt(startXInput.value) || 0;
                if (startYInput) starty = parseInt(startYInput.value) || 0;
            };
        }
        // æ–°å¢ï¼šcheckbox è®Šå‹•å³æ™‚åŒæ­¥
        ['setting-show-score','setting-show-moved','setting-show-fps','setting-show-xy','setting-show-nxy','setting-show-entity-counts','setting-show-mobile-touch'].forEach(id => {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', function() {
                    switch(id) {
                        case 'setting-show-score': showScore = this.checked ? 1 : 0; break;
                        case 'setting-show-moved': showMoved = this.checked ? 1 : 0; break;
                        case 'setting-show-fps': showFPS = this.checked ? 1 : 0; break;
                        case 'setting-show-xy': showXY = this.checked ? 1 : 0; break;
                        case 'setting-show-nxy': showNXY = this.checked ? 1 : 0; break;
                        case 'setting-show-entity-counts': showEntityCounts = this.checked ? 1 : 0; break;
                        case 'setting-show-mobile-touch': showMobileTouch = this.checked ? 1 : 0; updateMobileTouchDisplay(); break;
                    }
                });
            }
        });
        // éŸ³æ¨‚/æ•ˆæœéŸ³å³æ™‚åŒæ­¥
        var bgmOnInput2 = document.getElementById('setting-bgm-on');
        if (bgmOnInput2) {
            bgmOnInput2.addEventListener('change', function() {
                isBgmOn = this.checked ? 1 : 0;
                // ç«‹å³æ§åˆ¶ BGM/OUTRO
                const bgm = document.getElementById('bgm');
                const outroAudio = document.getElementById('outro-audio');
                if (isBgmOn) {
                    if (bgm && gameRunning) { bgm.currentTime = 0; bgm.volume = VOLUME_BGM; bgm.play(); }
                } else {
                    if (bgm) { bgm.pause(); }
                    if (outroAudio) { outroAudio.pause(); }
                }
            });
        }
        var sfxOnInput2 = document.getElementById('setting-sfx-on');
        if (sfxOnInput2) {
            sfxOnInput2.addEventListener('change', function() {
                isSfxOn = this.checked ? 1 : 0;
            });
        }
        // 4. åƒæ•¸ input ç¶å®šï¼ˆç§»é™¤å³æ™‚å¥—ç”¨ï¼‰
        var moveSpeedInput2 = document.getElementById('setting-move-speed');
        if (moveSpeedInput2) moveSpeedInput2.addEventListener('input', function() {
            playerMoveSpeed = parseInt(this.value) || 1;
        });
        var weaponPowerInput2 = document.getElementById('setting-weapon-power');
        if (weaponPowerInput2) weaponPowerInput2.addEventListener('input', function() {
            weaponPower = parseInt(this.value) || 1;
        });
        var maxFpsInput2 = document.getElementById('setting-max-fps');
        if (maxFpsInput2) maxFpsInput2.addEventListener('input', function() {
            MAX_FPS = parseInt(this.value) || 10;
        });
        var gravityInput2 = document.getElementById('setting-gravity');
        if (gravityInput2) gravityInput2.addEventListener('input', function() {
            GRAVITY = parseFloat(this.value) || 1;
        });
        var jumpPowerInput2 = document.getElementById('setting-jump-power');
        if (jumpPowerInput2) jumpPowerInput2.addEventListener('input', function() {
            JUMP_POWER = parseFloat(this.value) || -11.5*1.3;
        });
        var jumpExtraInput2 = document.getElementById('setting-jump-extra');
        if (jumpExtraInput2) jumpExtraInput2.addEventListener('input', function() {
            JUMP_EXTRA = parseFloat(this.value) || -0.35*1.3;
        });
        var jumpExtraFramesInput2 = document.getElementById('setting-jump-extra-frames');
        if (jumpExtraFramesInput2) jumpExtraFramesInput2.addEventListener('input', function() {
            JUMP_EXTRA_FRAMES = parseInt(this.value) || 12;
        });

        let isPaused = false; // æ–°å¢å…¨åŸŸæš«åœæ——æ¨™

        // è£œä¸Š simulateKey å¯¦ä½œ
        function simulateKey(key, pressed) {
            if (keys.hasOwnProperty(key)) {
                keys[key] = pressed;
            }
            // è‹¥éœ€è¦è§¸ç™¼è·³èºçš„ç‰¹æ®Šè¡Œç‚º
            if (key === 'ArrowUp') {
                if (pressed) {
                    if (!jumpKeyPressed) {
                        jumpKeyDownTime = Date.now();
                        jumpKeyPressed = true;
                    }
                } else {
                    if (jumpKeyPressed) {
                        const pressDuration = Date.now() - jumpKeyDownTime;
                        if (pressDuration < 200 && player.vy < 0) {
                            player.vy /= 4;
                        } else if (pressDuration < 300 && player.vy < 0) {
                            player.vy /= 3;
                        } else if (pressDuration < 400 && player.vy < 0) {
                            player.vy /= 2;
                        }
                        jumpKeyPressed = false;
                    }
                }
            }
            // å°„æ“Šéµç‰¹æ®Šè™•ç†
            if (key === ' ') {
                if (pressed) {
                    if (!charging && gameRunning) {
                        charging = true;
                        chargeFrame = 0;
                        chargeReady = false;
                        player.isShooting = true;
                        const shootAudio = document.getElementById('shoot-audio');
                        if (shootAudio) {
                            shootAudio.currentTime = 0;
                            shootAudio.volume = VOLUME_SHOOT;
                            if (isSfxOn) shootAudio.play();
                        }
                        if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                        chargeAudioTimeout = setTimeout(() => {
                            if (charging) {
                                const chargeAudio = document.getElementById('charge-audio');
                                if (chargeAudio) {
                                    chargeAudio.currentTime = 0;
                                    chargeAudio.volume = VOLUME_CHARGE;
                                    if (isSfxOn) chargeAudio.play();
                                }
                            }
                        }, 500);
                    }
                } else {
                    if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                        chargeReady = true;
                    } else if (charging && chargeFrame < CHARGE_CANCEL_FRAME && !chargeReady) {
                        player.isShooting = true;
                    }
                    charging = false;
                    setTimeout(() => { player.isShooting = false; }, 0);
                    if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                    const chargeAudio = document.getElementById('charge-audio');
                    if (chargeAudio) {
                        chargeAudio.pause();
                        chargeAudio.currentTime = 0;
                        chargeAudio.volume = VOLUME_CHARGE;
                    }
                }
            }
        }

        // æ–°å¢ï¼šæ ¹æ“š showMobileTouch é¡¯ç¤º/éš±è—è§¸æ§æŒ‰éˆ•
        function updateMobileTouchDisplay() {
            const touchControls = document.getElementById('touch-controls');
            if (touchControls) {
                touchControls.style.display = showMobileTouch ? 'flex' : 'none';
            }
        }
        // é è¨­è¼‰å…¥æ™‚ä¹Ÿè¦å‘¼å«ä¸€æ¬¡
        updateMobileTouchDisplay();

        document.getElementById('setting-start-x').addEventListener('input', function() {
            startx = parseInt(this.value) || 0;
        });
        document.getElementById('setting-start-y').addEventListener('input', function() {
            starty = parseInt(this.value) || 0;
        });

        let isWinInvincible = false; // å‹åˆ©ç•«é¢ç„¡æ•µç‹€æ…‹


        // æ–°å¢ï¼šè¨­å®šé¢æ¿èªè¨€ä¸‹æ‹‰é¸å–®åˆ‡æ›
        // var settingsLangSelect = document.getElementById('settings-lang-select');
        // settingsLangSelect.value = currentLang;
        // settingsLangSelect.onchange = function() {
        //     setLang(this.value);
        //     updateSettingsPanelLang();
        // };

        // æ–°å¢ï¼šæ ¹æ“šèªè¨€åˆ‡æ›è¨­å®šé¢æ¿æ‰€æœ‰æ–‡å­—
        function updateSettingsPanelLang() {
            const L = LANGUAGES[currentLang].settings;
            document.querySelector('#settings-panel h2').textContent = L.title;
            document.getElementById('settings-lang-label').textContent = L.selectLang;
            // label for bgm
            var bgmLabel = document.getElementById('setting-bgm-on').parentNode;
            if (bgmLabel) {
                var bgmInput = document.getElementById('setting-bgm-on');
                bgmLabel.innerHTML = '';
                if (bgmInput) bgmLabel.appendChild(bgmInput);
                bgmLabel.append(' ' + L.music);
            }
            var sfxLabel = document.getElementById('setting-sfx-on').parentNode;
            if (sfxLabel) {
                var sfxInput = document.getElementById('setting-sfx-on');
                sfxLabel.innerHTML = '';
                if (sfxInput) sfxLabel.appendChild(sfxInput);
                sfxLabel.append(' ' + L.sfx);
            }
            // å…¶ä»– input + label
            function updateInputLabel(inputId, labelText) {
                var input = document.getElementById(inputId);
                if (input && input.parentNode) {
                    var label = input.parentNode;
                    // åªæ›´æ–°ç¬¬ä¸€å€‹æ–‡å­—ç¯€é»
                    if (label.childNodes.length > 0 && label.childNodes[0].nodeType === 3) {
                        label.childNodes[0].textContent = labelText + ' ';
                    }
                }
            }
            updateInputLabel('setting-start-x', L.startX);
            updateInputLabel('setting-start-y', L.startY);
            updateInputLabel('setting-move-speed', L.moveSpeed);
            updateInputLabel('setting-weapon-power', L.weaponPower);
            updateInputLabel('setting-max-fps', L.maxFps);
            updateInputLabel('setting-gravity', L.gravity);
            updateInputLabel('setting-jump-power', L.jumpPower);
            updateInputLabel('setting-jump-extra', L.jumpExtra);
            updateInputLabel('setting-jump-extra-frames', L.jumpExtraFrames);
            // Checkbox
            function updateCheckboxLabel(inputId, labelText) {
                var input = document.getElementById(inputId);
                if (input && input.parentNode) {
                    var label = input.parentNode;
                    label.innerHTML = '';
                    label.appendChild(input);
                    label.append(' ' + labelText);
                }
            }
            updateCheckboxLabel('setting-show-score', L.showScore);
            updateCheckboxLabel('setting-show-moved', L.showMoved);
            updateCheckboxLabel('setting-show-fps', L.showFps);
            updateCheckboxLabel('setting-show-xy', L.showXy);
            updateCheckboxLabel('setting-show-nxy', L.showNxy);
            updateCheckboxLabel('setting-show-entity-counts', L.showEntityCounts);
            updateCheckboxLabel('setting-show-mobile-touch', L.showMobileTouch);
            document.getElementById('settings-close-btn').textContent = L.ok;
        }

        // è‡ªè¨‚èªè¨€é¸å–®é‚è¼¯
        const customLangBtn = document.getElementById('custom-lang-select-btn');
        const customLangList = document.getElementById('custom-lang-select-list');
        const customLangItems = customLangList.querySelectorAll('li');
        function updateCustomLangBtn() {
            const map = { zh: 'ä¸­æ–‡', ja: 'æ—¥æœ¬èª', en: 'English' };
            customLangBtn.textContent = map[currentLang] + ' â–¼';
        }
        customLangBtn.onclick = function(e) {
            e.stopPropagation();
            customLangList.style.display = (customLangList.style.display === 'block') ? 'none' : 'block';
        };
        customLangItems.forEach(item => {
            item.onclick = function(e) {
                setLang(this.dataset.lang);
                updateCustomLangBtn();
                customLangList.style.display = 'none';
                updateSettingsPanelLang();
            };
        });
        document.addEventListener('click', function(e) {
            customLangList.style.display = 'none';
        });
        window.addEventListener('DOMContentLoaded', updateCustomLangBtn);
    </script>
</body>
</html>