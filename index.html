<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ≠Ê∫Ä ÂÑÑÂçÉ‰∏áÂÑÑÂçÉ‰∏á by watokiryuu</title>
    <link rel="icon" href="/favicon.ico" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #game-wrapper {
            width: 800px;
            height: 500px;
            position: relative;
            margin: 0 auto;
            background: transparent;
        }
        
        #game-container {
            width: 800px;
            height: 500px;
            position: relative;
            background: #000;
        }
        
        #game-canvas {
            background-color: #000;
        }
        
        #start-screen, #game-over-screen, #win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 10;
        }
        
        #game-over-screen, #win-screen {
            display: none;
        }
        
        h1 {
            color: #4af;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #4af;
        }
        
        button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4af;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            /* margin-top: 20px; */
        }
        
        button:hover {
            background-color: #6cf;
        }
        
        #health-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
        }
        
        #health-fill {
            height: 100%;
            width: 100%;
            background-color: #4af;
            transition: width 0.3s;
        }
        
        #boss-health-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
            display: none;
        }
        
        #boss-health-fill {
            height: 100%;
            width: 100%;
            background-color: #ccc;
            transition: width 0.3s;
        }
        
        #score {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            font-size: 18px;
            z-index: 5;
        }
        
        #camera-debug {
            position: absolute;
            top: 70px;
            left: 10px;
            color: white;
            font-size: 12px;
            z-index: 5;
        }
        
        #fps-display {
            position: absolute;
            top: 70px;
            right: 10px;
            color: white;
            font-size: 14px;
            z-index: 5;
        }
        
        #win-screen h1 div {
            text-align: center;
        }
        
        #touch-controls {
            position: absolute;
            left: 0;
            right: 0;
            top: 340px; /*Êï¥È´îÊåâÈàïÈ´òÂ∫¶ ÊâãÊ©üÊéßÂà∂ÈàïÈ´òÂ∫¶ touchÈ´òÂ∫¶*/
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            touch-action: none;
        }
        #touch-controls .touch-left, #touch-controls .touch-right {
            display: flex;
            gap: 8px; /* Êõ¥Èù†Ëøë */
            margin: 0 2vw; /* Èù†Ëøë‰∏≠Èñì */
        }
        #touch-controls button {
            pointer-events: auto;
            width: 60px;
            height: 60px;
            font-size: 24.2px;
            border-radius: 50%;
            border: none;
            background: #333a;
            color: #fff;
            box-shadow: 0 2px 8px #0006;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #touch-controls button:active {
            background: #4af;
            color: #fff;
        }
        @media (max-width: 900px) {
            #game-container { width: 800px; height: 500px; }
            #touch-controls { height: 90px; }
            #touch-controls .touch-left, #touch-controls .touch-right { margin: 0 6vw; }
            #touch-controls button { width: 60px; height: 60px; font-size: 24.2px; }
        }
        #touch-controls .touch-right {
            display: flex;
            gap: 8px;
            margin: 0 2vw;
            /* position: relative; */
            /* top: -100px; */
        }
        #btn-shoot {
            position: relative;
            top: -100px;
        }
        #settings-panel {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            color: #fff;
            padding: 32px 32px 24px 32px;
            border-radius: 16px;
            box-shadow: 0 4px 32px #000a;
            z-index: 2000;
            display: none;
            min-width: 320px;
            max-width: 96vw;
            max-height: 96vh;
            overflow: auto;
            font-size: calc(16px + 1vw);
        }
        @media (max-width: 600px) {
            #settings-panel {
                min-width: 0;
                width: 98vw;
                padding: 2vw 2vw 2vw 2vw;
                font-size: calc(12px + 2vw);
            }
            #settings-panel h2 {
                font-size: calc(18px + 2vw);
            }
        }
        #settings-panel *:not(h2) {
            font-size: 70% !important;
        }
        #language-select {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 12px 24px;
            border-radius: 10px;
            box-shadow: 0 2px 12px #0008;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 3000;
        }
        #custom-lang-select-list, #custom-lang-select-list li {
            font-size: 12px !important;
            line-height: 1.6;
        }
        #start-button,  #play-again-button{
            margin-top: 50px;
        }
        
    </style>
</head>
<body>
    <audio id="bgm" src="bgm.mp3" loop style="display:none"></audio>
    <audio id="shoot-audio" src="shoot.mp3" style="display:none"></audio>
    <audio id="game-over-audio" src="game-over.mp3" style="display:none"></audio>
    <audio id="charge-audio" src="charge.mp3" loop style="display:none"></audio>
    <audio id="boom-audio" src="boom.mp3" style="display:none"></audio>
    <audio id="hurt-audio" src="hurt.mp3" style="display:none"></audio>
    <audio id="bossdie-audio" src="bossdie.mp3" style="display:none"></audio>
    <audio id="outro-audio" src="outro.mp3" style="display:none"></audio>
    <audio id="boss-audio" src="boss.mp3" style="display:none"></audio>
    <div id="game-wrapper">
        <div id="game-container">
            <button id="lang-toggle" style="position:absolute;top:10px;right:10px;z-index:30;background:#222;color:#fff;border-radius:6px;padding:4px 12px;font-size:14px;">üåê</button>
            <div id="language-select" style="position:absolute;top:40px;right:10px;z-index:29;background:#222;padding:12px 24px;border-radius:10px;box-shadow:0 2px 12px #0008;display:none;flex-direction:column;align-items:center;">
                <h2 style="color:#fff;margin-bottom:10px;font-size:16px;">ÈÅ∏ÊìáË™ûË®Ä / Ë®ÄË™û„ÇíÈÅ∏Êäû / Select Language</h2>
                <div style="display:flex;gap:12px;">
                    <button id="lang-zh">‰∏≠Êñá</button>
                    <button id="lang-ja">Êó•Êú¨Ë™û</button>
                    <button id="lang-en">English</button>
                </div>
            </div>
            <canvas id="game-canvas" width="800" height="500"></canvas>
            
            <div id="health-bar">
                <div id="health-fill"></div>
            </div>
            
            <div id="boss-health-container">
                <div id="boss-health-fill"></div>
            </div>
            
            <div id="score">score: 0</div>
            <div id="camera-debug"></div>
            <div id="fps-display" style="position:absolute;top:70px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="xy-display" style="position:absolute;top:90px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="nxy-display" style="position:absolute;top:110px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="entity-counts" style="position:absolute;top:130px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            
            <!-- ÈÅäÊà≤ÈñãÂßãÁï´Èù¢ÔºàStart ScreenÔºâ -->
            <div id="start-screen">
                <h1></h1>
                <p></p>
                <p></p>
                <p></p>
                <button id="start-button">START</button>
            </div>
            
            <!-- ÈÅäÊà≤ÁµêÊùüÁï´Èù¢ÔºàGame Over ScreenÔºâ -->
            <div id="game-over-screen">
                <h1 style="color:#800;">gameover</h1>
                <p id="final-score">score: 0</p>
                <button id="restart-button">again?</button>
            </div>
            
            <!-- ÂãùÂà©Áï´Èù¢ÔºàWin ScreenÔºâ -->
            <div id="win-screen">
                <h1>win!</h1>
                <p id="win-score">score: </p>
                <button id="play-again-button">play again</button>
                <div id="by-watoki" style="position:absolute;right:70px;bottom:10px;color:#fff;font-size:18px;z-index:20;text-shadow:0 0 4px #000a;">by Watoki</div>
            </div>
        </div>
        <div id="flash-effect" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100;display:none;"></div>
        <img id="tornado-img" src="tornadoes.png" style="display:none" />
        <!-- Ëß∏ÊéßÊìç‰ΩúÂçÄ -->
        <div id="touch-controls">
            <div class="touch-left">
                <button id="btn-left">‚Üê</button>
                <button id="btn-right">‚Üí</button>
            </div>
            <div class="touch-right">
                <button id="btn-jump">‚Üë</button>
                <button id="btn-shoot">S</button>
            </div>
        </div>
        <!-- <div id="settings-btn" style="position:absolute;right:10px;bottom:10px;width:45px;height:45px;border-radius:50%;background:#333a;color:#fff;box-shadow:0 2px 8px #0006;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;z-index:1000;font-size:22px;">‚öôÔ∏è</div> -->
    </div>

    <script>

        // ===== ÈÅäÊà≤Ë®≠ÂÆöÔºàÈõÜ‰∏≠Êï¥ÁêÜÔºâ =====

        // È°èËâ≤Ë®≠ÂÆö
        const COLOR_PLATFORM_NORMAL = '#444';      // ‰∏ÄËà¨Âπ≥Âè∞È°èËâ≤
        const COLOR_PLATFORM_BOSS   = '#800';      // BossÂçÄÂüüÂπ≥Âè∞È°èËâ≤
        const COLOR_PLATFORM_HIGH   = '#666';      // È´òÂè∞Âπ≥Âè∞È°èËâ≤
        const COLOR_PLAYER          = '#4af';      // Áé©ÂÆ∂È°èËâ≤
        const COLOR_BOSS            = '#2196f3';   // Boss‰∏ªÈ´îÈ°èËâ≤
        const COLOR_BOSS_FAN        = '#ffe082';   // BossÈ¢®ÊâáÈ°èËâ≤
        const COLOR_BOSS_FAN_CENTER = '#fff';      // BossÈ¢®Êâá‰∏≠ÂøÉÈ°èËâ≤
        const COLOR_BULLET_NORMAL   = '#b3f0ff';   // Áé©ÂÆ∂ÊôÆÈÄöÂ≠êÂΩàÈ°èËâ≤
        const COLOR_BULLET_CHARGE   = '#ff0';      // Áé©ÂÆ∂ÈõÜÊ∞£ÂΩàÈ°èËâ≤
        const COLOR_BULLET_ENEMY    = '#f8f';      // Êïµ‰∫∫Â≠êÂΩàÈ°èËâ≤
        const COLOR_BULLET_BOSS     = '#f4a';      // BossÂ≠êÂΩàÈ°èËâ≤

        // Èü≥ÈáèË®≠ÂÆö
        let VOLUME_BGM      = 0.55;  // ËÉåÊôØÈü≥Ê®ÇÈü≥Èáè
        let VOLUME_SHOOT    = 0.55;  // Â∞ÑÊìäÈü≥ÊïàÈü≥Èáè
        let VOLUME_CHARGE   = 0.55;  // ÈõÜÊ∞£Èü≥ÊïàÈü≥Èáè
        let VOLUME_BOOM     = 0.45;  // ÁàÜÁÇ∏Èü≥ÊïàÈü≥Èáè
        let VOLUME_HURT     = 0.70;  // ÂèóÂÇ∑Èü≥ÊïàÈü≥Èáè
        let VOLUME_GAMEOVER = 0.75;  // ÈÅäÊà≤ÁµêÊùüÈü≥ÊïàÈü≥Èáè
        let VOLUME_BOSSDIE  = 0.40;  // BossÊ≠ª‰∫°Èü≥ÊïàÈü≥Èáè
        let VOLUME_BOSS     = 0.85;  // BossÂá∫Â†¥Èü≥ÊïàÈü≥Èáè
        let VOLUME_OUTRO    = 0.55;  // ÂãùÂà©Èü≥Ê®ÇÈü≥Èáè

        // ÈÅäÊà≤Â∏∏Êï∏
        let GRAVITY         = 1;         // ÈáçÂäõÂä†ÈÄüÂ∫¶
        let JUMP_POWER      = -15; // Ë∑≥Ë∫çÂàùÈÄüÂ∫¶
        let JUMP_EXTRA      = -0.5; // Èï∑ÊåâË∑≥Ë∫çÊôÇÊØèÂπÄÈ°çÂ§ñÂä†ÈÄüÂ∫¶
        let JUMP_EXTRA_FRAMES = 12;      // Ë∑≥Ë∫çÈ°çÂ§ñÂä†ÈÄüÊúÄÂ§ßÂπÄÊï∏
        const WORLD_WIDTH     = 5400;    // ‰∏ñÁïåÂØ¨Â∫¶
        const WORLD_HEIGHT    = 500;       // ‰∏ñÁïåÈ´òÂ∫¶
        const BOSS_AREA_X     = 4600;      // BossÂçÄÂüüËµ∑ÈªûXÂ∫ßÊ®ô
        let CHARGE_MIN_FRAME = 42;       // ÈõÜÊ∞£ÂΩàÊúÄÂ∞ëÈúÄË¶ÅÁöÑÂπÄÊï∏
        let CHARGE_CANCEL_FRAME = 12;    // ÈõÜÊ∞£ÂèñÊ∂àÁöÑÊúÄÁü≠ÂπÄÊï∏

        // ===== ÈÅäÊà≤ÁãÄÊÖã =====
        let MAX_FPS = 70; // ÊúÄÂ§ßFPSË®≠ÂÆö
        let startx = 0;
        let starty = 0;
        let gameRunning  = false; // ÈÅäÊà≤ÊòØÂê¶Ê≠£Âú®ÈÄ≤Ë°å‰∏≠
        let score        = 0;     // Áé©ÂÆ∂ÂàÜÊï∏
        let playerMaxHealth = 100; // Êñ∞Â¢ûÊúÄÂ§ßË°ÄÈáè
        let playerHealth = playerMaxHealth; // Áé©ÂÆ∂ÁõÆÂâçË°ÄÈáè
        let bossHealth   = 300;  // Â¢ûÂº∑BossË°ÄÈáè
        let bossActive   = false; // BossÊòØÂê¶ÂïüÂãï
        let bossTimer    = 0;     // BossÂá∫Â†¥ÂãïÁï´Ë®àÊôÇÂô®
        let reachedBossArea = false; // Áé©ÂÆ∂ÊòØÂê¶Â∑≤Á∂ìÊäµÈÅîÈÅébossÂçÄÂüü
        let charging = false; // ÊòØÂê¶Ê≠£Âú®ÈõÜÊ∞£
        let chargeFrame = 0; // ÈõÜÊ∞£ÊåÅÁ∫åÂπÄÊï∏
        let chargeReady = false; // ÊòØÂê¶ÈõÜÊ∞£ÂÆåÊàê
        let bossHitFlash = 0; // BossË¢´Êìä‰∏≠ÈñÉÁàçË®àÊï∏
        let upPressed = false; // ËøΩËπ§‰∏äÈçµÊòØÂê¶Â∑≤Á∂ìÊåâ‰∏ã
        let chargeAudioTimeout = null; // ÈõÜÊ∞£Èü≥ÊïàÂª∂ÈÅ≤Ë®àÊôÇÂô®
        let bossCanAttack = false; // BossÊòØÂê¶ÂèØ‰ª•ÊîªÊìä
        let bossCanMove = false; // BossÊòØÂê¶ÂèØ‰ª•ÁßªÂãï
        let bossHpAnimating = false; // BossË°ÄÊ¢ùÊòØÂê¶Ê≠£Âú®ÂãïÁï´
        let canShoot = true; // Áé©ÂÆ∂ÊòØÂê¶ÂèØ‰ª•Â∞ÑÊìä
        let midEventTriggered = false; // ‰∏≠ÈÄî‰∫ã‰ª∂ÊòØÂê¶Â∑≤Ëß∏Áôº
        let playerDead = false; // Êñ∞Â¢ûÔºöÁé©ÂÆ∂Ê≠ª‰∫°ÁãÄÊÖã
        let playerDeadX = 0;   // Êñ∞Â¢ûÔºöÊ≠ª‰∫°ÊôÇÁöÑX
        let playerDeadY = 0;   // Êñ∞Â¢ûÔºöÊ≠ª‰∫°ÊôÇÁöÑY
        let weaponPower = 100;   // Ê≠¶Âô®ÊîªÊìäÂäõË®≠ÂÆöÔºåÊñπ‰æøÁµ±‰∏ÄË™øÊï¥Áé©ÂÆ∂Â≠êÂΩàÂÇ∑ÂÆ≥ 1ÁÇ∫Ê≠£Â∏∏Êï∏Â≠óË∂äÂ§ßÂÇ∑ÂÆ≥Ë∂äÈ´ò
        let playerMoveSpeed = 6; // Áé©ÂÆ∂ÁßªÂãïÈÄüÂ∫¶Ë®≠ÂÆöÔºåÊï∏ÂÄºË∂äÂ§ßÁßªÂãïË∂äÂø´ÔºåÈ†êË®≠6
        let showScore = 1; // score:0 È°ØÁ§∫1 Èö±Ëóè0
        let showMoved = 0; // moved:(0) È°ØÁ§∫1 Èö±Ëóè0
        let showFPS = 1; //showfps
        let showXY = 0; //show xy
        let showNXY = 0; //show new xy
        let showEntityCounts = 0; //show ‰∫∫Áâ©ÊÄ™Áâ©Â≠êÂΩàÊï∏Èáè
        let showMobileTouch = 1; // Êñ∞Â¢ûÔºöÊòØÂê¶È°ØÁ§∫ÊâãÊ©üËß∏ÊéßÊåâÈàïÔºà1=È°ØÁ§∫Ôºå0=Èö±ËóèÔºâ
        let isBgmOn = 1;  // BGMÔºàÂåÖÂê´ OUTROÔºâÊòØÂê¶ÈñãÂïüÔºå1=ÈñãÂïüÔºå0=ÈóúÈñâ
        let isSfxOn = 1; // ÊïàÊûúÈü≥ÊòØÂê¶ÈñãÂïüÔºå1=ÈñãÂïüÔºå0=ÈóúÈñâ

        // ===== Êñ∞Â¢û fakeBoss ÂÖ®ÂüüËÆäÊï∏ =====
        let fakeBoss = null;
        let fakeBossFlashFrame = 0;

        // ‰ª•Ê†ºÊï∏Ë®≠Ë®àÁöÑÂπ≥Âè∞Ë≥áÊñô Âú∞Êùø
        const platformGrid = [
            // Á¨¨‰∏ÄÂçÄÔºà0~2700Ôºâ
            { x: 0, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 1, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 2, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 3, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 4, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 5, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 6, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 7, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 8, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 9, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 10, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 11, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 12, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 13, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 14, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 15, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 16, y: 1, color: COLOR_PLATFORM_NORMAL },
            // ‰∏≠ÈñìÂçÄÂüü
            { x: 17, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 18, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 19, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 20, y: 3, color: COLOR_PLATFORM_HIGH },
            // { x: 21, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 22, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 23, y: 3, color: COLOR_PLATFORM_NORMAL },
            { x: 24, y: 3, color: COLOR_PLATFORM_NORMAL },
            // { x: 25, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 26, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 27, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 28, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 29, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 30, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 31, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 32, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 33, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 34, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 35, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 36, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 37, y: 6, color: COLOR_PLATFORM_NORMAL },
            { x: 38, y: 6, color: COLOR_PLATFORM_NORMAL },
            { x: 39, y: 6, color: COLOR_PLATFORM_NORMAL },
            // { x: 40, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 41, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 42, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 43, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 44, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 45, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 46, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 47, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 48, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 49, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 50, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 51, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 52, y: 3, color: COLOR_PLATFORM_HIGH },
            // { x: 53, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 54, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 55, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 56, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 57, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 58, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 59, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 60, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 61, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 62, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 63, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 64, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 65, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 66, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 67, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 68, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 69, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 70, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 71, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 72, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 73, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 74, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 75, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 76, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 77, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 78, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 79, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 80, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 81, y: 7, color: COLOR_PLATFORM_NORMAL },
            // { x: 82, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 83, y: 7, color: COLOR_PLATFORM_HIGH },
            // { x: 84, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 85, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 86, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 87, y: 9, color: COLOR_PLATFORM_NORMAL },
            // { x: 88, y: 9, color: COLOR_PLATFORM_NORMAL },
            { x: 89, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 90, y: 2, color: COLOR_PLATFORM_NORMAL },

            // Boss ÂçÄÂüüÂú∞ÊùøÔºàx=4600 ‰πãÂæåÔºâ
            { x: 91, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 92, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 93, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 94, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 95, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 96, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 97, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 98, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 99, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 100, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 101, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 102, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 103, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 104, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 105, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 106, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 107, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 108, y: 1, color: COLOR_PLATFORM_BOSS },
        ];
        // Ëá™ÂãïËΩâÊèõ
        const basePlatforms = platformGrid.map(p => ({
            x: p.x * 50,
            y: 500 - p.y * 50,
            width: 50,
            height: 50,
            color: p.color
        }));
        
        // ===== DOM ÂÖÉÁ¥†ÈÅ∏Âèñ =====
        const canvas              = document.getElementById('game-canvas');
        const ctx                 = canvas.getContext('2d');
        
        const startScreen         = document.getElementById('start-screen');
        const gameOverScreen      = document.getElementById('game-over-screen');
        const winScreen           = document.getElementById('win-screen');
        
        const startButton         = document.getElementById('start-button');
        const restartButton       = document.getElementById('restart-button');
        const playAgainButton     = document.getElementById('play-again-button');
        
        const healthFill          = document.getElementById('health-fill');
        const bossHealthContainer = document.getElementById('boss-health-container');
        const bossHealthFill      = document.getElementById('boss-health-fill');
        
        const scoreElement        = document.getElementById('score');
        const finalScoreElement   = document.getElementById('final-score');
        const winScoreElement     = document.getElementById('win-score');
        const cameraDebugElement  = document.getElementById('camera-debug');

        
        // ===== Èè°È†≠Á≥ªÁµ± =====
        const camera = {
            x: 0,
            y: 0,
            width: canvas.width,
            height: canvas.height,
            // Âπ≥ÊªëË∑üÈö®Áé©ÂÆ∂
            follow: function(target) {
                const centerX = target.x + target.width/2;
                const centerY = target.y + target.height/2;
                
                // Ê∞¥Âπ≥Ë∑üÈö®
                this.x = centerX - this.width/2;
                
                // Áï∂Áé©ÂÆ∂ÊäµÈÅîbossÂçÄÂüüÂæåÔºåÈè°È†≠Â∑¶ÈÇäÁïåÈéñÂÆöÂú®BOSS_AREA_X
                if (target.x >= BOSS_AREA_X) {
                    this.x = Math.max(BOSS_AREA_X, this.x);
                }
                
                // ÂûÇÁõ¥Ë∑üÈö® (‰ΩÜÈôêÂà∂‰∏çËÆìÁé©ÂÆ∂ÁúãÂà∞Âú∞ÂúñÂ§ñ)
                const maxY = WORLD_HEIGHT - this.height;
                this.y = Math.min(maxY, Math.max(0, centerY - this.height/2));
                
                // ÈôêÂà∂‰∏çË∂ÖÂá∫‰∏ñÁïåÈÇäÁïå
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
            }
        };
        
        // ===== Áé©ÂÆ∂Áâ©‰ª∂ =====
        let player = {
            x: startx,                // Áé©ÂÆ∂XÂ∫ßÊ®ôÔºàÈÄ£Âãï startxÔºâ
            y: starty,                // Áé©ÂÆ∂YÂ∫ßÊ®ôÔºàÈÄ£Âãï startyÔºâ
            width: 40,             // Áé©ÂÆ∂ÂØ¨Â∫¶
            height: 40,            // Áé©ÂÆ∂È´òÂ∫¶
            get speed() { return playerMoveSpeed; }, // Áé©ÂÆ∂ÁßªÂãïÈÄüÂ∫¶ÔºàÂèñËá™ÂÖ®ÂüüËÆäÊï∏Ôºâ
            vy: 0,                 // ÂûÇÁõ¥ÈÄüÂ∫¶
            onGround: false,       // ÊòØÂê¶Âú®Âú∞Èù¢‰∏ä
            color: '#4af',         // Áé©ÂÆ∂È°èËâ≤
            isShooting: false,     // ÊòØÂê¶Ê≠£Âú®Â∞ÑÊìä
            shootCooldown: 0,      // Â∞ÑÊìäÂÜ∑ÂçªË®àÊôÇÂô®
            shootDelay: Math.round(15 / 1.1), // Â∞ÑÊìäÈñìÈöî
            direction: 1,          // Áé©ÂÆ∂Èù¢ÂêëÊñπÂêëÔºà1=Âè≥Ôºå-1=Â∑¶Ôºâ
            invincible: 0,         // ÁÑ°ÊïµÂâ©È§òÂπÄÊï∏
            
            // Êõ¥Êñ∞Áé©ÂÆ∂‰ΩçÁΩÆ
            update: function() {
                if (playerDead) {
                    this.x = playerDeadX;
                    this.y = playerDeadY;
                    return; // Ê≠ª‰∫°ÊôÇ‰∏çËÉΩÂãï‰Ωú‰∏îÁ∂≠ÊåÅÂú®Ê≠ª‰∫°‰ΩçÁΩÆ
                }
                // ===== È£õË°åÊ®°Âºè =====
                if (isFlyingMode === 1) {
                    // Â∑¶Âè≥ÁßªÂãï
                    if (keys.ArrowLeft)  { this.x -= this.speed; this.direction = -1; }
                    if (keys.ArrowRight) { this.x += this.speed; this.direction =  1; }
                    // ‰∏ä‰∏ãÁßªÂãï
                    if (keys.ArrowUp)    { this.y -= this.speed; }
                    if (keys.ArrowDown)  { this.y += this.speed; }
                    // ÈÇäÁïåÈôêÂà∂
                    this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                    this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
                    this.onGround = false;
                    return;
                }
                // ÊòØÂê¶ÊäµÈÅîÈÅébossÂçÄÂüü
                if (this.x >= BOSS_AREA_X) {
                    reachedBossArea = true;
                }
                // Ê∞¥Âπ≥ÁßªÂãï
                if (keys.ArrowLeft)  {
                    if (reachedBossArea) {
                        this.x -= this.speed;
                        if (this.x < BOSS_AREA_X) this.x = BOSS_AREA_X;
                    } else {
                        this.x -= this.speed;
                        if (this.x < 0) this.x = 0;
                    }
                    this.direction = -1;
                }
                if (keys.ArrowRight) { this.x += this.speed; this.direction =  1; }
                
                // Ë∑≥Ë∫ç
                if (keys.ArrowUp && this.onGround && !upPressed) {
                    this.vy = JUMP_POWER;
                    this.onGround = false;
                    upPressed = true;
                    isJumping = true;
                    jumpHoldFrames = 0;
                }
                if (!keys.ArrowUp) upPressed = false;
                
                // ÈáçÂäõËàáÊñ∞ y ‰ΩçÁΩÆ
                this.vy += GRAVITY;
                let newY = this.y + this.vy;
                
                // Âπ≥Âè∞Á¢∞ÊíûÊ™¢Ê∏¨
                this.onGround = false;
                for (let p of platforms) {
                    const overlapX = this.x + this.width > p.x && this.x < p.x + p.width;
                    if (overlapX && this.y + this.height <= p.y && newY + this.height >= p.y) {
                        newY = p.y - this.height;
                        this.vy = 0;
                        this.onGround = true;
                    }
                }
                
                // Êõ¥Êñ∞‰ΩçÁΩÆ
                this.y = newY;
                
                // ÈÇäÁïåÈôêÂà∂
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                
                // ÊéâËêΩÊ≠ª‰∫°
                if (this.y >= WORLD_HEIGHT) {
                    gameOver();
                    return;
                }
                
                // ÁÑ°ÊïµÊôÇÈñìÊõ¥Êñ∞
                if (this.invincible > 0) {
                    this.invincible--;
                }
                // Ë∑≥Ë∫çÂ¢ûÂäõÔºàÂèØËÆäÈ´òÂ∫¶Ôºâ
                if (isJumping && !this.onGround && this.vy < 0 && jumpHoldFrames < JUMP_EXTRA_FRAMES) {
                    this.vy += JUMP_EXTRA;
                    jumpHoldFrames++;
                } else if (jumpHoldFrames >= JUMP_EXTRA_FRAMES) {
                    isJumping = false;
                }
                // ÈôêÂà∂ÊúÄÈ´ò‰∏äÂçá250ÂÉèÁ¥†
                if (isJumping && jumpStartY - this.y >= 250) {
                    isJumping = false;
                    if (this.vy < 0) this.vy = 0; // Á´ãÂç≥ÂÅúÊ≠¢‰∏äÂçá
                }
            },
            
            // Áé©ÂÆ∂Â∞ÑÊìä
            shoot: function() {
                if (playerDead) return; // Ê≠ª‰∫°ÊôÇ‰∏çËÉΩÂ∞ÑÊìä
                if (!canShoot) return;
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                    return;
                }
                // Â¶ÇÊûúÈõÜÊ∞£ÂΩàÂç≥Â∞áÁôºÂ∞ÑÔºå‰∏çÁôºÂ∞ÑÊôÆÈÄöÂ≠êÂΩà
                if (chargeReady) return;
                // ÈõÜÊ∞£ÁãÄÊÖã‰∏ãÔºåÂè™ÊúâÈõÜÊ∞£Ë∂ÖÈÅé0.7ÁßíÊâç‰∏çÁôºÂ∞ÑÊôÆÈÄöÂ≠êÂΩà
                if (charging && chargeFrame >= CHARGE_CANCEL_FRAME) return;
                if (this.isShooting && this.shootCooldown === 0) {
                    bullets.push({
                        x: this.x + (this.direction === 1 ? this.width : -10),
                        y: this.y + this.height / 2 - 3,
                        width: 10,
                        height: 6,
                        speed: 10 * 1.1 * this.direction, // 1.1ÂÄç
                        color: '#b3f0ff',
                        isCharge: false
                    });
                    this.shootCooldown = this.shootDelay;
                }
            },
            
            // ÂèóÂÇ∑ËôïÁêÜ
            takeDamage: function(amount) {
                if (isWinInvincible) return;
                if (this.invincible > 0) return;
                // Êí≠ÊîæÂèóÂÇ∑Èü≥Êïà
                const hurtAudio = document.getElementById('hurt-audio');
                if (hurtAudio) {
                    hurtAudio.currentTime = 0;
                    hurtAudio.volume = VOLUME_HURT;
                    if (isSfxOn) hurtAudio.play();
                }
                playerHealth -= amount;
                updateHealthBar();
                this.invincible = 30; // 30ÂπÄÁÑ°ÊïµÊôÇÈñì
                if (playerHealth <= 0) {
                    gameOver();
                }
            }
        };
        const players = [player];
        
        // ===== Â≠êÂΩàÁ≥ªÁµ± =====
        const bullets = [];
        const enemyBullets = [];
        
        // ===== Êïµ‰∫∫È°ûÂûã =====
        // Èô§ÈåØÔºöÂÆöÁæ©ÊâÄÊúâÂ∞èÂÖµÁöÑÂ±¨ÊÄßËàáË°åÁÇ∫ÔºåÊñπ‰æøÁµ±‰∏ÄÁÆ°ÁêÜËàáÊì¥ÂÖÖ
        const ENEMY_TYPES = {
            // È£õË°åÁ≥ªÂàóÔºàÂúìÂΩ¢Ôºâ
            FLY_RED: {
                color: '#f44', // È°èËâ≤
                speed: 1.5 * 1.1, // ÁßªÂãïÈÄüÂ∫¶
                health: 1, // Ë°ÄÈáè
                score: 60, // ÊìäÊÆ∫ÂæóÂàÜ
                behavior: function(enemy) { // Ë°åÁÇ∫ÂáΩÊï∏
                    enemy.x -= enemy.speed;
                    // Â∞èÂπÖÂ∫¶‰∏ä‰∏ã
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 600 + enemy._id) * 18;
                },
                isFlying: true, // ÊòØÂê¶ÁÇ∫È£õË°åÊïµ‰∫∫
                eye: { color: '#222', type: 'circle' } // ÁúºÁùõÊ®£Âºè
            },
            FLY_ORANGE: {
                color: '#f84', // È°èËâ≤
                speed: 2.25 * 1.1, // ÁßªÂãïÈÄüÂ∫¶
                health: 1, // Ë°ÄÈáè
                score: 80, // ÊìäÊÆ∫ÂæóÂàÜ
                behavior: function(enemy) { // Ë°åÁÇ∫ÂáΩÊï∏
                    enemy.x -= enemy.speed;
                    // Â§ßÂπÖÂ∫¶‰∏ä‰∏ã
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 300 + enemy._id) * 48;
                },
                isFlying: true, // ÊòØÂê¶ÁÇ∫È£õË°åÊïµ‰∫∫
                eye: { color: '#222', type: 'circle' } // ÁúºÁùõÊ®£Âºè
            },
            // Âú∞‰∏äÁ≥ªÂàóÔºàÂçäÂúìÂΩ¢Ôºâ
            GROUND_RED: {
                color: '#f44', // È°èËâ≤
                speed: 0.75 * 1.1, // ÁßªÂãïÈÄüÂ∫¶
                health: 1, // Ë°ÄÈáè
                score: 50, // ÊìäÊÆ∫ÂæóÂàÜ
                behavior: function(enemy) { // Ë°åÁÇ∫ÂáΩÊï∏
                    enemy.x -= enemy.speed;
                },
                isFlying: false, // ÊòØÂê¶ÁÇ∫È£õË°åÊïµ‰∫∫
                eye: { color: '#222', type: 'semi' } // ÁúºÁùõÊ®£Âºè
            },
            GROUND_ORANGE: {
                color: '#f84', // È°èËâ≤
                speed: 0.75 * 1.1, // ÁßªÂãïÈÄüÂ∫¶
                health: 1, // Ë°ÄÈáè
                score: 70, // ÊìäÊÆ∫ÂæóÂàÜ
                behavior: function(enemy) { // Ë°åÁÇ∫ÂáΩÊï∏
                    enemy.x -= enemy.speed;
                    if (enemy.onGround && Math.random() < 0.02) {
                        enemy.vy = -12;
                        enemy.onGround = false;
                    }
                },
                isFlying: false, // ÊòØÂê¶ÁÇ∫È£õË°åÊïµ‰∫∫
                eye: { color: '#222', type: 'semi' } // ÁúºÁùõÊ®£Âºè
            },
            GROUND_PINK: {
                color: '#f8c', // È°èËâ≤
                speed: 0, // ÁßªÂãïÈÄüÂ∫¶
                health: 1, // Ë°ÄÈáè
                score: 100, // ÊìäÊÆ∫ÂæóÂàÜ
                shootDelay: Math.round(120), // Â∞ÑÊìäÈñìÈöî Êï∏Â≠óË∂äÂ∞èÂ∞ÑÊìäË∂äÂø´
                behavior: function(enemy) { // Ë°åÁÇ∫ÂáΩÊï∏
                    // Âõ∫ÂÆöÈªûÂ∞ÑÊìä
                    if (enemy.shootCooldown > 0) {
                        enemy.shootCooldown--;
                    } else {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (enemy.y + enemy.height/2),
                            player.x + player.width/2 - (enemy.x + enemy.width/2)
                        );
                        // Â∞ÑÊìäÊ¨°Êï∏Ê∏õÂçäÔºåÂéüÊú¨1ÁôºÔºåÁèæÂú®ÊØè2Ê¨°ÊâçÂ∞Ñ1Áôº
                        if (!enemy._shootToggle) enemy._shootToggle = false;
                        enemy._shootToggle = !enemy._shootToggle;
                        if (enemy._shootToggle) {
                            enemyBullets.push({
                                x: enemy.x + enemy.width/2 - 3,
                                y: enemy.y + enemy.height/2 - 3,
                                width: 6,
                                height: 6,
                                speedX: Math.cos(angle) * 1.3,
                                speedY: Math.sin(angle) * 1.3,
                                color: '#f8c'
                            });
                        }
                        enemy.shootCooldown = enemy.shootDelay;
                    }
                },
                isFlying: false, // ÊòØÂê¶ÁÇ∫È£õË°åÊïµ‰∫∫
                eye: { color: '#fff', type: 'semi' } // ÁúºÁùõÊ®£Âºè
            }
        };
        
        // ===== Êïµ‰∫∫Èô£Âàó =====
        const enemies = [];
        // ===== Êïµ‰∫∫ÈñÉÁàçÁãÄÊÖã =====
        const enemyHitFlash = new WeakMap(); // Map<enemy, frame>
        
        // ===== Boss Áâ©‰ª∂ =====
        const boss = {
            x: 2500 + 2700 * 1,
            y: 350, // Âõ∫ÂÆöÂàùÂßãÂ∫ßÊ®ô
            width: 100,
            height: 100,
            speed: 2 * 1.1, // 1.1ÂÄç
            vy: 0, // ‰∏çÂÜçÈúÄË¶ÅÈáçÂäõ
            color: '#2196f3', // ‰∏ªÈ´îËóçËâ≤ÔºàAirman‰∏ªËâ≤Ôºâ
            shootCooldown: 0,
            shootDelay: Math.round(200 / 1.1), // ÈñìÈöîÁ∏ÆÁü≠
            pattern: 0,
            patternTimer: 0,
            health: 300,
            maxHealth: 300,
            onGround: false, // ‰∏çÂÜçÈúÄË¶ÅonGround
            pauseTimer: 0, // Êñ∞Â¢ûÔºöÊö´ÂÅúË®àÊôÇÂô®
            
            // Boss Ë°åÁÇ∫Ê®°Âºè
            update: function() {
                // Êñ∞Â¢ûÔºöÊö´ÂÅúÁãÄÊÖã
                if (this.pauseTimer > 0) {
                    this.pauseTimer--;
                    return;
                }
                // Ê®°ÂºèË®àÊôÇÂô®
                this.patternTimer++;
                if (this.patternTimer > 180) {
                    this.pattern = (this.pattern + 1) % 4;
                    this.patternTimer = 0;
                }
                if (!bossCanMove) return; // 0.7ÁßíÂÖß‰∏çËÉΩÁßªÂãï
                // ‰∏çÂèóÈáçÂäõÂΩ±ÈüøÔºåÁõ¥Êé•Ê†πÊìöË°åÁÇ∫Ê®°ÂºèË™øÊï¥yÂ∫ßÊ®ô
                switch (this.pattern) {
                    case 0: // ‰∏ä‰∏ãÁßªÂãï
                        this.y += this.speed;
                        if (this.y < 50 || this.y > 350) { // bossÂá∫Â†¥ÂæåÁöÑÊúÄÂ∫ïÁØÑÂúç
                            this.speed *= -1;
                        }
                        break;
                    case 1: // ËøΩËπ§Áé©ÂÆ∂
                        if (this.y < player.y) {
                            this.y += this.speed;
                        } else if (this.y > player.y) {
                            this.y -= this.speed;
                        }
                        break;
                    case 2: // Âø´ÈÄü‰∏ä‰∏ãÁßªÂãï
                        if (this.patternTimer % 60 < 30) {
                            this.y -= 8; // Âêë‰∏äÈ£Ñ
                        } else {
                            this.y += 8; // Âêë‰∏ãÈ£Ñ
                        }
                        // ÈôêÂà∂ÁØÑÂúç
                        this.y = Math.max(50, Math.min(350, this.y)); // bossÂá∫Â†¥ÂæåÁöÑÊúÄÂ∫ïÁØÑÂúç
                        break;
                    case 3: // Ë°ùÂà∫ÊîªÊìä
                        if (this.patternTimer < 60) {
                            this.x -= 5;
                        } else if (this.patternTimer < 120) {
                            this.x += 5;
                        }
                        break;
                }
                // Boss Â∞ÑÊìä
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                } else if (bossCanAttack) {
                    // ‰∏âÊñπÂêëÂ∞ÑÊìä
                    for (let i = -1; i <= 1; i++) {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (this.y + this.height/2),
                            player.x + player.width/2 - (this.x + this.width/2)
                        ) + (i * 0.3);
                        enemyBullets.push({
                            x: this.x + this.width/2 - 3.4125,
                            y: this.y + this.height/2 - 13.65,
                            width: 10,
                            height: 20,
                            speedX: Math.cos(angle) * 3,
                            speedY: Math.sin(angle) * 3,
                            color: '#f4a'
                        });
                    }
                    this.shootCooldown = this.shootDelay; // ‚Üê ÊØèÊ¨°ÁôºÂ∞ÑÂæåÈáçË®≠ÂÜ∑Âçª
                }
                // === Âä†ÂÖ•ÈÇäÁïåÈôêÂà∂ ===
                this.x = Math.max(BOSS_AREA_X, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(350, this.y)); // bossÂá∫Â†¥ÂæåÁöÑÊúÄÂ∫ïÁØÑÂúç
            }
        };
        const bosses = [boss];
        
        // ===== Âπ≥Âè∞Èô£Âàó =====
        const platforms = basePlatforms.slice();
        
        // ===== ÊéßÂà∂Á≥ªÁµ± =====
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            ' ': false,
            'Enter': false
        };
        
        // ===== ‰∫ã‰ª∂Áõ£ËÅΩ =====
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        playAgainButton.addEventListener('click', startGame);
        
        // Ë∑≥Ë∫çÈçµÊåâ‰∏ãÊôÇÈñìË®òÈåÑ
        let jumpKeyDownTime = 0;
        let jumpKeyPressed = false;
        let isJumping = false;
        let jumpHoldFrames = 0;
        const jumpMaxHoldTime = 300; // ÊúÄÈï∑0.3Áßí
        let jumpStartY = 0; // Ëµ∑Ë∑≥ÊôÇyÂ∫ßÊ®ô
        
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
                if (e.key === 'ArrowUp' && !jumpKeyPressed) {
                    jumpKeyDownTime = Date.now();
                    jumpKeyPressed = true;
                }
                if (e.key === 'Enter' && !gameRunning) {
                    startGame();
                }
                if (e.key === ' ' && gameRunning) {
                    // Êåâ‰∏ãÁ©∫ÁôΩÈçµÔºåÁ´ãÂç≥ÂïüÂãïÊôÆÈÄöÂ∞ÑÊìä
                    if (!charging) {
                        charging = true;
                        chargeFrame = 0;
                        chargeReady = false;
                        player.isShooting = true;
                        // Êí≠ÊîæÂ∞ÑÊìäÈü≥Êïà
                        const shootAudio = document.getElementById('shoot-audio');
                        if (shootAudio) {
                            shootAudio.currentTime = 0;
                            shootAudio.volume = VOLUME_SHOOT;
                            if (isSfxOn) shootAudio.play();
                        }
                        // Âª∂ÈÅ≤0.5ÁßíÂæåÊâçÊí≠ÊîæÈõÜÊ∞£Èü≥Êïà
                        if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                        chargeAudioTimeout = setTimeout(() => {
                            if (charging) {
                                const chargeAudio = document.getElementById('charge-audio');
                                if (chargeAudio) {
                                    chargeAudio.currentTime = 0;
                                    chargeAudio.volume = VOLUME_CHARGE;
                                    if (isSfxOn) chargeAudio.play();
                                }
                            }
                        }, 500);
                    }
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
                if (e.key === 'ArrowUp' && jumpKeyPressed) {
                    const pressDuration = Date.now() - jumpKeyDownTime;
                    if (pressDuration < 200 && player.vy < 0) {
                        // 0.2Áßí‰ª•‰∏ãÔºå1/4È´òÂ∫¶
                        player.vy /= 4;
                    } else if (pressDuration < 300 && player.vy < 0) {
                        // 0.2~0.3ÁßíÔºå1/3È´òÂ∫¶
                        player.vy /= 3;
                    } else if (pressDuration < 400 && player.vy < 0) {
                        // 0.3~0.4ÁßíÔºå‰∏ÄÂçäÈ´òÂ∫¶
                        player.vy /= 2;
                    }
                    // Ë∂ÖÈÅé0.4ÁßíÔºåÁ∂≠ÊåÅÂéüÊú¨ÊúÄÈ´òÈ´òÂ∫¶
                    jumpKeyPressed = false;
                }
                if (e.key === ' ') {
                    // ÊîæÈñãÁ©∫ÁôΩÈçµÊôÇÔºåÊ†πÊìöÈõÜÊ∞£ÊôÇÈñìÊ±∫ÂÆöÁôºÂ∞Ñ‰ªÄÈ∫º
                    if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                        chargeReady = true; // ÁôºÂ∞ÑÈõÜÊ∞£ÂΩà
                    } else if (charging && chargeFrame < CHARGE_CANCEL_FRAME && !chargeReady) {
                        // Âè™Êúâ chargeReady ÁÇ∫ false ÊâçË£úÁôºÊôÆÈÄöÂΩà
                        player.isShooting = true;
                    }
                    charging = false;
                    setTimeout(() => { player.isShooting = false; }, 0); // ‰∏ã‰∏ÄÂπÄÈóúÈñâÊôÆÈÄöÂ∞ÑÊìä
                    // ÂÅúÊ≠¢ÈõÜÊ∞£Èü≥Êïà
                    if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                    const chargeAudio = document.getElementById('charge-audio');
                    if (chargeAudio) {
                        chargeAudio.pause();
                        chargeAudio.currentTime = 0;
                        chargeAudio.volume = VOLUME_CHARGE;
                    }
                }
            }
        });
        
        // ===== ÈÅäÊà≤ÂàùÂßãÂåñ =====
        const bgm = document.getElementById('bgm');
        /**
         * ÈÅäÊà≤ÂàùÂßãÂåñÔºåÈáçË®≠ÊâÄÊúâÁãÄÊÖã‰∏¶ÈñãÂßãÈÅäÊà≤‰∏ªÂæ™Áí∞
         */
        function startGame() {
            // ÂÅúÊ≠¢outroÈü≥Ê®Ç
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.pause();
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                outroAudio.onended = null;
            }
            // Èü≥Ê®ÇÊí≠ÊîæÊéßÂà∂
            if (bgm) {
                bgm.currentTime = 0;
                bgm.volume = VOLUME_BGM;
                if (isBgmOn) bgm.play();
            }
            // ÈáçÁΩÆÈÅäÊà≤ÁãÄÊÖã
            gameRunning = true;
            score = 0;
            playerHealth = playerMaxHealth;
            boss.health = boss.maxHealth;
            boss.x = 2500 + 2700 * 1;
            boss.y = 350;
            bossActive = false;
            reachedBossArea = false;
            
            // ÈáçÁΩÆÁé©ÂÆ∂‰ΩçÁΩÆ
            player.x = startx;
            player.y = starty;
            player.vy = 0;
            player.onGround = true;
            player.direction = 1;
            player.invincible = 0;
            
            // Ê∏ÖÁ©∫Èô£Âàó
            bullets.length = 0;
            enemyBullets.length = 0;
            enemies.length = 0;
            
            // Èö±Ëóè‰ªãÈù¢ÂÖÉÁ¥†
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            bossHealthContainer.style.display = 'none';
            
            // Êõ¥Êñ∞UI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // ÂïüÂãïÈÅäÊà≤Âæ™Áí∞
            requestAnimationFrame(gameLoop);
            langToggle.style.display = 'none';
            langSelect.style.display = 'none';
            canShoot = false;
            charging = false;
            player.isShooting = false;
            chargeFrame = 0;
            chargeReady = false;
            if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
            setTimeout(() => { canShoot = true; }, 200);
            playerDead = false; // ÈáçË®≠Ê≠ª‰∫°ÁãÄÊÖã
            playerDeadX = 0;
            playerDeadY = 0;
            bossDefeated = false;
            isWinInvincible = false;
        }
        
        // ===== ÈÅäÊà≤‰∏ªÂæ™Áí∞ =====
        let lastFrameTime = 0;
        function getFrameDuration() {
            return 1000 / MAX_FPS;
        }

        /**
         * ÈÅäÊà≤‰∏ªÂæ™Áí∞ÔºåÊØè‰∏ÄÂπÄÂëºÂè´‰∏ÄÊ¨°
         * @param {DOMHighResTimeStamp} now - Áï∂ÂâçÊôÇÈñìÊà≥ÔºàÁî±requestAnimationFrameÂÇ≥ÂÖ•Ôºâ
         */
        function gameLoop(now) {
            requestAnimationFrame(gameLoop);
            if (isPaused) return; // Êö´ÂÅúÊôÇ‰∏çÊõ¥Êñ∞ÈÅäÊà≤
            if (now - lastFrameTime < getFrameDuration()) return;
            lastFrameTime = now;
            update();
            render();
            updateFPS();
        }
        
        // ===== ÈÅäÊà≤ÁãÄÊÖãÊõ¥Êñ∞ =====
        /**
         * Êõ¥Êñ∞ÈÅäÊà≤ÊâÄÊúâÁãÄÊÖãÔºàÁé©ÂÆ∂„ÄÅÊïµ‰∫∫„ÄÅÂ≠êÂΩà„ÄÅBossÁ≠âÔºâ
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function update() {
            // ÈõÜÊ∞£ÁãÄÊÖãË®àÊï∏
            if (charging) {
                chargeFrame++;
            }
            // ÂÖàËôïÁêÜÈõÜÊ∞£ÂΩà
            if (chargeReady) {
                // ÁôºÂ∞ÑÈõÜÊ∞£ÂΩà
                bullets.push({
                    x: player.x + (player.direction === 1 ? player.width : -40),
                    y: player.y + player.height / 2 - 12,
                    width: 40,
                    height: 24,
                    speed: 10 * 1.1 * player.direction, // 1.1ÂÄç
                    color: '#ff0',
                    isCharge: true // Ê®ôË®òÁÇ∫ÈõÜÊ∞£ÂΩà
                });
                player.shootCooldown = player.shootDelay; // Áµ¶‰∏ÄÈªûÂÜ∑Âçª
                // Êí≠ÊîæshootÈü≥Êïà
                const shootAudio = document.getElementById('shoot-audio');
                if (shootAudio) {
                    shootAudio.currentTime = 0;
                    shootAudio.volume = VOLUME_SHOOT;
                    shootAudio.play();
                }
                chargeReady = false;
            }
            // Êõ¥Êñ∞Áé©ÂÆ∂
            player.update();
            player.shoot();
            
            // Áõ£ÊéßÁé©ÂÆ∂‰ΩçÁΩÆ - ÂÉÖÂú®Êìç‰ΩúÊñπÂêëÈçµÊôÇËº∏Âá∫
            if (keys.ArrowLeft || keys.ArrowRight || keys.ArrowUp) {
                // console.log('Áé©ÂÆ∂‰ΩçÁΩÆ:', { x: player.x, y: player.y, onGround: player.onGround });
            }
            
            // Êõ¥Êñ∞Èè°È†≠
            camera.follow(player);
            
            // BossÂçÄÂüüÊïàÊûú
            if (player.x >= BOSS_AREA_X && !bossActive && bossTimer === 0 && !isWinScreen && !bossDefeated) {
                // ÂÖà‰∏çÈ°ØÁ§∫Ê≠£ÂºèbossË°ÄÊ¢ù
                bossHealthContainer.style.display = 'none';
                // ÂÖàÁßªÈô§ÊâÄÊúâËàäÁöÑ fake hp Ê¢ù
                let oldFakeBar = document.getElementById('boss-fake-bar');
                if (oldFakeBar) oldFakeBar.remove();
                // Êñ∞ fake hp Ê¢ùÂãïÁï´
                let fakeBar = document.createElement('div');
                fakeBar.style.position = 'absolute';
                fakeBar.style.top = '10px';
                fakeBar.style.right = '10px';
                fakeBar.style.width = '200px';
                fakeBar.style.height = '20px';
                fakeBar.style.background = '#333';
                fakeBar.style.border = '2px solid #444';
                fakeBar.style.zIndex = 5;
                fakeBar.id = 'boss-fake-bar';
                let fakeFill = document.createElement('div');
                fakeFill.style.height = '100%';
                fakeFill.style.width = '1%';
                fakeFill.style.background = '#ccc';
                fakeFill.style.transition = 'none';
                fakeBar.appendChild(fakeFill);
                document.getElementById('game-container').appendChild(fakeBar);
                let animPercent = 1;
                const animStep = (100 - 1) / (1500 / 16); // 1.5Áßí 1%~100%
                const anim = setInterval(() => {
                    animPercent += animStep;
                    if (animPercent >= 100) {
                        animPercent = 100;
                        clearInterval(anim);
                        // ÁßªÈô§ fake hp Ê¢ùÔºåÈ°ØÁ§∫Ê≠£Âºè boss hp Ê¢ù
                        let oldFakeBar2 = document.getElementById('boss-fake-bar');
                        if (oldFakeBar2) oldFakeBar2.remove();
                        bossHealthContainer.style.display = 'block';
                        updateBossHealthBar();
                    }
                    fakeFill.style.width = animPercent + '%';
                }, 16);
                bossTimer = 1;
                enemies.length = 0;
                enemyBullets.length = 0;
            }
            
            // Ë®àÊôÇÂô®ÈÅãË°åÔºå3 ÁßíÂæåÊøÄÊ¥ª BOSS
            if (bossTimer > 0 && bossTimer < 250) {
                bossTimer++;
                if (bossTimer === 100) {
                    // Êí≠ÊîæbossÂá∫Â†¥Èü≥Êïà bosstimer ÊòØbossÂá∫Â†¥Âª∂ÈÅ≤ÊôÇÈñì
                    const bossAudio = document.getElementById('boss-audio');
                    if (bossAudio) {
                        bossAudio.currentTime = 0;
                        bossAudio.volume = VOLUME_BOSS;
                        if (isSfxOn) bossAudio.play();
                    }
                    // Âª∂ÈÅ≤0.4ÁßíÂæåÊâçËÆìbossÂá∫Áèæ
                    setTimeout(() => {
                        bossActive = true;
                        bossTimer = 0;
                        bossCanAttack = false;
                        bossCanMove = false;
                        setTimeout(() => {
                            bossCanAttack = true;
                            bossCanMove = true;
                        }, 700);
                    }, 400);
                }
            }
            
            // ÁîüÊàêÊïµ‰∫∫
            if (Math.random() < 0.015 && enemies.length < 8 && !bossActive && player.x < WORLD_WIDTH - 1000) {
                // Âè™ÂæûÊñ∞ÂÖ≠Á®ÆÂ∞èÊÄ™Èö®Ê©üÈÅ∏‰∏ÄÁ®Æ
                const enemyTypes = Object.values(ENEMY_TYPES);
                let type;
                let tryCount = 0;
                do {
                    type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    // Â¶ÇÊûúÊòØÁ≤âÁ¥ÖËâ≤Âú∞Èù¢ÊÄ™ÔºåÂè™ÊúâÁé©ÂÆ∂ÂæÄÂè≥ÊôÇÊâçÂÖÅË®±ÁîüÊàê
                    if (type === ENEMY_TYPES.GROUND_PINK && !keys.ArrowRight) {
                        tryCount++;
                        continue;
                    }
                    break;
                } while (tryCount < 10);
                // Áµ¶ÊØèÈöªÊïµ‰∫∫‰∏ÄÂÄãÂîØ‰∏Ä id ‰æõÈ£ÑÊµÆÁî®
                const enemy = {
                    x: camera.x + camera.width + 50, // ÂàùÂßãXÂ∫ßÊ®ôÔºàÁîüÊàêÂú®Èè°È†≠Âè≥ÂÅ¥Ôºâ
                    y: type.isFlying ? (Math.random() * (WORLD_HEIGHT - 200) + 50) : (Math.random() * (WORLD_HEIGHT - 100) + 50), // ÂàùÂßãYÂ∫ßÊ®ô
                    width: 30, // ÂØ¨Â∫¶
                    height: 30, // È´òÂ∫¶
                    speed: type.speed, // ÁßªÂãïÈÄüÂ∫¶
                    health: 3, // Áï∂ÂâçË°ÄÈáè
                    maxHealth: 3, // ÊúÄÂ§ßË°ÄÈáè
                    score: type.score, // ÊìäÊÆ∫ÂæóÂàÜ
                    color: type.color, // È°èËâ≤
                    behavior: type.behavior, // Ë°åÁÇ∫ÂáΩÊï∏
                    onGround: false, // ÊòØÂê¶Âú®Âú∞Èù¢‰∏ä
                    vy: 0, // ÂûÇÁõ¥ÈÄüÂ∫¶
                    shootCooldown: (type === ENEMY_TYPES.GROUND_PINK) ? 50 : 0, // Á≤âËâ≤Â∞èÂÖµÁ¨¨‰∏ÄÁôºÂª∂ÈÅ≤50ÂÅµÔºåÂÖ∂È§òÁÇ∫0
                    shootDelay: type.shootDelay || 0, // Â∞ÑÊìäÈñìÈöî
                    isFlying: type.isFlying, // ÊòØÂê¶ÁÇ∫È£õË°åÊïµ‰∫∫
                    eye: type.eye, // ÁúºÁùõÊ®£Âºè
                    _id: Math.random() * 1000000 | 0, // ÂîØ‰∏ÄIDÔºàÈ£ÑÊµÆÁî®Ôºâ
                    dying: false, // ÊòØÂê¶ÈÄ≤ÂÖ•Ê≠ª‰∫°ÈñÉÁàç
                    dyingFrame: 0 // Ê≠ª‰∫°ÈñÉÁàçË®àÊï∏
                };
                enemies.push(enemy);
            }
            
            // Êõ¥Êñ∞Êïµ‰∫∫
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (enemy.isFloating) {
                    // È£ÑÊµÆÂ∞èÂÖµÔºö‰∏ä‰∏ãÈ£ÑÂãïÔºå‰∏çÂèóÈáçÂäõËàáÂπ≥Âè∞ÂΩ±Èüø
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 400 + i) * 40;
                    enemy.x -= enemy.speed;
                } else {
                    // ÂéüÊú¨Âú∞Èù¢Â∞èÂÖµ
                    enemy.vy += GRAVITY;
                    let newY = enemy.y + enemy.vy;
                    enemy.onGround = false;
                    for (let p of platforms) {
                        const overlapX = enemy.x + enemy.width > p.x && enemy.x < p.x + p.width;
                        if (overlapX && enemy.y + enemy.height <= p.y && newY + enemy.height >= p.y) {
                            newY = p.y - enemy.height;
                            enemy.vy = 0;
                            enemy.onGround = true;
                        }
                    }
                    enemy.y = newY;
                    enemy.behavior(enemy);
                }
                // Êõ¥Êñ∞Êïµ‰∫∫ÈñÉÁàçÁãÄÊÖã
                if (enemyHitFlash.has(enemy)) {
                    let frame = enemyHitFlash.get(enemy);
                    frame--;
                    if (frame <= 0) {
                        enemyHitFlash.delete(enemy);
                    } else {
                        enemyHitFlash.set(enemy, frame);
                    }
                }
                // ÁßªÈô§Â±èÂπïÂ§ñÁöÑÊïµ‰∫∫
                if (enemy.x < camera.x - 100 || enemy.x > camera.x + camera.width + 100) {
                    enemies.splice(i, 1);
                    continue;
                }
                // Ê™¢Ê∏¨Áé©ÂÆ∂Á¢∞Êíû
                if (checkCollision(player, enemy)) {
                    if (enemy.health > 0) {
                        player.takeDamage(10);
                    }
                    // Â∞èÂÖµ‰∏çÊúÉÂõ†Á¢∞ÊíûÁé©ÂÆ∂ËÄåÊ∂àÂ§±
                    continue;
                }
                // Âú®Êïµ‰∫∫Êõ¥Êñ∞ÊôÇÔºåËôïÁêÜÊ≠ª‰∫°ÈñÉÁàçËàáËá™ÂãïÊ∂àÂ§±
                if (enemy.dying) {
                    enemy.dyingFrame++;
                    // ÈñÉÁàçÂÖ©‰∏ãÔºà12ÂπÄÔºåÁ¥Ñ0.2ÁßíÔºâÂæåËá™ÂãïÊ∂àÂ§±
                    if (enemy.dyingFrame >= 12) {
                        enemies.splice(i, 1);
                        score += enemy.score;
                        updateScore();
                        continue;
                    }
                }
            }
            
            // Êõ¥Êñ∞Boss
            if (bossActive) {
                boss.update();
                
                // Ê™¢Ê∏¨Áé©ÂÆ∂Á¢∞Êíû
                if (checkCollision(player, boss)) {
                    player.takeDamage(15);
                }
            }
            
            // Êõ¥Êñ∞Â≠êÂΩà
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.speed;
                
                // ÁßªÈô§Â±èÂπïÂ§ñÁöÑÂ≠êÂΩà
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // Ê™¢Ê∏¨Êïµ‰∫∫Á¢∞Êíû
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        if (bullet.isCharge) {
                            enemy.health -= weaponPower * 5; // ÈõÜÊ∞£ÂΩàÊîªÊìäÂäõ5ÂÄç
                        } else {
                            enemy.health -= weaponPower * 1.5; // ÊôÆÈÄöÂ≠êÂΩàÊîªÊìäÂäõ
                        }
                        enemyHitFlash.set(enemy, 12); // 0.2ÁßíÈñÉÁàç
                        // Êí≠ÊîæboomÈü≥ÊïàÔºàÈõÜÊ∞£ÂΩà‰πüÊúâÔºâ
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            const clone = boomAudio.cloneNode();
                            clone.volume = VOLUME_BOOM;
                            if (isSfxOn) clone.play();
                        }
                        if (enemy.health <= 0 && !enemy.dying) {
                            enemy.dying = true;
                            enemy.dyingFrame = 0;
                        }
                        bullets.splice(i, 1);
                        break;
                    }
                }
                
                // Ê™¢Ê∏¨BossÁ¢∞Êíû
                if (bossActive && checkCollision(bullet, boss)) {
                    if (bullet.isCharge) {
                        boss.health -= weaponPower * 3; // ÈõÜÊ∞£ÂΩàÊîªÊìäÂäõ3ÂÄç
                        boss.pauseTimer = 42; // Êö´ÂÅú42ÂÅµ
                        boss.lastHitCharge = true; // ÈõÜÊ∞£ÂΩà
                    } else {
                        boss.health -= weaponPower; // ÊôÆÈÄöÂ≠êÂΩàÊîªÊìäÂäõ
                        boss.lastHitCharge = false; // Êñ∞Â¢ûÔºöË®òÈåÑÈÄôÊ¨°‰∏çÊòØÈõÜÊ∞£ÂΩà
                    }
                    bossHitFlash = 12; // 0.2ÁßíÈñÉÁàç
                    updateBossHealthBar();
                    if (boss.health > 0) {
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            boomAudio.currentTime = 0;
                            boomAudio.volume = VOLUME_BOOM;
                            if (isSfxOn) boomAudio.play();
                        }
                    }
                    bullets.splice(i, 1);
                    score += bullet.isCharge ? 100 : 20;
                    updateScore();
                    if (boss.health <= 0) {
                        boss.health = 0;
                        updateBossHealthBar();
                        bossActive = false;
                        bossDefeated = true;
                        gameRunning = false;
                        enemyBullets.length = 0; // Êñ∞Â¢ûÔºöBossÊ≠ª‰∫°ÊôÇÊ∏ÖÁ©∫ÊâÄÊúâÊïµÊñπÂ≠êÂΩà
                        // ÂÅúÊ≠¢BGM
                        if (bgm) {
                            bgm.pause();
                            bgm.currentTime = 0;
                        }
                        // Êí≠ÊîæbossdieÈü≥Êïà
                        const bossdieAudio = document.getElementById('bossdie-audio');
                        if (bossdieAudio) {
                            bossdieAudio.currentTime = 0;
                            bossdieAudio.volume = VOLUME_BOSSDIE;
                            if (isSfxOn) bossdieAudio.play();
                        }
                        // 1. ÈªÉÁôΩÈñÉÁàç2Áßí
                        const flashDiv = document.getElementById('flash-effect');
                        const winScreen = document.getElementById('win-screen');
                        // ===== Êñ∞Â¢û fakeBoss =====
                        fakeBoss = {
                            x: boss.x,
                            y: boss.y,
                            width: boss.width,
                            height: boss.height,
                            color: boss.color
                        };
                        fakeBossFlashFrame = 0;
                        setTimeout(() => { fakeBoss = null; }, 2000);
                        // =========================
                        if (flashDiv) {
                            flashDiv.style.display = 'block';
                            let flashFrame = 0;
                            flashDiv.style.opacity = 1;
                            const flashInterval = setInterval(() => {
                                flashDiv.style.background = (flashFrame % 2 === 0) ? 'rgba(255,255,0,0.7)' : 'rgba(255,255,255,0.7)';
                                flashFrame++;
                            }, 100);
                            setTimeout(() => {
                                clearInterval(flashInterval);
                                // 2. 3ÁßíÊº∏Â±§ËÆäÂÖ®ÁôΩ
                                let opacity = 0.7;
                                flashDiv.style.background = '#fff';
                                const fadeInStep = 0.0067; // 0.0067*20ms*150Ê¨° ‚âà 1
                                const fadeIn = setInterval(() => {
                                    opacity += fadeInStep;
                                    flashDiv.style.opacity = opacity;
                                    if (opacity >= 1) {
                                        clearInterval(fadeIn);
                                        // 3. ÂÖ®ÁôΩÊôÇÊí≠Êîæoutro‰∏¶È°ØÁ§∫ÂãùÂà©Áï´Èù¢ÔºåÂãùÂà©Áï´Èù¢opacity=0
                                        // Âª∂ÈÅ≤120ÂπÄÔºàÁ¥Ñ2ÁßíÔºâÂÜçÈ°ØÁ§∫ÂãùÂà©Áï´Èù¢
                                        setTimeout(() => {
                                            winGame();
                                            winScreen.style.opacity = 0;
                                            // Êí≠ÊîæoutroÈü≥Ê®Ç
                                            const outroAudio = document.getElementById('outro-audio');
                                            if (outroAudio) {
                                                outroAudio.currentTime = 0;
                                                outroAudio.volume = VOLUME_OUTRO;
                                                if (isBgmOn) outroAudio.play();
                                            }
                                            // 4. 2ÁßíÂÖßÁôΩËâ≤ÈÅÆÁΩ©Ê∑°Âá∫„ÄÅÂãùÂà©Áï´Èù¢ÂêåÊ≠•Ê∑°ÂÖ•
                                            let outOpacity = 1;
                                            let winOpacity = 0;
                                            const fadeOut = setInterval(() => {
                                                outOpacity -= 0.02;
                                                winOpacity += 0.02;
                                                flashDiv.style.opacity = outOpacity;
                                                winScreen.style.opacity = winOpacity;
                                                if (outOpacity <= 0) {
                                                    clearInterval(fadeOut);
                                                    flashDiv.style.display = 'none';
                                                    winScreen.style.opacity = 1;
                                                }
                                            }, 20);
                                        }, 90 * (1000 / MAX_FPS)); // 90ÂπÄÂª∂ÈÅ≤
                                    }
                                }, 20);
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                setTimeout(() => { winGame(); }, 90 * (1000 / MAX_FPS)); // 90ÂπÄÂª∂ÈÅ≤
                            }, 3000);
                        }
                    }
                }
            }
            
            // Êõ¥Êñ∞ÊïµÊñπÂ≠êÂΩà
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                bullet.x += bullet.speedX;
                bullet.y += bullet.speedY;
                
                // ÁßªÈô§Â±èÂπïÂ§ñÁöÑÂ≠êÂΩà
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50 ||
                    bullet.y < camera.y - 50 || bullet.y > camera.y + camera.height + 50) {
                    enemyBullets.splice(i, 1);
                    continue;
                }
                
                // Ê™¢Ê∏¨Áé©ÂÆ∂Á¢∞Êíû
                if (checkCollision(bullet, player)) {
                    player.takeDamage(5);
                    enemyBullets.splice(i, 1);
                }
            }
            
            // Âú®update()ÊúÄÂæåÂä†‰∏äbossHitFlashÈÅûÊ∏õ
            if (bossHitFlash > 0) bossHitFlash--;

            // ÂãùÂà©Áï´Èù¢ÁÑ°ÊïµÁãÄÊÖã‰∏ãÔºåËã•Áé©ÂÆ∂‰∏çÂú®Âú∞ÂúñÂ§ñÔºåÂº∑Âà∂Ê≠∏‰Ωç (0,0)
            if (isWinInvincible) {
                if (!(player.x < 0 || player.x > WORLD_WIDTH || player.y < 0 || player.y > WORLD_HEIGHT)) {
                    player.x = 0;
                    player.y = 0;
                }
            }
        }
        
        // ===== Ê∏≤ÊüìÈÅäÊà≤ =====
        /**
         * Ë≤†Ë≤¨Áπ™Ë£ΩÊâÄÊúâÁï´Èù¢ÂÖÉÁ¥†ÔºàËÉåÊôØ„ÄÅÂπ≥Âè∞„ÄÅÁé©ÂÆ∂„ÄÅÊïµ‰∫∫„ÄÅÂ≠êÂΩà„ÄÅBoss„ÄÅUIÁ≠âÔºâ
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function render() {
            // Ê∏ÖÈô§Áï´Â∏É
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ‰øùÂ≠òÁï∂ÂâçÁãÄÊÖã
            ctx.save();
            
            // ÊáâÁî®Èè°È†≠ËÆäÊèõ
            ctx.translate(-camera.x, -camera.y);
            
            // Áπ™Ë£ΩËÉåÊôØ (Á∞°ÂñÆÁöÑÊòüÁ©∫ÊïàÊûú)
            ctx.fillStyle = '#112';
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
            
            // Áπ™Ë£ΩÊòüÊòü
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 24 + (camera.x / 2)) % WORLD_WIDTH;
                const y = (i * 19 + (camera.y / 2)) % WORLD_HEIGHT;
                const size = 1 + (i % 3);
                ctx.fillRect(x, y, size, size);
            }
            
            // Áπ™Ë£ΩÂπ≥Âè∞
            platforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });
            
            // Áπ™Ë£ΩÁé©ÂÆ∂ (ÁÑ°ÊïµÊôÇÈñÉÁàç)
            if (!playerDead) { // Ê≠ª‰∫°ÊôÇ‰∏çÁπ™Ë£Ω
                if (isWinInvincible) {
                    ctx.globalAlpha = 0.2;
                }
                if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                    if (Math.floor(Date.now() / 100) % 2 === 0) {
                        ctx.fillStyle = '#cfbb3a'; // Ê∑∫ÈªÉËâ≤
                    } else {
                        ctx.fillStyle = player.color;
                    }
                } else {
                    ctx.fillStyle = player.color;
                }
                if (player.invincible <= 0 || Math.floor(player.invincible / 5) % 2 === 0) {
                    ctx.fillRect(player.x, player.y, player.width, player.height);
                    // Âè™Áï´Â§ßÁúºÁôΩÔºå‰∏çÁï´ÁúºÁè†
                    ctx.beginPath();
                    if (player.direction === 1) {
                        ctx.ellipse(player.x + player.width - 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                    } else {
                        ctx.ellipse(player.x + 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
            }
            
            // Áπ™Ë£ΩÂ≠êÂΩà
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                if (bullet.isCharge) {
                    ctx.save();
                    ctx.shadowColor = '#ff0';
                    ctx.shadowBlur = 20;
                    // ÈõÜÊ∞£ÂΩàÔºö‰∏ä‰∏ãÁ™ÑÁöÑÊ©¢Âúì
                    ctx.beginPath();
                    ctx.ellipse(
                        bullet.x + bullet.width / 2,
                        bullet.y + bullet.height / 2,
                        bullet.width / 2,
                        bullet.height / 1.5,
                        0, 0, Math.PI * 2
                    );
                    ctx.fill();
                    ctx.restore();
                } else {
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // Áπ™Ë£ΩÊïµ‰∫∫
            enemies.forEach(enemy => {
                // ÈñÉÁàçÊïàÊûú
                if (enemyHitFlash.has(enemy)) {
                    if (Math.floor(Date.now() / 50) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
                if (enemy.isFlying) {
                    // È£õË°åÊïµ‰∫∫ÔºöÂúìÂΩ¢
                    ctx.save();
                    ctx.beginPath();
                    ctx.ellipse(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, enemy.height/2, 0, 0, Math.PI*2);
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // ÁúºÁùõÔºàÊ©¢ÂúìÂè≥ÂâçÊñπÔºâ
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.75, enemy.y + enemy.height/2, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                } else {
                    // Ë∑ØÈù¢Êïµ‰∫∫ÔºöÂçäÂúìÔºàÊúùÂè≥Ôºâ
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height, enemy.width/2, Math.PI, 0, false);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x, enemy.y + enemy.height);
                    ctx.closePath();
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // ÁúºÁùõÔºàÂ∑¶ÂâçÊñπÔºâ
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.25, enemy.y + enemy.height*0.75, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                }
                ctx.globalAlpha = 1;
                // Âú® render() Áπ™Ë£ΩÊïµ‰∫∫ÊôÇÔºåËã• enemy.dyingÔºåÊ†πÊìö dyingFrame ÈñÉÁàç
                if (enemy.dying) {
                    if (Math.floor(enemy.dyingFrame / 6) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
            });
            
            // Áπ™Ë£ΩBoss
            if (bossActive && !isWinScreen) {
                if (bossHitFlash > 0) {
                    if (boss.lastHitCharge) {
                        // ÈõÜÊ∞£ÂΩàÔºöÈªÉÁôΩÈñÉÁàç
                        ctx.globalAlpha = 1;
                        ctx.save();
                        if (Math.floor(Date.now() / 50) % 2 === 0) {
                            ctx.filter = 'brightness(1.5) sepia(1) hue-rotate(60deg)'; // ÈªÉËâ≤
                        } else {
                            ctx.filter = 'brightness(2)'; // ÁôΩËâ≤
                        }
                    } else {
                        // ÊôÆÈÄöÂΩàÔºöÂéüÊú¨ÁöÑÈÄèÊòéÈñÉÁàç
                        if (Math.floor(Date.now() / 50) % 2 === 0) {
                            ctx.globalAlpha = 0.3;
                        } else {
                            ctx.globalAlpha = 1;
                        }
                    }
                }
                // ‰∏ªÈ´îÔºöÂúìËßíÁü©ÂΩ¢
                const r = 28; // ÂúìËßíÂçäÂæë
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y);
                ctx.lineTo(boss.x + boss.width - r, boss.y);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y, boss.x + boss.width, boss.y + r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + r);
                ctx.quadraticCurveTo(boss.x, boss.y, boss.x + r, boss.y);
                ctx.closePath();
                ctx.fillStyle = boss.color;
                ctx.fill();
                // Â∫ï‰∏ã1/5ÁÇ∫Êõ¥ÈÆÆÊòéÁöÑÈªÉËâ≤
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y + boss.height * 0.8);
                ctx.lineTo(boss.x + boss.width - r, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height * 0.8, boss.x + boss.width, boss.y + boss.height - r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height * 0.8, boss.x + r, boss.y + boss.height * 0.8);
                ctx.closePath();
                ctx.fillStyle = '#ffd600'; // Êõ¥ÈÆÆÊòéÁöÑÈªÉËâ≤
                ctx.fill();
                ctx.restore();
                // ÁúºÁùõÔºà‰∏äÊñπÂÖ©ÂÄãÔºåÁôΩËâ≤ÁúºÁôΩ„ÄÅÁ¥ÖËâ≤ÁúºÁè†Ôºâ
                // Â∑¶Áúº
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // Âè≥Áúº
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // È¢®ÊâáÔºàÈªÉËâ≤ÂúìÂΩ¢Ôºâ
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 20, 0, Math.PI*2);
                ctx.fillStyle = '#ffe082'; // ÈªÉËâ≤
                ctx.fill();
                // È¢®Êâá‰∏≠ÂøÉ
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 7, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.restore();
                ctx.globalAlpha = 1;
                // boss Áπ™Ë£ΩÁµêÊùüÂæåÊÅ¢Âæ© filter
                if (bossHitFlash > 0 && boss.lastHitCharge) {
                    ctx.restore();
                }
                ctx.globalAlpha = 1;
            }
            // ===== Êñ∞Â¢û fakeBoss ÈñÉÁàçÊïàÊûú =====
            if (fakeBoss) {
                fakeBossFlashFrame++;
                ctx.save();
                if (Math.floor(fakeBossFlashFrame / 6) % 2 === 0) {
                    ctx.globalAlpha = 1;
                    ctx.fillStyle = "#fff";
                } else {
                    ctx.globalAlpha = 0.2;
                    ctx.fillStyle = fakeBoss.color;
                }
                // ‰∏ªÈ´îÔºöÂúìËßíÁü©ÂΩ¢
                const r = 28;
                ctx.beginPath();
                ctx.moveTo(fakeBoss.x + r, fakeBoss.y);
                ctx.lineTo(fakeBoss.x + fakeBoss.width - r, fakeBoss.y);
                ctx.quadraticCurveTo(fakeBoss.x + fakeBoss.width, fakeBoss.y, fakeBoss.x + fakeBoss.width, fakeBoss.y + r);
                ctx.lineTo(fakeBoss.x + fakeBoss.width, fakeBoss.y + fakeBoss.height - r);
                ctx.quadraticCurveTo(fakeBoss.x + fakeBoss.width, fakeBoss.y + fakeBoss.height, fakeBoss.x + fakeBoss.width - r, fakeBoss.y + fakeBoss.height);
                ctx.lineTo(fakeBoss.x + r, fakeBoss.y + fakeBoss.height);
                ctx.quadraticCurveTo(fakeBoss.x, fakeBoss.y + fakeBoss.height, fakeBoss.x, fakeBoss.y + fakeBoss.height - r);
                ctx.lineTo(fakeBoss.x, fakeBoss.y + r);
                ctx.quadraticCurveTo(fakeBoss.x, fakeBoss.y, fakeBoss.x + r, fakeBoss.y);
                ctx.closePath();
                ctx.fill();
                ctx.restore();
            }
            
            // Áπ™Ë£ΩÊïµÊñπÂ≠êÂΩà
            enemyBullets.forEach(bullet => {
                // BossÂ≠êÂΩàÔºàtornadoÔºâ
                if (bullet.color === '#f4a') {
                    const tornadoImg = document.getElementById('tornado-img');
                    if (tornadoImg && tornadoImg.complete) {
                        ctx.save();
                        // ÊóãËΩâÊñπÂêë
                        const angle = Math.atan2(bullet.speedY, bullet.speedX);
                        ctx.translate(bullet.x + 3.4125, bullet.y + 13.65); // 6.825x27.3‰∏≠ÂøÉ
                        ctx.rotate(angle + Math.PI);
                        ctx.drawImage(tornadoImg, -5, -5, 30, 30); //ÈæçÊç≤È¢®Â∞∫ÂØ∏
                        ctx.restore();
                    } else {
                        ctx.fillStyle = bullet.color;
                        ctx.fillRect(bullet.x, bullet.y, 10, 20);
                    }
                } else {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // ÊÅ¢Âæ©ÁãÄÊÖã
            ctx.restore();
            
            // Áπ™Ë£ΩUI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // Ë™øË©¶‰ø°ÊÅØ
            cameraDebugElement.textContent = `moved: (${Math.floor(camera.x)})`;
            cameraDebugElement.style.display = showMoved == 1 ? 'block' : 'none';
        }
        
        // ===== Â∑•ÂÖ∑ÂáΩÊï∏ =====
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                    a.x + a.width > b.x &&
                    a.y < b.y + b.height &&
                    a.y + a.height > b.y;
        }
        
        /**
         * Êõ¥Êñ∞Áé©ÂÆ∂Ë°ÄÊ¢ùÈ°ØÁ§∫
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function updateHealthBar() {
            const percent = (playerHealth / playerMaxHealth) * 100;
            healthFill.style.width = `${percent}%`;
            if (percent <= 20) {
                healthFill.style.backgroundColor = '#f44'; // Á¥ÖËâ≤
            } else {
                healthFill.style.backgroundColor = '#4af'; // ËóçËâ≤
            }
        }
        
        /**
         * Êõ¥Êñ∞BossË°ÄÊ¢ùÈ°ØÁ§∫
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function updateBossHealthBar() {
            if (window.bossHpAnimating) return;
            const percent = (boss.health / boss.maxHealth) * 100;
            bossHealthFill.style.width = `${percent}%`;
        }
        
        /**
         * Êõ¥Êñ∞ÂàÜÊï∏È°ØÁ§∫
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function updateScore() {
            const scoreDiv = document.getElementById('score');
            if (scoreDiv) {
                scoreDiv.textContent = `score: ${score}`;
                scoreDiv.style.display = showScore == 1 ? 'block' : 'none';
            }
        }
        
        /**
         * ËôïÁêÜÈÅäÊà≤ÁµêÊùüÔºàGame OverÔºâÁï´Èù¢ËàáÈü≥Êïà
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function gameOver() {
            gameRunning = false;
            playerDeadX = player.x; // Ë®òÈåÑÊ≠ª‰∫°ÊôÇ‰ΩçÁΩÆ
            playerDeadY = player.y;
            playerDead = true; // Ë®≠ÁÇ∫Ê≠ª‰∫°ÁãÄÊÖã
            finalScoreElement.textContent = `score: ${score}`;
            gameOverScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // ÂÅúÊ≠¢BGM‰∏¶Êí≠ÊîæGame OverÈü≥Êïà
            if (bgm) {
                bgm.pause();
                bgm.currentTime = 0;
            }
            const gameOverAudio = document.getElementById('game-over-audio');
            if (gameOverAudio) {
                gameOverAudio.currentTime = 0;
                gameOverAudio.volume = VOLUME_GAMEOVER;
                if (isSfxOn) gameOverAudio.play();
            }
        }
        
        /**
         * ËôïÁêÜÂãùÂà©Áï´Èù¢ËàáÈü≥Êïà
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function winGame() {
            bossActive = false;
            // Â∞áÁé©ÂÆ∂ÁßªÂá∫Áï´Èù¢
            player.x = -9999;
            player.y = -9999;
            gameRunning = false;
            isWinInvincible = true;
            if (currentLang === 'zh') {
                winScoreElement.innerHTML = '<div style="font-size:80%">score: ÂàÜÊï∏È´òÂà∞ÁÑ°Ê≥ïË®àÁÆó</div>';
            } else if (currentLang === 'ja') {
                winScoreElement.innerHTML = '<div style="font-size:80%">score: Âêõ„ÅÆ„Çπ„Ç≥„Ç¢„ÅØÈ´ò„Åô„Åé„Å¶Ë®àÁÆó„Åß„Åç„Å™„ÅÑ„ÄÇ</div>';
            } else {
                winScoreElement.innerHTML = '<div style="font-size:80%">score: Your score is incalculably high.</div>';
            }
            winScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // Êí≠ÊîæÂãùÂà©Èü≥Ê®Ç
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                if (isBgmOn) outroAudio.play();
                // Á¢∫‰øùonended‰∫ã‰ª∂Ë®≠ÁΩÆ
                outroAudio.onended = function() {
                    setTimeout(() => {
                        outroAudio.currentTime = 0;
                        if (isBgmOn) outroAudio.play();
                    }, 1000);
                };
            }
            winScoreElement.innerHTML = LANGUAGES[currentLang].winScore;
            playAgainButton.textContent = LANGUAGES[currentLang].playagain;
        }
        
        // ===== Ë™ûË®ÄË≥áÊñô =====
        const LANGUAGES = {
            zh: {
                title: 'Â•ßÂè§ÂçÉËê¨Â•ßÂè§ÂçÉËê¨',
                shoot: 'Á©∫ÁôΩÈçµ Â∞ÑÊìä',
                move: ' ‚Üê ‚Üí ÁßªÂãï',
                jump: ' ‚Üë Ë∑≥Ë∫ç',
                start: 'START',
                gameover: '‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ„Ç®„Ç¢„Éº„Åæ„Çì„Åå...',
                retry: 'ÂÜçtrytry',
                win: '<div style="font-size:80%">ÂëΩÈÅãË©¶ÂúñÈòªÊ≠¢‰Ω†...</div><div style="font-size:80%">‰ΩÜ‰Ω†Êà∞Âãù‰∫ÜÔºÅ</div><div style="font-size:80%">Ë´ãÁõ∏‰ø°Ëá™Â∑±ÔºÅ</div><div style="font-size:80%">‰∏çÁÆ°Â§öÂ§ßÂõ∞Èõ£ÔºÅ‰Ω†ÈÉΩËÉΩÂÖãÊúçÔºÅ</div>',
                winScore: '<div style="font-size:95%">SCORE: ÁÑ°‰∫∫ËÉΩÂÆöÁæ©‰Ω†ÁöÑÂàÜÊï∏ÔºåÈÇ£‰∫õÁúã‰∏çË¶ãÁöÑÂä™ÂäõÔºåÊâçÊòØ‰Ω†ÊúÄÁúüÂØ¶ÁöÑÂØ¶Âäõ!</div>',
                playagain: '‰Ω†ÊÉ≥ÂÜçÁé©‰∏ÄÊ¨°‰πüÊòØÂèØ‰ª•...',
                // Settings Â§öË™ûË®Ä
                settings: {
                    title: 'Ë®≠ÂÆöÈÅ∏ÂñÆ',
                    selectLang: 'ÈÅ∏ÊìáË™ûË®Ä',
                    music: 'Èü≥Ê®Ç',
                    sfx: 'Èü≥Êïà',
                    startX: 'Ëµ∑Âßã X',
                    startY: 'Ëµ∑Âßã Y',
                    moveSpeed: 'Áé©ÂÆ∂ÁßªÂãïÈÄüÂ∫¶',
                    weaponPower: 'Ê≠¶Âô®ÊîªÊìäÂäõ',
                    maxFps: 'ÊúÄÂ§ß FPS',
                    gravity: 'ÈáçÂäõ',
                    jumpPower: 'Ë∑≥Ë∫çÂàùÈÄüÂ∫¶',
                    jumpExtra: 'Ë∑≥Ë∫çÈ°çÂ§ñÂä†ÈÄüÂ∫¶',
                    jumpExtraFrames: 'Ë∑≥Ë∫çÈ°çÂ§ñÂä†ÈÄüÂπÄÊï∏',
                    showScore: 'È°ØÁ§∫ÂàÜÊï∏',
                    showMoved: 'È°ØÁ§∫ÁßªÂãï',
                    showFps: 'È°ØÁ§∫ FPS',
                    showXy: 'È°ØÁ§∫ XY',
                    showNxy: 'È°ØÁ§∫Ê†ºÊï∏Â∫ßÊ®ô',
                    showEntityCounts: 'È°ØÁ§∫Áâ©‰ª∂Êï∏Èáè',
                    showMobileTouch: 'È°ØÁ§∫ÊâãÊ©üËß∏Êéß',
                    ok: 'Á¢∫ÂÆö'
                }
            },
            ja: {
                title: 'ÂÑÑÂçÉ‰∏áÂÑÑÂçÉ‰∏á',
                shoot: '„Çπ„Éö„Éº„Çπ„Ç≠„Éº „Ç∑„Éß„ÉÉ„Éà',
                move: ' ‚Üê ‚Üí „Ç≠„Éº ÁßªÂãï',
                jump: '‚Üë „Ç≠„Éº „Ç∏„É£„É≥„Éó',
                start: '„Çπ„Çø„Éº„Éà',
                gameover: '‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ‰ΩïÂõû„ÇÑ„Å£„Å¶„ÇÇ„ÄÄ„Ç®„Ç¢„Éº„Åæ„Çì„Åå...',
                retry: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶',
                win: '<div style="font-size:80%">ÈÅãÂëΩ„ÅØÂêõ„ÇíÊ≠¢„ÇÅ„Åü„Åå„ÄÅ</div><div style="font-size:80%">Âêõ„ÅåÂãù„Å£„ÅüÔºÅ</div><div style="font-size:80%">Ëá™ÂàÜ„Çí‰ø°„Åò„Å¶ÔºÅ</div><div style="font-size:80%">„Å©„Çì„Å™Âõ∞Èõ£„Åß„ÇÇÂøÖ„Åö‰πó„ÇäË∂ä„Åà„Çâ„Çå„ÇãÔºÅ</div>',
                winScore: '<div style="font-size:95%">SCORE: Âêõ„ÅÆ‰æ°ÂÄ§„ÇíÁÇπÊï∞„ÅßÊ±∫„ÇÅ„Çâ„Çå„Çã„Çè„Åë„Åå„Å™„ÅÑÔºÅ</div>',
                playagain: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å≥„Åæ„Åô„ÅãÔºü',
                settings: {
                    title: 'Ë®≠ÂÆö„É°„Éã„É•„Éº',
                    selectLang: 'Ë®ÄË™û„ÇíÈÅ∏Êäû',
                    music: 'Èü≥Ê•Ω',
                    sfx: 'ÂäπÊûúÈü≥',
                    startX: 'ÈñãÂßã X',
                    startY: 'ÈñãÂßã Y',
                    moveSpeed: '„Éó„É¨„Ç§„É§„ÉºÁßªÂãïÈÄüÂ∫¶',
                    weaponPower: 'Ê≠¶Âô®„Éë„ÉØ„Éº',
                    maxFps: 'ÊúÄÂ§ß FPS',
                    gravity: 'ÈáçÂäõ',
                    jumpPower: '„Ç∏„É£„É≥„ÉóÂàùÈÄüÂ∫¶',
                    jumpExtra: '„Ç∏„É£„É≥„ÉóËøΩÂä†Âä†ÈÄüÂ∫¶',
                    jumpExtraFrames: '„Ç∏„É£„É≥„ÉóËøΩÂä†„Éï„É¨„Éº„É†',
                    showScore: '„Çπ„Ç≥„Ç¢Ë°®Á§∫',
                    showMoved: 'ÁßªÂãïË°®Á§∫',
                    showFps: 'FPSË°®Á§∫',
                    showXy: 'XYË°®Á§∫',
                    showNxy: '„Ç∞„É™„ÉÉ„ÉâÂ∫ßÊ®ôË°®Á§∫',
                    showEntityCounts: '„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£Êï∞Ë°®Á§∫',
                    showMobileTouch: '„É¢„Éê„Ç§„É´„Çø„ÉÉ„ÉÅË°®Á§∫',
                    ok: 'OK'
                }
            },
            en: {
                title: 'Mega AI',
                shoot: 'Press SPACE to Shoot',
                move: 'Press ‚Üê ‚Üí to Move',
                jump: 'Press ‚Üë to Jump',
                start: 'START',
                gameover: 'The Untouchable Airman',
                retry: 'Retry',
                win: '<div style="font-size:80%">Fate tried to stop you...</div><div style="font-size:80%">but you prevailed !</div><div style="font-size:80%">Believe in yourself !</div><div style="font-size:80%">And overcome any difficulty !</div>',
                winScore: '<div style="font-size:95%">SCORE: Scores are for tests. You\'re not a test-you\'re a force.</div>',
                playagain: 'Play again?',
                settings: {
                    title: 'Settings',
                    selectLang: 'Select Language',
                    music: 'Music',
                    sfx: 'Effects Sound',
                    startX: 'Start X',
                    startY: 'Start Y',
                    moveSpeed: 'Player Move Speed',
                    weaponPower: 'Weapon Power',
                    maxFps: 'Max FPS',
                    gravity: 'Gravity',
                    jumpPower: 'Jump Power',
                    jumpExtra: 'Jump Extra',
                    jumpExtraFrames: 'Jump Extra Frames',
                    showScore: 'Show Score',
                    showMoved: 'Show Moved',
                    showFps: 'Show FPS',
                    showXy: 'Show XY',
                    showNxy: 'Show NXY',
                    showEntityCounts: 'Show Entity Counts',
                    showMobileTouch: 'Show Mobile Touch',
                    ok: 'OK'
                }
            }
        };
        let currentLang = localStorage.getItem('lang') || 'zh';
        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            const L = LANGUAGES[lang];
            document.querySelector('#start-screen h1').textContent = L.title;
            document.querySelectorAll('#start-screen p')[0].textContent = L.shoot;
            document.querySelectorAll('#start-screen p')[1].textContent = L.move;
            document.querySelectorAll('#start-screen p')[2].textContent = L.jump;
            startButton.textContent = L.start;
            document.querySelector('#game-over-screen h1').textContent = L.gameover;
            restartButton.textContent = L.retry;
            document.querySelector('#win-screen h1').innerHTML = L.win;
            winScoreElement.innerHTML = L.winScore;
            playAgainButton.textContent = L.playagain;
        }
        // ===== Ë™ûË®ÄÈÅ∏ÊìáUI =====
        const langSelect = document.getElementById('language-select');
        const langToggle = document.getElementById('lang-toggle');
        langToggle.onclick = () => {
            langSelect.style.display = (langSelect.style.display === 'flex') ? 'none' : 'flex';
        };
        document.getElementById('lang-zh').onclick = () => { setLang('zh'); langSelect.style.display = 'none'; updateSettingsPanelLang(); };
        document.getElementById('lang-ja').onclick = () => { setLang('ja'); langSelect.style.display = 'none'; updateSettingsPanelLang(); };
        document.getElementById('lang-en').onclick = () => { setLang('en'); langSelect.style.display = 'none'; updateSettingsPanelLang(); };
        // È†êË®≠Ë™ûË®Ä
        window.addEventListener('DOMContentLoaded', () => {
            setLang(currentLang);
            langSelect.style.display = 'none';
            langToggle.style.display = 'block';
            updateSettingsPanelLang();
        });
        
        // ===== Ëß∏ÊéßÊìç‰ΩúÊ®°Êì¨ÈçµÁõ§ =====
        /**
         * Êñ∞Â¢ûËß∏ÊéßÊåâÈàï‰∫ã‰ª∂ÔºåÊ®°Êì¨Â∞çÊáâÈçµÁõ§‰∫ã‰ª∂
         * @param {string} btnId - ÊåâÈàïÁöÑDOM id
         * @param {string} key - Â∞çÊáâÁöÑÈçµÁõ§keyÂÄº
         */
        function addTouchBtnEvent(btnId, key) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            // Ëß∏Êéß
            btn.addEventListener('touchstart', e => { if (e.cancelable) e.preventDefault(); simulateKey(key, true); });
            btn.addEventListener('touchend',   e => { if (e.cancelable) e.preventDefault(); simulateKey(key, false); });
            // ÊªëÈº†
            btn.addEventListener('mousedown',  e => { e.preventDefault(); simulateKey(key, true); });
            btn.addEventListener('mouseup',    e => { e.preventDefault(); simulateKey(key, false); });
            btn.addEventListener('mouseleave', e => { simulateKey(key, false); });
        }
        addTouchBtnEvent('btn-left',  'ArrowLeft');
        addTouchBtnEvent('btn-right', 'ArrowRight');
        addTouchBtnEvent('btn-jump',  'ArrowUp');
        addTouchBtnEvent('btn-shoot', ' ');
        
        /**
         * Ê†πÊìöË¶ñÁ™óÂ§ßÂ∞èËá™ÂãïÁ∏ÆÊîæÈÅäÊà≤Áï´Èù¢
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function resizeGame() {
            const baseWidth = 800;
            const baseHeight = 500;
            const scaleX = window.innerWidth / baseWidth;
            const scaleY = window.innerHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY);

            const wrapper = document.getElementById('game-wrapper');
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.transformOrigin = 'top left';
            wrapper.style.position = 'absolute';
            wrapper.style.left = `calc(50vw - ${(baseWidth * scale) / 2}px)`;
            wrapper.style.top = `calc(50vh - ${(baseHeight * scale) / 2}px)`;
            wrapper.style.width = baseWidth + 'px';
            wrapper.style.height = baseHeight + 'px';
        }
        window.addEventListener('resize', resizeGame);
        window.addEventListener('DOMContentLoaded', resizeGame);

        // ===== FPS Ë®àÁÆóËàáÈ°ØÁ§∫ =====
        let lastFPSTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        /**
         * FPSË®àÁÆóËàáÈ°ØÁ§∫ÔºåÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
         * ÁÑ°ÂèÉÊï∏ÔºåÁÑ°ÂõûÂÇ≥ÂÄº
         */
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastFPSTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFPSTime = now;
                const fpsDiv = document.getElementById('fps-display');
                if (fpsDiv) {
                    fpsDiv.textContent = `FPS: ${fps}`;
                    fpsDiv.style.display = showFPS == 1 ? 'block' : 'none';
                }
            }
            // ÊØèÂπÄÊõ¥Êñ∞Áé©ÂÆ∂Â∫ßÊ®ô
            const xy = document.getElementById('xy-display');
            if (xy) {
                xy.textContent = `X: ${Math.round(player.x)}, Y: ${Math.round(player.y)}`;
                xy.style.display = showXY == 1 ? 'block' : 'none';
            }
            // ÊØèÂπÄÊõ¥Êñ∞Áé©ÂÆ∂Ê†ºÊï∏Â∫ßÊ®ô
            const nxy = document.getElementById('nxy-display');
            if (nxy) {
                const nx = Math.floor(player.x / 50);
                const ny = Math.floor((500 - player.y) / 50);
                nxy.textContent = `NX: ${nx}, NY: ${ny}`;
                nxy.style.display = showNXY == 1 ? 'block' : 'none';
            }
            // ÊØèÂπÄÊõ¥Êñ∞Êï∏ÈáèË≥áË®ä
            const entityCounts = document.getElementById('entity-counts');
            if (entityCounts) {
                const bossCount = bosses.filter(b => b && bossActive).length;
                entityCounts.textContent = `P: ${players.length}, PS: ${bullets.length}, E: ${enemies.length}, ES: ${enemyBullets.length}, B: ${bossCount}`;
                entityCounts.style.display = showEntityCounts == 1 ? 'block' : 'none';
            }
        }

        // ===== Áé©ÂÆ∂È£õË°åÊ®°Âºè =====
        let isFlyingMode = 0; // È†êË®≠ÈóúÈñâ

        let isWinScreen = false;
        let bossDefeated = false;

        // ====== Ë®≠ÂÆöÈù¢Êùø ======
        // 1. Êñ∞Â¢ûË®≠ÂÆöÊåâÈàï
        const settingsBtn = document.createElement('div');
        settingsBtn.id = 'settings-btn';
        settingsBtn.style.position = 'absolute';
        settingsBtn.style.right = '10px';
        settingsBtn.style.bottom = '6px'; // Ë®≠ÂÆöÊåâÈàïÈ´òÂ∫¶
        settingsBtn.style.width = '45px';
        settingsBtn.style.height = '45px';
        settingsBtn.style.borderRadius = '50%';
        settingsBtn.style.background = '#333a';
        settingsBtn.style.color = '#fff';
        settingsBtn.style.boxShadow = '0 2px 8px #0006';
        settingsBtn.style.display = 'flex';
        settingsBtn.style.alignItems = 'center';
        settingsBtn.style.justifyContent = 'center';
        settingsBtn.style.cursor = 'pointer';
        settingsBtn.style.userSelect = 'none';
        settingsBtn.style.zIndex = 1000;
        settingsBtn.style.fontSize = '22px';
        settingsBtn.innerHTML = '<span style="font-size:22px;font-weight:bold;line-height:45px;display:flex;align-items:center;justify-content:center;width:100%;height:100%;color:#fff;">‚öôÔ∏è</span>';
        document.getElementById('game-wrapper').appendChild(settingsBtn);

        // 2. Êñ∞Â¢ûË®≠ÂÆöÈù¢Êùø
        const settingsPanel = document.createElement('div');
        settingsPanel.id = 'settings-panel';
        settingsPanel.style.position = 'fixed';
        settingsPanel.style.left = '50%';
        settingsPanel.style.top = '50%';
        settingsPanel.style.transform = 'translate(-50%, -50%)';
        settingsPanel.style.background = '#222';
        settingsPanel.style.color = '#fff';
        settingsPanel.style.padding = '32px 32px 24px 32px';
        settingsPanel.style.borderRadius = '16px';
        settingsPanel.style.boxShadow = '0 4px 32px #000a';
        settingsPanel.style.zIndex = 2000;
        settingsPanel.style.display = 'none';
        settingsPanel.style.minWidth = '320px';
        settingsPanel.innerHTML = `

            <div style="height:20px;"></div>

            <h2 style="margin-top:0;margin-bottom:18px;font-size:22px;text-align:center;">Settings</h2>

            <div style="margin-bottom:16px; display: flex; align-items: center; position:relative;">
                <div id="settings-lang-label" style="font-size:14px;min-width:80px; margin-right: 8px;display:flex;align-items:center;height:20px;">
                    ÈÅ∏ÊìáË™ûË®Ä
                </div>
                <div id="custom-lang-select-wrapper" style="position:relative;display:flex;align-items:center;height:20px;">
                    <button id="custom-lang-select-btn" style="font-size:14px;padding:2px 10px;border-radius:6px;background:#fff;color:#222;border:1px solid #888;min-width:60px;text-align:left;height:20px;display:flex;align-items:center;">‰∏≠Êñá ‚ñº</button>
                    <ul id="custom-lang-select-list" style="display:none;position:absolute;top:110%;left:0;width:100%;background:#222;border-radius:8px;box-shadow:0 2px 12px #0008;z-index:9999;padding:0;margin:0;list-style:none;font-size:14px;">
                        <li data-lang="zh" style="padding:6px 10px;cursor:pointer;color:#fff">‰∏≠Êñá</li>
                        <li data-lang="ja" style="padding:6px 10px;cursor:pointer;color:#fff">Êó•Êú¨Ë™û</li>
                        <li data-lang="en" style="padding:6px 10px;cursor:pointer;color:#fff">English</li>
                    </ul>
                </div>
            </div>


            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-bgm-on"> Muisc</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-sfx-on"> Effects Sound</label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Start X <input id="setting-start-x" type="number" min="0" max="5400" step="1" style="width:60px;"> </label>
                <label style="margin-left:16px;">Start Y <input id="setting-start-y" type="number" min="0" max="500" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Player Move Speed <input id="setting-move-speed" type="number" min="1" max="100" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Weapon Power <input id="setting-weapon-power" type="number" min="1" max="20" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Max FPS <input id="setting-max-fps" type="number" min="10" max="240" step="1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Gravity <input id="setting-gravity" type="number" min="0.1" max="10" step="0.1" style="width:60px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Jump Power <input id="setting-jump-power" type="number" min="-50" max="0" step="0.1" style="width:80px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Jump Extra <input id="setting-jump-extra" type="number" min="-5" max="0" step="0.01" style="width:80px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label>Jump Extra Frames <input id="setting-jump-extra-frames" type="number" min="1" max="60" step="1" style="width:80px;"> </label>
            </div>

            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-show-score"> Show Score</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-moved"> Show Moved</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-fps"> Show FPS</label>
            </div>

            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-show-xy"> Show XY</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-nxy"> Show NXY</label>
                <label style="margin-left:16px;"><input type="checkbox" id="setting-show-entity-counts"> Show Entity Counts</label>
            </div>

            <div style="margin-bottom:16px;">
                <label><input type="checkbox" id="setting-show-mobile-touch"> Show Mobile Touch</label>
            </div>
            
            <div style="text-align:center;margin-top:18px;">
                <button id="settings-close-btn" style="padding:6px 24px;font-size:16px;background:#4af;color:#fff;border:none;border-radius:6px;">OK</button>
            </div>

            <div style="height:20px;"></div>

        `;
        document.body.appendChild(settingsPanel);

        // 3. Ë®≠ÂÆöÊåâÈàï‰∫ã‰ª∂
        settingsBtn.onclick = function() {
            // ÂÖàÂèñÂæóÊâÄÊúâ input
            var bgmOnInput = document.getElementById('setting-bgm-on');
            var sfxOnInput = document.getElementById('setting-sfx-on');
            var moveSpeedInput = document.getElementById('setting-move-speed');
            var weaponPowerInput = document.getElementById('setting-weapon-power');
            var maxFpsInput = document.getElementById('setting-max-fps');
            var gravityInput = document.getElementById('setting-gravity');
            var jumpPowerInput = document.getElementById('setting-jump-power');
            var jumpExtraInput = document.getElementById('setting-jump-extra');
            var jumpExtraFramesInput = document.getElementById('setting-jump-extra-frames');
            var showScoreInput = document.getElementById('setting-show-score');
            var showMovedInput = document.getElementById('setting-show-moved');
            var showFpsInput = document.getElementById('setting-show-fps');
            var showXYInput = document.getElementById('setting-show-xy');
            var showNXYInput = document.getElementById('setting-show-nxy');
            var showEntityCountsInput = document.getElementById('setting-entity-counts');
            var showMobileTouchInput = document.getElementById('setting-show-mobile-touch');
            var startXInput = document.getElementById('setting-start-x');
            var startYInput = document.getElementById('setting-start-y');
            if (settingsPanel.style.display === 'block') {
                if (bgmOnInput) isBgmOn = bgmOnInput.checked ? 1 : 0;
                if (sfxOnInput) isSfxOn = sfxOnInput.checked ? 1 : 0;
                if (moveSpeedInput) playerMoveSpeed = parseInt(moveSpeedInput.value) || 1;
                if (weaponPowerInput) weaponPower = parseInt(weaponPowerInput.value) || 1;
                if (maxFpsInput) MAX_FPS = parseInt(maxFpsInput.value) || 10;
                if (gravityInput) GRAVITY = parseFloat(gravityInput.value) || 1;
                if (jumpPowerInput) JUMP_POWER = parseFloat(jumpPowerInput.value) || -11.5*1.3;
                if (jumpExtraInput) JUMP_EXTRA = parseFloat(jumpExtraInput.value) || -0.35*1.3;
                if (jumpExtraFramesInput) JUMP_EXTRA_FRAMES = parseInt(jumpExtraFramesInput.value) || 12;
                if (showScoreInput) showScore = showScoreInput.checked ? 1 : 0;
                if (showMovedInput) showMoved = showMovedInput.checked ? 1 : 0;
                if (showFpsInput) showFPS = showFpsInput.checked ? 1 : 0;
                if (showXYInput) showXY = showXYInput.checked ? 1 : 0;
                if (showNXYInput) showNXY = showNXYInput.checked ? 1 : 0;
                if (showEntityCountsInput) showEntityCounts = showEntityCountsInput.checked ? 1 : 0;
                if (showMobileTouchInput) showMobileTouch = showMobileTouchInput.checked ? 1 : 0;
                settingsPanel.style.display = 'none';
                isPaused = false;
                if (startXInput) startx = parseInt(startXInput.value) || 0;
                if (startYInput) starty = parseInt(startYInput.value) || 0;
            } else {
                if (bgmOnInput) bgmOnInput.checked = !!isBgmOn;
                if (sfxOnInput) sfxOnInput.checked = !!isSfxOn;
                if (moveSpeedInput) moveSpeedInput.value = playerMoveSpeed;
                if (weaponPowerInput) weaponPowerInput.value = weaponPower;
                if (maxFpsInput) maxFpsInput.value = MAX_FPS;
                if (gravityInput) gravityInput.value = GRAVITY;
                if (jumpPowerInput) jumpPowerInput.value = JUMP_POWER;
                if (jumpExtraInput) jumpExtraInput.value = JUMP_EXTRA;
                if (jumpExtraFramesInput) jumpExtraFramesInput.value = JUMP_EXTRA_FRAMES;
                if (showScoreInput) showScoreInput.checked = !!showScore;
                if (showMovedInput) showMovedInput.checked = !!showMoved;
                if (showFpsInput) showFpsInput.checked = !!showFPS;
                if (showXYInput) showXYInput.checked = !!showXY;
                if (showNXYInput) showNXYInput.checked = !!showNXY;
                if (showEntityCountsInput) showEntityCountsInput.checked = !!showEntityCounts;
                if (showMobileTouchInput) showMobileTouchInput.checked = !!showMobileTouch;
                settingsPanel.style.display = 'block';
                isPaused = true;
                if (startXInput) startXInput.value = startx;
                if (startYInput) startYInput.value = starty;
            }
        };
        var settingsCloseBtn = document.getElementById('settings-close-btn');
        if (settingsCloseBtn) {
            settingsCloseBtn.onclick = function() {
                var bgmOnInput = document.getElementById('setting-bgm-on');
                var sfxOnInput = document.getElementById('setting-sfx-on');
                var moveSpeedInput = document.getElementById('setting-move-speed');
                var weaponPowerInput = document.getElementById('setting-weapon-power');
                var maxFpsInput = document.getElementById('setting-max-fps');
                var gravityInput = document.getElementById('setting-gravity');
                var jumpPowerInput = document.getElementById('setting-jump-power');
                var jumpExtraInput = document.getElementById('setting-jump-extra');
                var jumpExtraFramesInput = document.getElementById('setting-jump-extra-frames');
                var showScoreInput = document.getElementById('setting-show-score');
                var showMovedInput = document.getElementById('setting-show-moved');
                var showFpsInput = document.getElementById('setting-show-fps');
                var showXYInput = document.getElementById('setting-show-xy');
                var showNXYInput = document.getElementById('setting-show-nxy');
                var showEntityCountsInput = document.getElementById('setting-entity-counts');
                var showMobileTouchInput = document.getElementById('setting-show-mobile-touch');
                var startXInput = document.getElementById('setting-start-x');
                var startYInput = document.getElementById('setting-start-y');
                if (bgmOnInput) isBgmOn = bgmOnInput.checked ? 1 : 0;
                if (sfxOnInput) isSfxOn = sfxOnInput.checked ? 1 : 0;
                if (moveSpeedInput) playerMoveSpeed = parseInt(moveSpeedInput.value) || 1;
                if (weaponPowerInput) weaponPower = parseInt(weaponPowerInput.value) || 1;
                if (maxFpsInput) MAX_FPS = parseInt(maxFpsInput.value) || 10;
                if (gravityInput) GRAVITY = parseFloat(gravityInput.value) || 1;
                if (jumpPowerInput) JUMP_POWER = parseFloat(jumpPowerInput.value) || -11.5*1.3;
                if (jumpExtraInput) JUMP_EXTRA = parseFloat(jumpExtraInput.value) || -0.35*1.3;
                if (jumpExtraFramesInput) JUMP_EXTRA_FRAMES = parseInt(jumpExtraFramesInput.value) || 12;
                if (showScoreInput) showScore = showScoreInput.checked ? 1 : 0;
                if (showMovedInput) showMoved = showMovedInput.checked ? 1 : 0;
                if (showFpsInput) showFPS = showFpsInput.checked ? 1 : 0;
                if (showXYInput) showXY = showXYInput.checked ? 1 : 0;
                if (showNXYInput) showNXY = showNXYInput.checked ? 1 : 0;
                if (showEntityCountsInput) showEntityCounts = showEntityCountsInput.checked ? 1 : 0;
                if (showMobileTouchInput) showMobileTouch = showMobileTouchInput.checked ? 1 : 0;
                settingsPanel.style.display = 'none';
                isPaused = false; // ÈóúÈñâË®≠ÂÆöÊôÇÊÅ¢Âæ©
                if (startXInput) startx = parseInt(startXInput.value) || 0;
                if (startYInput) starty = parseInt(startYInput.value) || 0;
            };
        }
        // Êñ∞Â¢ûÔºöcheckbox ËÆäÂãïÂç≥ÊôÇÂêåÊ≠•
        ['setting-show-score','setting-show-moved','setting-show-fps','setting-show-xy','setting-show-nxy','setting-show-entity-counts','setting-show-mobile-touch'].forEach(id => {
            var el = document.getElementById(id);
            if (el) {
                el.addEventListener('change', function() {
                    switch(id) {
                        case 'setting-show-score': showScore = this.checked ? 1 : 0; break;
                        case 'setting-show-moved': showMoved = this.checked ? 1 : 0; break;
                        case 'setting-show-fps': showFPS = this.checked ? 1 : 0; break;
                        case 'setting-show-xy': showXY = this.checked ? 1 : 0; break;
                        case 'setting-show-nxy': showNXY = this.checked ? 1 : 0; break;
                        case 'setting-show-entity-counts': showEntityCounts = this.checked ? 1 : 0; break;
                        case 'setting-show-mobile-touch': showMobileTouch = this.checked ? 1 : 0; updateMobileTouchDisplay(); break;
                    }
                });
            }
        });
        // Èü≥Ê®Ç/ÊïàÊûúÈü≥Âç≥ÊôÇÂêåÊ≠•
        var bgmOnInput2 = document.getElementById('setting-bgm-on');
        if (bgmOnInput2) {
            bgmOnInput2.addEventListener('change', function() {
                isBgmOn = this.checked ? 1 : 0;
                // Á´ãÂç≥ÊéßÂà∂ BGM/OUTRO
                const bgm = document.getElementById('bgm');
                const outroAudio = document.getElementById('outro-audio');
                if (isBgmOn) {
                    if (bgm && gameRunning) { bgm.currentTime = 0; bgm.volume = VOLUME_BGM; bgm.play(); }
                } else {
                    if (bgm) { bgm.pause(); }
                    if (outroAudio) { outroAudio.pause(); }
                }
            });
        }
        var sfxOnInput2 = document.getElementById('setting-sfx-on');
        if (sfxOnInput2) {
            sfxOnInput2.addEventListener('change', function() {
                isSfxOn = this.checked ? 1 : 0;
            });
        }
        // 4. ÂèÉÊï∏ input Á∂ÅÂÆöÔºàÁßªÈô§Âç≥ÊôÇÂ•óÁî®Ôºâ
        var moveSpeedInput2 = document.getElementById('setting-move-speed');
        if (moveSpeedInput2) moveSpeedInput2.addEventListener('input', function() {
            playerMoveSpeed = parseInt(this.value) || 1;
        });
        var weaponPowerInput2 = document.getElementById('setting-weapon-power');
        if (weaponPowerInput2) weaponPowerInput2.addEventListener('input', function() {
            weaponPower = parseInt(this.value) || 1;
        });
        var maxFpsInput2 = document.getElementById('setting-max-fps');
        if (maxFpsInput2) maxFpsInput2.addEventListener('input', function() {
            MAX_FPS = parseInt(this.value) || 10;
        });
        var gravityInput2 = document.getElementById('setting-gravity');
        if (gravityInput2) gravityInput2.addEventListener('input', function() {
            GRAVITY = parseFloat(this.value) || 1;
        });
        var jumpPowerInput2 = document.getElementById('setting-jump-power');
        if (jumpPowerInput2) jumpPowerInput2.addEventListener('input', function() {
            JUMP_POWER = parseFloat(this.value) || -11.5*1.3;
        });
        var jumpExtraInput2 = document.getElementById('setting-jump-extra');
        if (jumpExtraInput2) jumpExtraInput2.addEventListener('input', function() {
            JUMP_EXTRA = parseFloat(this.value) || -0.35*1.3;
        });
        var jumpExtraFramesInput2 = document.getElementById('setting-jump-extra-frames');
        if (jumpExtraFramesInput2) jumpExtraFramesInput2.addEventListener('input', function() {
            JUMP_EXTRA_FRAMES = parseInt(this.value) || 12;
        });

        let isPaused = false; // Êñ∞Â¢ûÂÖ®ÂüüÊö´ÂÅúÊóóÊ®ô

        // Ë£ú‰∏ä simulateKey ÂØ¶‰Ωú
        function simulateKey(key, pressed) {
            if (keys.hasOwnProperty(key)) {
                keys[key] = pressed;
            }
            // Ëã•ÈúÄË¶ÅËß∏ÁôºË∑≥Ë∫çÁöÑÁâπÊÆäË°åÁÇ∫
            if (key === 'ArrowUp') {
                if (pressed) {
                    if (!jumpKeyPressed) {
                        jumpKeyDownTime = Date.now();
                        jumpKeyPressed = true;
                    }
                } else {
                    if (jumpKeyPressed) {
                        const pressDuration = Date.now() - jumpKeyDownTime;
                        if (pressDuration < 200 && player.vy < 0) {
                            player.vy /= 4;
                        } else if (pressDuration < 300 && player.vy < 0) {
                            player.vy /= 3;
                        } else if (pressDuration < 400 && player.vy < 0) {
                            player.vy /= 2;
                        }
                        jumpKeyPressed = false;
                    }
                }
            }
            // Â∞ÑÊìäÈçµÁâπÊÆäËôïÁêÜ
            if (key === ' ') {
                if (pressed) {
                    if (!charging && gameRunning) {
                        charging = true;
                        chargeFrame = 0;
                        chargeReady = false;
                        player.isShooting = true;
                        const shootAudio = document.getElementById('shoot-audio');
                        if (shootAudio) {
                            shootAudio.currentTime = 0;
                            shootAudio.volume = VOLUME_SHOOT;
                            if (isSfxOn) shootAudio.play();
                        }
                        if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                        chargeAudioTimeout = setTimeout(() => {
                            if (charging) {
                                const chargeAudio = document.getElementById('charge-audio');
                                if (chargeAudio) {
                                    chargeAudio.currentTime = 0;
                                    chargeAudio.volume = VOLUME_CHARGE;
                                    if (isSfxOn) chargeAudio.play();
                                }
                            }
                        }, 500);
                    }
                } else {
                    if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                        chargeReady = true;
                    } else if (charging && chargeFrame < CHARGE_CANCEL_FRAME && !chargeReady) {
                        player.isShooting = true;
                    }
                    charging = false;
                    setTimeout(() => { player.isShooting = false; }, 0);
                    if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                    const chargeAudio = document.getElementById('charge-audio');
                    if (chargeAudio) {
                        chargeAudio.pause();
                        chargeAudio.currentTime = 0;
                        chargeAudio.volume = VOLUME_CHARGE;
                    }
                }
            }
        }

        // Êñ∞Â¢ûÔºöÊ†πÊìö showMobileTouch È°ØÁ§∫/Èö±ËóèËß∏ÊéßÊåâÈàï
        function updateMobileTouchDisplay() {
            const touchControls = document.getElementById('touch-controls');
            if (touchControls) {
                touchControls.style.display = showMobileTouch ? 'flex' : 'none';
            }
        }
        // È†êË®≠ËºâÂÖ•ÊôÇ‰πüË¶ÅÂëºÂè´‰∏ÄÊ¨°
        updateMobileTouchDisplay();

        document.getElementById('setting-start-x').addEventListener('input', function() {
            startx = parseInt(this.value) || 0;
        });
        document.getElementById('setting-start-y').addEventListener('input', function() {
            starty = parseInt(this.value) || 0;
        });

        let isWinInvincible = false; // ÂãùÂà©Áï´Èù¢ÁÑ°ÊïµÁãÄÊÖã


        // Êñ∞Â¢ûÔºöË®≠ÂÆöÈù¢ÊùøË™ûË®Ä‰∏ãÊãâÈÅ∏ÂñÆÂàáÊèõ
        // var settingsLangSelect = document.getElementById('settings-lang-select');
        // settingsLangSelect.value = currentLang;
        // settingsLangSelect.onchange = function() {
        //     setLang(this.value);
        //     updateSettingsPanelLang();
        // };

        // Êñ∞Â¢ûÔºöÊ†πÊìöË™ûË®ÄÂàáÊèõË®≠ÂÆöÈù¢ÊùøÊâÄÊúâÊñáÂ≠ó
        function updateSettingsPanelLang() {
            const L = LANGUAGES[currentLang].settings;
            document.querySelector('#settings-panel h2').textContent = L.title;
            document.getElementById('settings-lang-label').textContent = L.selectLang;
            // label for bgm
            var bgmLabel = document.getElementById('setting-bgm-on').parentNode;
            if (bgmLabel) {
                var bgmInput = document.getElementById('setting-bgm-on');
                bgmLabel.innerHTML = '';
                if (bgmInput) bgmLabel.appendChild(bgmInput);
                bgmLabel.append(' ' + L.music);
            }
            var sfxLabel = document.getElementById('setting-sfx-on').parentNode;
            if (sfxLabel) {
                var sfxInput = document.getElementById('setting-sfx-on');
                sfxLabel.innerHTML = '';
                if (sfxInput) sfxLabel.appendChild(sfxInput);
                sfxLabel.append(' ' + L.sfx);
            }
            // ÂÖ∂‰ªñ input + label
            function updateInputLabel(inputId, labelText) {
                var input = document.getElementById(inputId);
                if (input && input.parentNode) {
                    var label = input.parentNode;
                    // Âè™Êõ¥Êñ∞Á¨¨‰∏ÄÂÄãÊñáÂ≠óÁØÄÈªû
                    if (label.childNodes.length > 0 && label.childNodes[0].nodeType === 3) {
                        label.childNodes[0].textContent = labelText + ' ';
                    }
                }
            }
            updateInputLabel('setting-start-x', L.startX);
            updateInputLabel('setting-start-y', L.startY);
            updateInputLabel('setting-move-speed', L.moveSpeed);
            updateInputLabel('setting-weapon-power', L.weaponPower);
            updateInputLabel('setting-max-fps', L.maxFps);
            updateInputLabel('setting-gravity', L.gravity);
            updateInputLabel('setting-jump-power', L.jumpPower);
            updateInputLabel('setting-jump-extra', L.jumpExtra);
            updateInputLabel('setting-jump-extra-frames', L.jumpExtraFrames);
            // Checkbox
            function updateCheckboxLabel(inputId, labelText) {
                var input = document.getElementById(inputId);
                if (input && input.parentNode) {
                    var label = input.parentNode;
                    label.innerHTML = '';
                    label.appendChild(input);
                    label.append(' ' + labelText);
                }
            }
            updateCheckboxLabel('setting-show-score', L.showScore);
            updateCheckboxLabel('setting-show-moved', L.showMoved);
            updateCheckboxLabel('setting-show-fps', L.showFps);
            updateCheckboxLabel('setting-show-xy', L.showXy);
            updateCheckboxLabel('setting-show-nxy', L.showNxy);
            updateCheckboxLabel('setting-show-entity-counts', L.showEntityCounts);
            updateCheckboxLabel('setting-show-mobile-touch', L.showMobileTouch);
            document.getElementById('settings-close-btn').textContent = L.ok;
        }

        // Ëá™Ë®ÇË™ûË®ÄÈÅ∏ÂñÆÈÇèËºØ
        const customLangBtn = document.getElementById('custom-lang-select-btn');
        const customLangList = document.getElementById('custom-lang-select-list');
        const customLangItems = customLangList.querySelectorAll('li');
        function updateCustomLangBtn() {
            const map = { zh: '‰∏≠Êñá', ja: 'Êó•Êú¨Ë™û', en: 'English' };
            customLangBtn.textContent = map[currentLang] + ' ‚ñº';
        }
        customLangBtn.onclick = function(e) {
            e.stopPropagation();
            customLangList.style.display = (customLangList.style.display === 'block') ? 'none' : 'block';
        };
        customLangItems.forEach(item => {
            item.onclick = function(e) {
                setLang(this.dataset.lang);
                updateCustomLangBtn();
                customLangList.style.display = 'none';
                updateSettingsPanelLang();
            };
        });
        document.addEventListener('click', function(e) {
            customLangList.style.display = 'none';
        });
        window.addEventListener('DOMContentLoaded', updateCustomLangBtn);
    </script>
</body>
</html>