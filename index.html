<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…­æº€ å„„åƒä¸‡å„„åƒä¸‡ by watokiryuu</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #game-wrapper {
            width: 800px;
            height: 500px;
            position: relative;
            margin: 0 auto;
            background: transparent;
        }
        
        #game-container {
            width: 800px;
            height: 500px;
            position: relative;
            background: #000;
        }
        
        #game-canvas {
            background-color: #000;
        }
        
        #start-screen, #game-over-screen, #win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 10;
        }
        
        #game-over-screen, #win-screen {
            display: none;
        }
        
        h1 {
            color: #4af;
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #4af;
        }
        
        button {
            padding: 10px 20px;
            font-size: 18px;
            background-color: #4af;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        button:hover {
            background-color: #6cf;
        }
        
        #health-bar {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
        }
        
        #health-fill {
            height: 100%;
            width: 100%;
            background-color: #4af;
            transition: width 0.3s;
        }
        
        #boss-health-container {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 200px;
            height: 20px;
            background-color: #333;
            border: 2px solid #444;
            z-index: 5;
            display: none;
        }
        
        #boss-health-fill {
            height: 100%;
            width: 100%;
            background-color: #ccc;
            transition: width 0.3s;
        }
        
        #score {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            font-size: 18px;
            z-index: 5;
        }
        
        #camera-debug {
            position: absolute;
            top: 70px;
            left: 10px;
            color: white;
            font-size: 12px;
            z-index: 5;
        }
        
        #fps-display {
            position: absolute;
            top: 70px;
            right: 10px;
            color: white;
            font-size: 14px;
            z-index: 5;
        }
        
        #win-screen h1 div {
            text-align: center;
        }
        
        #touch-controls {
            position: absolute;
            left: 0;
            right: 0;
            top: 250px;
            width: 100%;
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            pointer-events: none;
            touch-action: none;
        }
        #touch-controls .touch-left, #touch-controls .touch-right {
            display: flex;
            gap: 8px; /* æ›´é è¿‘ */
            margin: 0 2vw; /* é è¿‘ä¸­é–“ */
        }
        #touch-controls button {
            pointer-events: auto;
            width: 100px;
            height: 100px;
            font-size: 24.2px;
            border-radius: 50%;
            border: none;
            background: #333a;
            color: #fff;
            box-shadow: 0 2px 8px #0006;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #touch-controls button:active {
            background: #4af;
            color: #fff;
        }
        @media (max-width: 900px) {
            #game-container { width: 800px; height: 500px; }
            #touch-controls { height: 60px; }
            #touch-controls .touch-left, #touch-controls .touch-right { margin: 0 6vw; }
            #touch-controls button { width: 44px; height: 44px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <audio id="bgm" src="bgm.mp3" loop style="display:none"></audio>
    <audio id="shoot-audio" src="shoot.mp3" style="display:none"></audio>
    <audio id="game-over-audio" src="game-over.mp3" style="display:none"></audio>
    <audio id="charge-audio" src="charge.mp3" loop style="display:none"></audio>
    <audio id="boom-audio" src="boom.mp3" style="display:none"></audio>
    <audio id="hurt-audio" src="hurt.mp3" style="display:none"></audio>
    <audio id="bossdie-audio" src="bossdie.mp3" style="display:none"></audio>
    <audio id="outro-audio" src="outro.mp3" style="display:none"></audio>
    <audio id="boss-audio" src="boss.mp3" style="display:none"></audio>
    <div id="game-wrapper">
        <div id="game-container">
            <button id="lang-toggle" style="position:absolute;top:10px;right:10px;z-index:30;background:#222;color:#fff;border-radius:6px;padding:4px 12px;font-size:14px;">ğŸŒ</button>
            <div id="language-select" style="position:absolute;top:40px;right:10px;z-index:29;background:#222;padding:12px 24px;border-radius:10px;box-shadow:0 2px 12px #0008;display:none;flex-direction:column;align-items:center;">
                <h2 style="color:#fff;margin-bottom:10px;font-size:16px;">é¸æ“‡èªè¨€ / è¨€èªã‚’é¸æŠ / Select Language</h2>
                <div style="display:flex;gap:12px;">
                    <button id="lang-zh">ä¸­æ–‡</button>
                    <button id="lang-ja">æ—¥æœ¬èª</button>
                    <button id="lang-en">English</button>
                </div>
            </div>
            <canvas id="game-canvas" width="800" height="500"></canvas>
            
            <div id="health-bar">
                <div id="health-fill"></div>
            </div>
            
            <div id="boss-health-container">
                <div id="boss-health-fill"></div>
            </div>
            
            <div id="score">score: 0</div>
            <div id="camera-debug"></div>
            <div id="fps-display" style="position:absolute;top:70px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="xy-display" style="position:absolute;top:90px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="nxy-display" style="position:absolute;top:110px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            <div id="entity-counts" style="position:absolute;top:130px;right:10px;color:#fff;font-size:14px;z-index:5;"></div>
            
            <div id="start-screen">
                <h1>å„„åƒä¸‡å„„åƒä¸‡</h1>
                <p>ç©ºç™½éµå°„æ“Š</p>
                <p>å·¦å³ç§»å‹•</p>
                <p>ä¸Šè·³èº</p>
                <button id="start-button">START</button>
            </div>
            
            <div id="game-over-screen">
                <h1 style="color:#800;">æ‰“ä¸å€’çš„ç©ºæ°£äºº</h1>
                <p id="final-score">score: 0</p>
                <button id="restart-button">å†trytry</button>
            </div>
            
            <div id="win-screen">
                <h1>å‹åˆ©!</h1>
                <p id="win-score">score: 0</p>
                <button id="play-again-button">ä½ æƒ³å†ç©ä¸€æ¬¡ä¹Ÿæ˜¯å¯ä»¥...</button>
                <div id="by-watoki" style="position:absolute;right:18px;bottom:10px;color:#fff;font-size:18px;z-index:20;text-shadow:0 0 4px #000a;">by Watoki</div>
            </div>
        </div>
        <div id="flash-effect" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:100;display:none;"></div>
        <img id="tornado-img" src="tornadoes.png" style="display:none" />
        <!-- è§¸æ§æ“ä½œå€ -->
        <div id="touch-controls">
            <div class="touch-left">
                <button id="btn-left">â†</button>
                <button id="btn-right">â†’</button>
            </div>
            <div class="touch-right">
                <button id="btn-jump">â†‘</button>
                <button id="btn-shoot">S</button>
            </div>
        </div>
    </div>
    <script>
        // ===== éŠæˆ²è¨­å®šï¼ˆé›†ä¸­æ•´ç†ï¼‰ =====
        // é¡è‰²è¨­å®š
        const COLOR_PLATFORM_NORMAL = '#444';
        const COLOR_PLATFORM_BOSS   = '#800';
        const COLOR_PLATFORM_HIGH   = '#666';
        const COLOR_PLAYER          = '#4af';
        const COLOR_BOSS            = '#2196f3';
        const COLOR_BOSS_FAN        = '#ffe082';
        const COLOR_BOSS_FAN_CENTER = '#fff';
        const COLOR_BULLET_NORMAL   = '#b3f0ff';
        const COLOR_BULLET_CHARGE   = '#ff0';
        const COLOR_BULLET_ENEMY    = '#f8f';
        const COLOR_BULLET_BOSS     = '#f4a';
        // éŸ³é‡è¨­å®š
        const VOLUME_BGM      = 0.55;
        const VOLUME_SHOOT    = 0.55;
        const VOLUME_CHARGE   = 0.55;
        const VOLUME_BOOM     = 0.45;
        const VOLUME_HURT     = 0.70;
        const VOLUME_GAMEOVER = 0.75;
        const VOLUME_BOSSDIE  = 0.40;
        const VOLUME_BOSS     = 0.85;
        const VOLUME_OUTRO    = 0.55;
        // éŠæˆ²å¸¸æ•¸
        const GRAVITY         = 1; // é‡åŠ›åŠ é€Ÿåº¦ï¼Œæ•¸å€¼è¶Šå¤§ä¸‹è½è¶Šå¿«
        const JUMP_POWER      = -11.5 * 1.3; // è·³èºåˆé€Ÿåº¦ï¼Œæ•¸å€¼è¶Šè² è·³è¶Šé«˜ã€è¶Šå¿«
        const JUMP_EXTRA      = -0.35 * 1.3; // é•·æŒ‰è·³èºæ™‚æ¯å¹€é¡å¤–åŠ é€Ÿåº¦ï¼Œæ•¸å€¼è¶Šè² è·³è¶Šé«˜
        const JUMP_EXTRA_FRAMES = 12; // 0.2ç§’@60fpsï¼ˆä¸è®Šï¼‰
        const WORLD_WIDTH     = 2700 * 2;  // ä¸–ç•Œå¯¬åº¦2å€
        const WORLD_HEIGHT    = 500;
        const BOSS_AREA_X     = 4600; // Bosså€åŸŸèµ·é»4600
        const CHARGE_MIN_FRAME = 42; // 0.7ç§’
        const CHARGE_CANCEL_FRAME = 12; // 0.2ç§’
        // ä»¥æ ¼æ•¸è¨­è¨ˆçš„å¹³å°è³‡æ–™
        const platformGrid = [
            // ç¬¬ä¸€å€ï¼ˆ0~2700ï¼‰
            { x: 0, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 1, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 2, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 3, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 4, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 5, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 6, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 7, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 8, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 9, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 10, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 11, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 12, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 13, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 14, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 15, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 16, y: 1, color: COLOR_PLATFORM_NORMAL },
            // ä¸­é–“å€åŸŸ
            { x: 17, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 18, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 19, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 20, y: 3, color: COLOR_PLATFORM_HIGH },
            // { x: 21, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 22, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 23, y: 3, color: COLOR_PLATFORM_NORMAL },
            { x: 24, y: 3, color: COLOR_PLATFORM_NORMAL },
            // { x: 25, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 26, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 27, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 28, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 29, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 30, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 31, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 32, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 33, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 34, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 35, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 36, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 37, y: 6, color: COLOR_PLATFORM_NORMAL },
            { x: 38, y: 6, color: COLOR_PLATFORM_NORMAL },
            { x: 39, y: 6, color: COLOR_PLATFORM_NORMAL },
            // { x: 40, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 41, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 42, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 43, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 44, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 45, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 46, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 47, y: 1, color: COLOR_PLATFORM_NORMAL },
            // { x: 48, y: 1, color: COLOR_PLATFORM_NORMAL },
            { x: 49, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 50, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 51, y: 3, color: COLOR_PLATFORM_HIGH },
            { x: 52, y: 3, color: COLOR_PLATFORM_HIGH },
            // { x: 53, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 54, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 55, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 56, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 57, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 58, y: 4, color: COLOR_PLATFORM_NORMAL },
            { x: 59, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 60, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 61, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 62, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 63, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 64, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 65, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 66, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 67, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 68, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 69, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 70, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 71, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 72, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 73, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 74, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 75, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 76, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 77, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 78, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 79, y: 7, color: COLOR_PLATFORM_NORMAL },
            { x: 80, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 81, y: 7, color: COLOR_PLATFORM_NORMAL },
            // { x: 82, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 83, y: 7, color: COLOR_PLATFORM_HIGH },
            { x: 84, y: 2, color: COLOR_PLATFORM_HIGH },
            { x: 85, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 86, y: 2, color: COLOR_PLATFORM_NORMAL },
            { x: 87, y: 9, color: COLOR_PLATFORM_NORMAL },
            { x: 88, y: 9, color: COLOR_PLATFORM_NORMAL },
            { x: 89, y: 2, color: COLOR_PLATFORM_NORMAL },
            // { x: 90, y: 2, color: COLOR_PLATFORM_NORMAL },
            // Boss å€åŸŸåœ°æ¿ï¼ˆx=4600 ä¹‹å¾Œï¼‰
            { x: 91, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 92, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 93, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 94, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 95, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 96, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 97, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 98, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 99, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 100, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 101, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 102, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 103, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 104, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 105, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 106, y: 1, color: COLOR_PLATFORM_BOSS },
            { x: 107, y: 1, color: COLOR_PLATFORM_BOSS },
            // { x: 108, y: 1, color: COLOR_PLATFORM_BOSS },
        ];
        // è‡ªå‹•è½‰æ›
        const basePlatforms = platformGrid.map(p => ({
          x: p.x * 50,
          y: 500 - p.y * 50,
          width: 50,
          height: 50,
          color: p.color
        }));
        
        // ===== DOM å…ƒç´ é¸å– =====
        const canvas              = document.getElementById('game-canvas');
        const ctx                 = canvas.getContext('2d');
        
        const startScreen         = document.getElementById('start-screen');
        const gameOverScreen      = document.getElementById('game-over-screen');
        const winScreen           = document.getElementById('win-screen');
        
        const startButton         = document.getElementById('start-button');
        const restartButton       = document.getElementById('restart-button');
        const playAgainButton     = document.getElementById('play-again-button');
        
        const healthFill          = document.getElementById('health-fill');
        const bossHealthContainer = document.getElementById('boss-health-container');
        const bossHealthFill      = document.getElementById('boss-health-fill');
        
        const scoreElement        = document.getElementById('score');
        const finalScoreElement   = document.getElementById('final-score');
        const winScoreElement     = document.getElementById('win-score');
        const cameraDebugElement  = document.getElementById('camera-debug');
        
        // ===== éŠæˆ²ç‹€æ…‹ =====
        let gameRunning  = false;
        let score        = 0;
        let playerMaxHealth = 10000; // æ–°å¢æœ€å¤§è¡€é‡
        let playerHealth = playerMaxHealth;
        let bossHealth   = 300;  // å¢å¼·Bossè¡€é‡
        let bossActive   = false;
        let bossTimer    = 0;
        let reachedBossArea = false; // ç©å®¶æ˜¯å¦å·²ç¶“æŠµé”ébosså€åŸŸ
        let charging = false; // æ˜¯å¦æ­£åœ¨é›†æ°£
        let chargeFrame = 0; // é›†æ°£æŒçºŒå¹€æ•¸
        let chargeReady = false; // æ˜¯å¦é›†æ°£å®Œæˆ
        let bossHitFlash = 0; // Bossè¢«æ“Šä¸­é–ƒçˆè¨ˆæ•¸
        let upPressed = false; // è¿½è¹¤ä¸Šéµæ˜¯å¦å·²ç¶“æŒ‰ä¸‹
        let chargeAudioTimeout = null;
        let bossCanAttack = false;
        let bossCanMove = false;
        let bossHpAnimating = false;
        let canShoot = true;
        let midEventTriggered = false;
        let playerDead = false; // æ–°å¢ï¼šç©å®¶æ­»äº¡ç‹€æ…‹
        let playerDeadX = 0;   // æ–°å¢ï¼šæ­»äº¡æ™‚çš„X
        let playerDeadY = 0;   // æ–°å¢ï¼šæ­»äº¡æ™‚çš„Y
        
        // é¡¯ç¤º/éš±è—ç‹€æ…‹å¸ƒæ—
        let showFPS = 1;
        let showXY = 1;
        let showNXY = 1;
        let showEntityCounts = 1;
        
        // æœ€å¤§FPSè¨­å®š
        const MAX_FPS = 70;
        
        // ===== é¡é ­ç³»çµ± =====
        const camera = {
            x: 0,
            y: 0,
            width: canvas.width,
            height: canvas.height,
            // å¹³æ»‘è·Ÿéš¨ç©å®¶
            follow: function(target) {
                const centerX = target.x + target.width/2;
                const centerY = target.y + target.height/2;
                
                // æ°´å¹³è·Ÿéš¨
                this.x = centerX - this.width/2;
                
                // ç•¶ç©å®¶æŠµé”bosså€åŸŸå¾Œï¼Œé¡é ­å·¦é‚Šç•Œé–å®šåœ¨BOSS_AREA_X
                if (target.x >= BOSS_AREA_X) {
                    this.x = Math.max(BOSS_AREA_X, this.x);
                }
                
                // å‚ç›´è·Ÿéš¨ (ä½†é™åˆ¶ä¸è®“ç©å®¶çœ‹åˆ°åœ°åœ–å¤–)
                const maxY = WORLD_HEIGHT - this.height;
                this.y = Math.min(maxY, Math.max(0, centerY - this.height/2));
                
                // é™åˆ¶ä¸è¶…å‡ºä¸–ç•Œé‚Šç•Œ
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
            }
        };
        
        // ===== ç©å®¶ç‰©ä»¶ =====
        const player = {
            x: 100,
            y: 0,             // æ–¼ startGame() æ”¾ç½®æ–¼å¹³å°ä¸Š
            width: 40,
            height: 40,
            speed: 5 * 1.1, // 1.1å€
            vy: 0,            // å‚ç›´é€Ÿåº¦
            onGround: false,  // æ˜¯å¦è‘—åœ°
            color: '#4af',
            isShooting: false,
            shootCooldown: 0,
            shootDelay: Math.round(15 / 1.1), // ç™¼å°„é–“éš”ç¸®çŸ­
            direction: 1,    // 1=å‘å³ / -1=å‘å·¦
            invincible: 0,    // ç„¡æ•µæ™‚é–“
            
            // æ›´æ–°ç©å®¶ä½ç½®
            update: function() {
                if (playerDead) {
                    this.x = playerDeadX;
                    this.y = playerDeadY;
                    return; // æ­»äº¡æ™‚ä¸èƒ½å‹•ä½œä¸”ç¶­æŒåœ¨æ­»äº¡ä½ç½®
                }
                // æ˜¯å¦æŠµé”ébosså€åŸŸ
                if (this.x >= BOSS_AREA_X) {
                    reachedBossArea = true;
                }
                // æ°´å¹³ç§»å‹•
                if (keys.ArrowLeft)  {
                    if (reachedBossArea) {
                        this.x -= this.speed;
                        if (this.x < BOSS_AREA_X) this.x = BOSS_AREA_X;
                    } else {
                        this.x -= this.speed;
                        if (this.x < 0) this.x = 0;
                    }
                    this.direction = -1;
                }
                if (keys.ArrowRight) { this.x += this.speed; this.direction =  1; }
                
                // è·³èº
                if (keys.ArrowUp && this.onGround && !upPressed) {
                    this.vy = JUMP_POWER;
                    this.onGround = false;
                    upPressed = true;
                    isJumping = true;
                    jumpHoldFrames = 0;
                }
                if (!keys.ArrowUp) upPressed = false;
                
                // é‡åŠ›èˆ‡æ–° y ä½ç½®
                this.vy += GRAVITY;
                let newY = this.y + this.vy;
                
                // å¹³å°ç¢°æ’æª¢æ¸¬
                this.onGround = false;
                for (let p of platforms) {
                    const overlapX = this.x + this.width > p.x && this.x < p.x + p.width;
                    if (overlapX && this.y + this.height <= p.y && newY + this.height >= p.y) {
                        newY = p.y - this.height;
                        this.vy = 0;
                        this.onGround = true;
                    }
                }
                
                // æ›´æ–°ä½ç½®
                this.y = newY;
                
                // é‚Šç•Œé™åˆ¶
                this.x = Math.max(0, Math.min(WORLD_WIDTH - this.width, this.x));
                
                // æ‰è½æ­»äº¡
                if (this.y >= WORLD_HEIGHT) {
                    gameOver();
                    return;
                }
                
                // ç„¡æ•µæ™‚é–“æ›´æ–°
                if (this.invincible > 0) {
                    this.invincible--;
                }
                // è·³èºå¢åŠ›ï¼ˆå¯è®Šé«˜åº¦ï¼‰
                if (isJumping && !this.onGround && this.vy < 0 && jumpHoldFrames < JUMP_EXTRA_FRAMES) {
                    this.vy += JUMP_EXTRA;
                    jumpHoldFrames++;
                } else if (jumpHoldFrames >= JUMP_EXTRA_FRAMES) {
                    isJumping = false;
                }
                // é™åˆ¶æœ€é«˜ä¸Šå‡250åƒç´ 
                if (isJumping && jumpStartY - this.y >= 250) {
                    isJumping = false;
                    if (this.vy < 0) this.vy = 0; // ç«‹å³åœæ­¢ä¸Šå‡
                }
            },
            
            // ç©å®¶å°„æ“Š
            shoot: function() {
                if (playerDead) return; // æ­»äº¡æ™‚ä¸èƒ½å°„æ“Š
                if (!canShoot) return;
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                    return;
                }
                // å¦‚æœé›†æ°£å½ˆå³å°‡ç™¼å°„ï¼Œä¸ç™¼å°„æ™®é€šå­å½ˆ
                if (chargeReady) return;
                // é›†æ°£ç‹€æ…‹ä¸‹ï¼Œåªæœ‰é›†æ°£è¶…é0.7ç§’æ‰ä¸ç™¼å°„æ™®é€šå­å½ˆ
                if (charging && chargeFrame >= CHARGE_CANCEL_FRAME) return;
                if (this.isShooting && this.shootCooldown === 0) {
                    bullets.push({
                        x: this.x + (this.direction === 1 ? this.width : -10),
                        y: this.y + this.height / 2 - 3,
                        width: 10,
                        height: 6,
                        speed: 10 * 1.1 * this.direction, // 1.1å€
                        color: '#b3f0ff',
                        isCharge: false
                    });
                    this.shootCooldown = this.shootDelay;
                }
            },
            
            // å—å‚·è™•ç†
            takeDamage: function(amount) {
                if (this.invincible > 0) return;
                // æ’­æ”¾å—å‚·éŸ³æ•ˆ
                const hurtAudio = document.getElementById('hurt-audio');
                if (hurtAudio) {
                    hurtAudio.currentTime = 0;
                    hurtAudio.volume = VOLUME_HURT;
                    hurtAudio.play();
                }
                playerHealth -= amount;
                updateHealthBar();
                this.invincible = 30; // 30å¹€ç„¡æ•µæ™‚é–“
                if (playerHealth <= 0) {
                    gameOver();
                }
            }
        };
        const players = [player];
        
        // ===== å­å½ˆç³»çµ± =====
        const bullets = [];
        const enemyBullets = [];
        
        // ===== æ•µäººé¡å‹ =====
        const ENEMY_TYPES = {
            // é£›è¡Œç³»åˆ—ï¼ˆåœ“å½¢ï¼‰
            FLY_RED: {
                color: '#f44',
                speed: 1.5 * 1.1,
                health: 1,
                score: 60,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                    // å°å¹…åº¦ä¸Šä¸‹
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 600 + enemy._id) * 18;
                },
                isFlying: true,
                eye: { color: '#222', type: 'circle' }
            },
            FLY_ORANGE: {
                color: '#f84',
                speed: 2.25 * 1.1, // æ¯”ç´…è‰²å¿«0.5å€
                health: 1,
                score: 80,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                    // å¤§å¹…åº¦ä¸Šä¸‹
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 300 + enemy._id) * 48;
                },
                isFlying: true,
                eye: { color: '#222', type: 'circle' }
            },
            // åœ°ä¸Šç³»åˆ—ï¼ˆåŠåœ“å½¢ï¼‰
            GROUND_RED: {
                color: '#f44',
                speed: 0.75 * 1.1, // åŸæœ¬1.5ï¼Œç¾åœ¨æ…¢ä¸€å€
                health: 1,
                score: 50,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                },
                isFlying: false,
                eye: { color: '#222', type: 'semi' }
            },
            GROUND_ORANGE: {
                color: '#f84',
                speed: 0.75 * 1.1, // åŸæœ¬1.5ï¼Œç¾åœ¨æ…¢ä¸€å€
                health: 1,
                score: 70,
                behavior: function(enemy) {
                    enemy.x -= enemy.speed;
                    if (enemy.onGround && Math.random() < 0.02) {
                        enemy.vy = -12;
                        enemy.onGround = false;
                    }
                },
                isFlying: false,
                eye: { color: '#222', type: 'semi' }
            },
            GROUND_PINK: {
                color: '#f8c',
                speed: 0,
                health: 1,
                score: 100,
                shootDelay: Math.round(180 / 1.1), // å°„æ“Šé–“éš”ç¸®çŸ­
                behavior: function(enemy) {
                    // å›ºå®šé»å°„æ“Š
                    if (enemy.shootCooldown > 0) {
                        enemy.shootCooldown--;
                    } else {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (enemy.y + enemy.height/2),
                            player.x + player.width/2 - (enemy.x + enemy.width/2)
                        );
                        // å°„æ“Šæ¬¡æ•¸æ¸›åŠï¼ŒåŸæœ¬1ç™¼ï¼Œç¾åœ¨æ¯2æ¬¡æ‰å°„1ç™¼
                        if (!enemy._shootToggle) enemy._shootToggle = false;
                        enemy._shootToggle = !enemy._shootToggle;
                        if (enemy._shootToggle) {
                            enemyBullets.push({
                                x: enemy.x + enemy.width/2 - 3,
                                y: enemy.y + enemy.height/2 - 3,
                                width: 6,
                                height: 6,
                                speedX: Math.cos(angle) * 1.3,
                                speedY: Math.sin(angle) * 1.3,
                                color: '#f8c'
                            });
                        }
                        enemy.shootCooldown = enemy.shootDelay;
                    }
                },
                isFlying: false,
                eye: { color: '#fff', type: 'semi' }
            }
        };
        
        // ===== æ•µäººé™£åˆ— =====
        const enemies = [];
        // ===== æ•µäººé–ƒçˆç‹€æ…‹ =====
        const enemyHitFlash = new WeakMap(); // Map<enemy, frame>
        
        // ===== Boss ç‰©ä»¶ =====
        const boss = {
            x: 2500 + 2700 * 1,
            y: 350, // å›ºå®šåˆå§‹åº§æ¨™
            width: 100,
            height: 100,
            speed: 2 * 1.1, // 1.1å€
            vy: 0, // ä¸å†éœ€è¦é‡åŠ›
            color: '#2196f3', // ä¸»é«”è—è‰²ï¼ˆAirmanä¸»è‰²ï¼‰
            shootCooldown: 0,
            shootDelay: Math.round(200 / 1.1), // é–“éš”ç¸®çŸ­
            pattern: 0,
            patternTimer: 0,
            health: 300,
            maxHealth: 300,
            onGround: false, // ä¸å†éœ€è¦onGround
            pauseTimer: 0, // æ–°å¢ï¼šæš«åœè¨ˆæ™‚å™¨
            
            // Boss è¡Œç‚ºæ¨¡å¼
            update: function() {
                // æ–°å¢ï¼šæš«åœç‹€æ…‹
                if (this.pauseTimer > 0) {
                    this.pauseTimer--;
                    return;
                }
                // æ¨¡å¼è¨ˆæ™‚å™¨
                this.patternTimer++;
                if (this.patternTimer > 180) {
                    this.pattern = (this.pattern + 1) % 4;
                    this.patternTimer = 0;
                }
                if (!bossCanMove) return; // 0.7ç§’å…§ä¸èƒ½ç§»å‹•
                // ä¸å—é‡åŠ›å½±éŸ¿ï¼Œç›´æ¥æ ¹æ“šè¡Œç‚ºæ¨¡å¼èª¿æ•´yåº§æ¨™
                switch (this.pattern) {
                    case 0: // ä¸Šä¸‹ç§»å‹•
                        this.y += this.speed;
                        if (this.y < 50 || this.y > WORLD_HEIGHT - this.height - 50) {
                            this.speed *= -1;
                        }
                        break;
                    case 1: // è¿½è¹¤ç©å®¶
                        if (this.y < player.y) {
                            this.y += this.speed;
                        } else if (this.y > player.y) {
                            this.y -= this.speed;
                        }
                        break;
                    case 2: // è·³èºæ”»æ“Šï¼ˆæ”¹ç‚ºå¿«é€Ÿä¸Šä¸‹ç§»å‹•ï¼‰
                        if (this.patternTimer % 60 < 30) {
                            this.y -= 8; // å‘ä¸Šé£„
                        } else {
                            this.y += 8; // å‘ä¸‹é£„
                        }
                        // é™åˆ¶ç¯„åœ
                        this.y = Math.max(50, Math.min(WORLD_HEIGHT - this.height - 50, this.y));
                        break;
                    case 3: // è¡åˆºæ”»æ“Š
                        if (this.patternTimer < 60) {
                            this.x -= 5;
                        } else if (this.patternTimer < 120) {
                            this.x += 5;
                        }
                        break;
                }
                // Boss å°„æ“Š
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                } else if (bossCanAttack) {
                    // ä¸‰æ–¹å‘å°„æ“Š
                    for (let i = -1; i <= 1; i++) {
                        const angle = Math.atan2(
                            player.y + player.height/2 - (this.y + this.height/2),
                            player.x + player.width/2 - (this.x + this.width/2)
                        ) + (i * 0.3);
                        enemyBullets.push({
                            x: this.x + this.width/2 - 3.4125,
                            y: this.y + this.height/2 - 13.65,
                            width: 10,
                            height: 20,
                            speedX: Math.cos(angle) * 3,
                            speedY: Math.sin(angle) * 3,
                            color: '#f4a'
                        });
                    }
                    this.shootCooldown = this.shootDelay; // â† æ¯æ¬¡ç™¼å°„å¾Œé‡è¨­å†·å»
                }
                // === åŠ å…¥é‚Šç•Œé™åˆ¶ ===
                this.x = Math.max(BOSS_AREA_X, Math.min(WORLD_WIDTH - this.width, this.x));
                this.y = Math.max(0, Math.min(WORLD_HEIGHT - this.height, this.y));
            }
        };
        const bosses = [boss];
        
        // ===== å¹³å°é™£åˆ— =====
        const platforms = basePlatforms.slice();
        
        // ===== æ§åˆ¶ç³»çµ± =====
        const keys = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            ' ': false,
            'Enter': false
        };
        
        // ===== äº‹ä»¶ç›£è½ =====
        startButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', startGame);
        playAgainButton.addEventListener('click', startGame);
        
        // è·³èºéµæŒ‰ä¸‹æ™‚é–“è¨˜éŒ„
        let jumpKeyDownTime = 0;
        let jumpKeyPressed = false;
        let isJumping = false;
        let jumpHoldFrames = 0;
        const jumpMaxHoldTime = 300; // æœ€é•·0.3ç§’
        let jumpStartY = 0; // èµ·è·³æ™‚yåº§æ¨™
        
        document.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = true;
                if (e.key === 'ArrowUp' && !jumpKeyPressed) {
                    jumpKeyDownTime = Date.now();
                    jumpKeyPressed = true;
                }
                if (e.key === 'Enter' && !gameRunning) {
                    startGame();
                }
                if (e.key === ' ' && gameRunning) {
                    // æŒ‰ä¸‹ç©ºç™½éµï¼Œç«‹å³å•Ÿå‹•æ™®é€šå°„æ“Š
                    if (!charging) {
                        charging = true;
                        chargeFrame = 0;
                        chargeReady = false;
                        player.isShooting = true;
                        // æ’­æ”¾å°„æ“ŠéŸ³æ•ˆ
                        const shootAudio = document.getElementById('shoot-audio');
                        if (shootAudio) {
                            shootAudio.currentTime = 0;
                            shootAudio.volume = VOLUME_SHOOT;
                            shootAudio.play();
                        }
                        // å»¶é²0.5ç§’å¾Œæ‰æ’­æ”¾é›†æ°£éŸ³æ•ˆ
                        if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                        chargeAudioTimeout = setTimeout(() => {
                            if (charging) {
                                const chargeAudio = document.getElementById('charge-audio');
                                if (chargeAudio) {
                                    chargeAudio.currentTime = 0;
                                    chargeAudio.volume = VOLUME_CHARGE;
                                    chargeAudio.play();
                                }
                            }
                        }, 500);
                    }
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key)) {
                keys[e.key] = false;
                if (e.key === 'ArrowUp' && jumpKeyPressed) {
                    const pressDuration = Date.now() - jumpKeyDownTime;
                    if (pressDuration < 200 && player.vy < 0) {
                        // 0.2ç§’ä»¥ä¸‹ï¼Œ1/4é«˜åº¦
                        player.vy /= 4;
                    } else if (pressDuration < 300 && player.vy < 0) {
                        // 0.2~0.3ç§’ï¼Œ1/3é«˜åº¦
                        player.vy /= 3;
                    } else if (pressDuration < 400 && player.vy < 0) {
                        // 0.3~0.4ç§’ï¼Œä¸€åŠé«˜åº¦
                        player.vy /= 2;
                    }
                    // è¶…é0.4ç§’ï¼Œç¶­æŒåŸæœ¬æœ€é«˜é«˜åº¦
                    jumpKeyPressed = false;
                }
                if (e.key === ' ') {
                    // æ”¾é–‹ç©ºç™½éµæ™‚ï¼Œæ ¹æ“šé›†æ°£æ™‚é–“æ±ºå®šç™¼å°„ä»€éº¼
                    if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                        chargeReady = true; // ç™¼å°„é›†æ°£å½ˆ
                    } else if (charging && chargeFrame < CHARGE_CANCEL_FRAME && !chargeReady) {
                        // åªæœ‰ chargeReady ç‚º false æ‰è£œç™¼æ™®é€šå½ˆ
                        player.isShooting = true;
                    }
                    charging = false;
                    setTimeout(() => { player.isShooting = false; }, 0); // ä¸‹ä¸€å¹€é—œé–‰æ™®é€šå°„æ“Š
                    // åœæ­¢é›†æ°£éŸ³æ•ˆ
                    if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
                    const chargeAudio = document.getElementById('charge-audio');
                    if (chargeAudio) {
                        chargeAudio.pause();
                        chargeAudio.currentTime = 0;
                        chargeAudio.volume = VOLUME_CHARGE;
                    }
                }
            }
        });
        
        // ===== éŠæˆ²åˆå§‹åŒ– =====
        const bgm = document.getElementById('bgm');
        function startGame() {
            // åœæ­¢outroéŸ³æ¨‚
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.pause();
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                outroAudio.onended = null;
            }
            // éŸ³æ¨‚æ’­æ”¾æ§åˆ¶
            if (bgm) {
                bgm.currentTime = 0;
                bgm.volume = VOLUME_BGM;
                bgm.play();
            }
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameRunning = true;
            score = 0;
            playerHealth = playerMaxHealth;
            boss.health = boss.maxHealth;
            boss.x = 2500 + 2700 * 1;
            boss.y = 350;
            bossActive = false;
            reachedBossArea = false;
            
            // é‡ç½®ç©å®¶ä½ç½®
            player.x = 100;
            player.y = platforms[0].y - player.height;
            player.vy = 0;
            player.onGround = true;
            player.direction = 1;
            player.invincible = 0;
            
            // æ¸…ç©ºé™£åˆ—
            bullets.length = 0;
            enemyBullets.length = 0;
            enemies.length = 0;
            
            // éš±è—ä»‹é¢å…ƒç´ 
            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            bossHealthContainer.style.display = 'none';
            
            // æ›´æ–°UI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // å•Ÿå‹•éŠæˆ²å¾ªç’°
            requestAnimationFrame(gameLoop);
            langToggle.style.display = 'none';
            langSelect.style.display = 'none';
            canShoot = false;
            charging = false;
            player.isShooting = false;
            chargeFrame = 0;
            chargeReady = false;
            if (chargeAudioTimeout) clearTimeout(chargeAudioTimeout);
            setTimeout(() => { canShoot = true; }, 200);
            playerDead = false; // é‡è¨­æ­»äº¡ç‹€æ…‹
            playerDeadX = 0;
            playerDeadY = 0;
        }
        
        // ===== éŠæˆ²ä¸»å¾ªç’° =====
        let lastFrameTime = 0;
        const FRAME_DURATION = 1000 / MAX_FPS;

        function gameLoop(now) {
            requestAnimationFrame(gameLoop);
            if (now - lastFrameTime < FRAME_DURATION) return;
            lastFrameTime = now;
            update();
            render();
            updateFPS();
        }
        
        // ===== éŠæˆ²ç‹€æ…‹æ›´æ–° =====
        function update() {
            // é›†æ°£ç‹€æ…‹è¨ˆæ•¸
            if (charging) {
                chargeFrame++;
            }
            // å…ˆè™•ç†é›†æ°£å½ˆ
            if (chargeReady) {
                // ç™¼å°„é›†æ°£å½ˆ
                bullets.push({
                    x: player.x + (player.direction === 1 ? player.width : -40),
                    y: player.y + player.height / 2 - 12,
                    width: 40,
                    height: 24,
                    speed: 10 * 1.1 * player.direction, // 1.1å€
                    color: '#ff0',
                    isCharge: true // æ¨™è¨˜ç‚ºé›†æ°£å½ˆ
                });
                player.shootCooldown = player.shootDelay; // çµ¦ä¸€é»å†·å»
                // æ’­æ”¾shootéŸ³æ•ˆ
                const shootAudio = document.getElementById('shoot-audio');
                if (shootAudio) {
                    shootAudio.currentTime = 0;
                    shootAudio.volume = VOLUME_SHOOT;
                    shootAudio.play();
                }
                chargeReady = false;
            }
            // æ›´æ–°ç©å®¶
            player.update();
            player.shoot();
            
            // ç›£æ§ç©å®¶ä½ç½® - åƒ…åœ¨æ“ä½œæ–¹å‘éµæ™‚è¼¸å‡º
            if (keys.ArrowLeft || keys.ArrowRight || keys.ArrowUp) {
                // console.log('ç©å®¶ä½ç½®:', { x: player.x, y: player.y, onGround: player.onGround });
            }
            
            // æ›´æ–°é¡é ­
            camera.follow(player);
            
            // Bosså€åŸŸæ•ˆæœ
            if (player.x >= BOSS_AREA_X && !bossActive && bossTimer === 0) {
                // å…ˆä¸é¡¯ç¤ºæ­£å¼bossè¡€æ¢
                bossHealthContainer.style.display = 'none';
                // å…ˆç§»é™¤æ‰€æœ‰èˆŠçš„ fake hp æ¢
                let oldFakeBar = document.getElementById('boss-fake-bar');
                if (oldFakeBar) oldFakeBar.remove();
                // æ–° fake hp æ¢å‹•ç•«
                let fakeBar = document.createElement('div');
                fakeBar.style.position = 'absolute';
                fakeBar.style.top = '10px';
                fakeBar.style.right = '10px';
                fakeBar.style.width = '200px';
                fakeBar.style.height = '20px';
                fakeBar.style.background = '#333';
                fakeBar.style.border = '2px solid #444';
                fakeBar.style.zIndex = 5;
                fakeBar.id = 'boss-fake-bar';
                let fakeFill = document.createElement('div');
                fakeFill.style.height = '100%';
                fakeFill.style.width = '1%';
                fakeFill.style.background = '#ccc';
                fakeFill.style.transition = 'none';
                fakeBar.appendChild(fakeFill);
                document.getElementById('game-container').appendChild(fakeBar);
                let animPercent = 1;
                const animStep = (100 - 1) / (1500 / 16); // 1.5ç§’ 1%~100%
                const anim = setInterval(() => {
                    animPercent += animStep;
                    if (animPercent >= 100) {
                        animPercent = 100;
                        clearInterval(anim);
                        // ç§»é™¤ fake hp æ¢ï¼Œé¡¯ç¤ºæ­£å¼ boss hp æ¢
                        let oldFakeBar2 = document.getElementById('boss-fake-bar');
                        if (oldFakeBar2) oldFakeBar2.remove();
                        bossHealthContainer.style.display = 'block';
                        updateBossHealthBar();
                    }
                    fakeFill.style.width = animPercent + '%';
                }, 16);
                bossTimer = 1;
                enemies.length = 0;
                enemyBullets.length = 0;
            }
            
            // è¨ˆæ™‚å™¨é‹è¡Œï¼Œ3 ç§’å¾Œæ¿€æ´» BOSS
            if (bossTimer > 0 && bossTimer < 250) {
                bossTimer++;
                if (bossTimer === 200) {
                    // æ’­æ”¾bosså‡ºå ´éŸ³æ•ˆ
                    const bossAudio = document.getElementById('boss-audio');
                    if (bossAudio) {
                        bossAudio.currentTime = 0;
                        bossAudio.volume = VOLUME_BOSS;
                        bossAudio.play();
                    }
                    // å»¶é²0.4ç§’å¾Œæ‰è®“bosså‡ºç¾
                    setTimeout(() => {
                        bossActive = true;
                        bossTimer = 0;
                        bossCanAttack = false;
                        bossCanMove = false;
                        setTimeout(() => {
                            bossCanAttack = true;
                            bossCanMove = true;
                        }, 700);
                    }, 400);
                }
            }
            
            // ç”Ÿæˆæ•µäºº
            if (Math.random() < 0.015 && enemies.length < 8 && !bossActive && player.x < WORLD_WIDTH - 1000) {
                // åªå¾æ–°å…­ç¨®å°æ€ªéš¨æ©Ÿé¸ä¸€ç¨®
                const enemyTypes = Object.values(ENEMY_TYPES);
                let type;
                let tryCount = 0;
                do {
                    type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                    // å¦‚æœæ˜¯ç²‰ç´…è‰²åœ°é¢æ€ªï¼Œåªæœ‰ç©å®¶å¾€å³æ™‚æ‰å…è¨±ç”Ÿæˆ
                    if (type === ENEMY_TYPES.GROUND_PINK && !keys.ArrowRight) {
                        tryCount++;
                        continue;
                    }
                    break;
                } while (tryCount < 10);
                // çµ¦æ¯éš»æ•µäººä¸€å€‹å”¯ä¸€ id ä¾›é£„æµ®ç”¨
                const enemy = {
                    x: camera.x + camera.width + 50,
                    y: type.isFlying ? (Math.random() * (WORLD_HEIGHT - 200) + 50) : (Math.random() * (WORLD_HEIGHT - 100) + 50),
                    width: 30,
                    height: 30,
                    speed: type.speed,
                    health: type.health,
                    score: type.score,
                    color: type.color,
                    behavior: type.behavior,
                    onGround: false,
                    vy: 0,
                    shootCooldown: 0,
                    shootDelay: type.shootDelay || 0,
                    isFlying: type.isFlying,
                    eye: type.eye,
                    _id: Math.random() * 1000000 | 0 // é£„æµ®ç”¨
                };
                enemies.push(enemy);
            }
            
            // æ›´æ–°æ•µäºº
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (enemy.isFloating) {
                    // é£„æµ®å°å…µï¼šä¸Šä¸‹é£„å‹•ï¼Œä¸å—é‡åŠ›èˆ‡å¹³å°å½±éŸ¿
                    if (!enemy.floatBaseY) enemy.floatBaseY = enemy.y;
                    enemy.y = enemy.floatBaseY + Math.sin(Date.now() / 400 + i) * 40;
                    enemy.x -= enemy.speed;
                } else {
                    // åŸæœ¬åœ°é¢å°å…µ
                    enemy.vy += GRAVITY;
                    let newY = enemy.y + enemy.vy;
                    enemy.onGround = false;
                    for (let p of platforms) {
                        const overlapX = enemy.x + enemy.width > p.x && enemy.x < p.x + p.width;
                        if (overlapX && enemy.y + enemy.height <= p.y && newY + enemy.height >= p.y) {
                            newY = p.y - enemy.height;
                            enemy.vy = 0;
                            enemy.onGround = true;
                        }
                    }
                    enemy.y = newY;
                    enemy.behavior(enemy);
                }
                // æ›´æ–°æ•µäººé–ƒçˆç‹€æ…‹
                if (enemyHitFlash.has(enemy)) {
                    let frame = enemyHitFlash.get(enemy);
                    frame--;
                    if (frame <= 0) {
                        enemyHitFlash.delete(enemy);
                    } else {
                        enemyHitFlash.set(enemy, frame);
                    }
                }
                // ç§»é™¤å±å¹•å¤–çš„æ•µäºº
                if (enemy.x < camera.x - 100 || enemy.x > camera.x + camera.width + 100) {
                    enemies.splice(i, 1);
                    continue;
                }
                // æª¢æ¸¬ç©å®¶ç¢°æ’
                if (checkCollision(player, enemy)) {
                    player.takeDamage(10);
                    enemies.splice(i, 1);
                    continue;
                }
            }
            
            // æ›´æ–°Boss
            if (bossActive) {
                boss.update();
                
                // æª¢æ¸¬ç©å®¶ç¢°æ’
                if (checkCollision(player, boss)) {
                    player.takeDamage(15);
                }
            }
            
            // æ›´æ–°å­å½ˆ
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.speed;
                
                // ç§»é™¤å±å¹•å¤–çš„å­å½ˆ
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // æª¢æ¸¬æ•µäººç¢°æ’
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    if (checkCollision(bullet, enemy)) {
                        if (bullet.isCharge) {
                            enemy.health -= 5; // é›†æ°£å½ˆæ”»æ“ŠåŠ›5å€
                        } else {
                            enemy.health--;
                        }
                        enemyHitFlash.set(enemy, 12); // 0.2ç§’é–ƒçˆ
                        // æ’­æ”¾booméŸ³æ•ˆï¼ˆé›†æ°£å½ˆä¹Ÿæœ‰ï¼‰
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            boomAudio.currentTime = 0;
                            boomAudio.volume = VOLUME_BOOM;
                            boomAudio.play();
                        }
                        if (enemy.health <= 0) {
                            enemy.health = 0;
                            enemies.splice(j, 1);
                            score += enemy.score;
                            updateScore();
                        }
                        bullets.splice(i, 1);
                        break;
                    }
                }
                
                // æª¢æ¸¬Bossç¢°æ’
                if (bossActive && checkCollision(bullet, boss)) {
                    if (bullet.isCharge) {
                        boss.health -= 15; // é›†æ°£å½ˆæ”»æ“ŠåŠ›5å€
                        boss.pauseTimer = 42; // æ–°å¢ï¼šæš«åœ0.7ç§’
                    } else {
                        boss.health -= 5;
                    }
                    bossHitFlash = 12; // 0.2ç§’é–ƒçˆ
                    updateBossHealthBar();
                    if (boss.health > 0) {
                        const boomAudio = document.getElementById('boom-audio');
                        if (boomAudio) {
                            boomAudio.currentTime = 0;
                            boomAudio.volume = VOLUME_BOOM;
                            boomAudio.play();
                        }
                    }
                    bullets.splice(i, 1);
                    score += bullet.isCharge ? 100 : 20;
                    updateScore();
                    if (boss.health <= 0) {
                        boss.health = 0;
                        updateBossHealthBar();
                        bossActive = false;
                        gameRunning = false;
                        // åœæ­¢BGM
                        if (bgm) {
                            bgm.pause();
                            bgm.currentTime = 0;
                        }
                        // æ’­æ”¾bossdieéŸ³æ•ˆ
                        const bossdieAudio = document.getElementById('bossdie-audio');
                        if (bossdieAudio) {
                            bossdieAudio.currentTime = 0;
                            bossdieAudio.volume = VOLUME_BOSSDIE;
                            bossdieAudio.play();
                        }
                        // 1. é»ƒç™½é–ƒçˆ2ç§’
                        const flashDiv = document.getElementById('flash-effect');
                        const winScreen = document.getElementById('win-screen');
                        if (flashDiv) {
                            flashDiv.style.display = 'block';
                            let flashFrame = 0;
                            flashDiv.style.opacity = 1;
                            const flashInterval = setInterval(() => {
                                flashDiv.style.background = (flashFrame % 2 === 0) ? 'rgba(255,255,0,0.7)' : 'rgba(255,255,255,0.7)';
                                flashFrame++;
                            }, 100);
                            setTimeout(() => {
                                clearInterval(flashInterval);
                                // 2. 3ç§’æ¼¸å±¤è®Šå…¨ç™½
                                let opacity = 0.7;
                                flashDiv.style.background = '#fff';
                                const fadeInStep = 0.0067; // 0.0067*20ms*150æ¬¡ â‰ˆ 1
                                const fadeIn = setInterval(() => {
                                    opacity += fadeInStep;
                                    flashDiv.style.opacity = opacity;
                                    if (opacity >= 1) {
                                        clearInterval(fadeIn);
                                        // 3. å…¨ç™½æ™‚æ’­æ”¾outroä¸¦é¡¯ç¤ºå‹åˆ©ç•«é¢ï¼Œå‹åˆ©ç•«é¢opacity=0
                                        winGame();
                                        winScreen.style.opacity = 0;
                                        // æ’­æ”¾outroéŸ³æ¨‚
                                        const outroAudio = document.getElementById('outro-audio');
                                        if (outroAudio) {
                                            outroAudio.currentTime = 0;
                                            outroAudio.volume = VOLUME_OUTRO;
                                            outroAudio.play();
                                        }
                                        // 4. 2ç§’å…§ç™½è‰²é®ç½©æ·¡å‡ºã€å‹åˆ©ç•«é¢åŒæ­¥æ·¡å…¥
                                        let outOpacity = 1;
                                        let winOpacity = 0;
                                        const fadeOut = setInterval(() => {
                                            outOpacity -= 0.02;
                                            winOpacity += 0.02;
                                            flashDiv.style.opacity = outOpacity;
                                            winScreen.style.opacity = winOpacity;
                                            if (outOpacity <= 0) {
                                                clearInterval(fadeOut);
                                                flashDiv.style.display = 'none';
                                                winScreen.style.opacity = 1;
                                            }
                                        }, 20);
                                    }
                                }, 20);
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                winGame();
                            }, 3000);
                        }
                    }
                }
            }
            
            // æ›´æ–°æ•µæ–¹å­å½ˆ
            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                bullet.x += bullet.speedX;
                bullet.y += bullet.speedY;
                
                // ç§»é™¤å±å¹•å¤–çš„å­å½ˆ
                if (bullet.x < camera.x - 50 || bullet.x > camera.x + camera.width + 50 ||
                    bullet.y < camera.y - 50 || bullet.y > camera.y + camera.height + 50) {
                    enemyBullets.splice(i, 1);
                    continue;
                }
                
                // æª¢æ¸¬ç©å®¶ç¢°æ’
                if (checkCollision(bullet, player)) {
                    player.takeDamage(5);
                    enemyBullets.splice(i, 1);
                }
            }
            
            // åœ¨update()æœ€å¾ŒåŠ ä¸ŠbossHitFlashéæ¸›
            if (bossHitFlash > 0) bossHitFlash--;
        }
        
        // ===== æ¸²æŸ“éŠæˆ² =====
        function render() {
            // æ¸…é™¤ç•«å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ä¿å­˜ç•¶å‰ç‹€æ…‹
            ctx.save();
            
            // æ‡‰ç”¨é¡é ­è®Šæ›
            ctx.translate(-camera.x, -camera.y);
            
            // ç¹ªè£½èƒŒæ™¯ (ç°¡å–®çš„æ˜Ÿç©ºæ•ˆæœ)
            ctx.fillStyle = '#112';
            ctx.fillRect(0, 0, WORLD_WIDTH, WORLD_HEIGHT);
            
            // ç¹ªè£½æ˜Ÿæ˜Ÿ
            ctx.fillStyle = '#fff';
            for (let i = 0; i < 100; i++) {
                const x = (i * 24 + (camera.x / 2)) % WORLD_WIDTH;
                const y = (i * 19 + (camera.y / 2)) % WORLD_HEIGHT;
                const size = 1 + (i % 3);
                ctx.fillRect(x, y, size, size);
            }
            
            // ç¹ªè£½å¹³å°
            platforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            });
            
            // ç¹ªè£½ç©å®¶ (ç„¡æ•µæ™‚é–ƒçˆ)
            if (!playerDead) { // æ­»äº¡æ™‚ä¸ç¹ªè£½
                if (charging && chargeFrame >= CHARGE_MIN_FRAME) {
                    if (Math.floor(Date.now() / 100) % 2 === 0) {
                        ctx.fillStyle = '#cfbb3a'; // æ·ºé»ƒè‰²
                    } else {
                        ctx.fillStyle = player.color;
                    }
                } else {
                    ctx.fillStyle = player.color;
                }
                if (player.invincible <= 0 || Math.floor(player.invincible / 5) % 2 === 0) {
                    ctx.fillRect(player.x, player.y, player.width, player.height);
                    // åªç•«å¤§çœ¼ç™½ï¼Œä¸ç•«çœ¼ç 
                    ctx.beginPath();
                    if (player.direction === 1) {
                        ctx.ellipse(player.x + player.width - 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                    } else {
                        ctx.ellipse(player.x + 12, player.y + 18, 8, 10, 0, 0, Math.PI * 2);
                    }
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                }
            }
            ctx.globalAlpha = 1;
            
            // ç¹ªè£½å­å½ˆ
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                if (bullet.isCharge) {
                    ctx.save();
                    ctx.shadowColor = '#ff0';
                    ctx.shadowBlur = 20;
                    // é›†æ°£å½ˆï¼šä¸Šä¸‹çª„çš„æ©¢åœ“
                    ctx.beginPath();
                    ctx.ellipse(
                        bullet.x + bullet.width / 2,
                        bullet.y + bullet.height / 2,
                        bullet.width / 2,
                        bullet.height / 1.5,
                        0, 0, Math.PI * 2
                    );
                    ctx.fill();
                    ctx.restore();
                } else {
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // ç¹ªè£½æ•µäºº
            enemies.forEach(enemy => {
                // é–ƒçˆæ•ˆæœ
                if (enemyHitFlash.has(enemy)) {
                    if (Math.floor(Date.now() / 50) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
                if (enemy.isFlying) {
                    // é£›è¡Œæ•µäººï¼šåœ“å½¢
                    ctx.save();
                    ctx.beginPath();
                    ctx.ellipse(enemy.x + enemy.width/2, enemy.y + enemy.height/2, enemy.width/2, enemy.height/2, 0, 0, Math.PI*2);
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // çœ¼ç›ï¼ˆæ©¢åœ“å³å‰æ–¹ï¼‰
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.75, enemy.y + enemy.height/2, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                } else {
                    // è·¯é¢æ•µäººï¼šåŠåœ“ï¼ˆæœå³ï¼‰
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width/2, enemy.y + enemy.height, enemy.width/2, Math.PI, 0, false);
                    ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height);
                    ctx.lineTo(enemy.x, enemy.y + enemy.height);
                    ctx.closePath();
                    ctx.fillStyle = enemy.color;
                    ctx.fill();
                    // çœ¼ç›ï¼ˆå·¦å‰æ–¹ï¼‰
                    ctx.beginPath();
                    ctx.arc(enemy.x + enemy.width*0.25, enemy.y + enemy.height*0.75, enemy.width/8, 0, Math.PI*2);
                    ctx.fillStyle = '#fff';
                    ctx.fill();
                    ctx.restore();
                }
                ctx.globalAlpha = 1;
            });
            
            // ç¹ªè£½Boss
            if (bossActive) {
                if (bossHitFlash > 0) {
                    if (Math.floor(Date.now() / 50) % 2 === 0) {
                        ctx.globalAlpha = 0.3;
                    } else {
                        ctx.globalAlpha = 1;
                    }
                }
                // ä¸»é«”ï¼šåœ“è§’çŸ©å½¢
                const r = 28; // åœ“è§’åŠå¾‘
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y);
                ctx.lineTo(boss.x + boss.width - r, boss.y);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y, boss.x + boss.width, boss.y + r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + r);
                ctx.quadraticCurveTo(boss.x, boss.y, boss.x + r, boss.y);
                ctx.closePath();
                ctx.fillStyle = boss.color;
                ctx.fill();
                // åº•ä¸‹1/5ç‚ºæ›´é®®æ˜çš„é»ƒè‰²
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(boss.x + r, boss.y + boss.height * 0.8);
                ctx.lineTo(boss.x + boss.width - r, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height * 0.8, boss.x + boss.width, boss.y + boss.height - r);
                ctx.lineTo(boss.x + boss.width, boss.y + boss.height - r);
                ctx.quadraticCurveTo(boss.x + boss.width, boss.y + boss.height, boss.x + boss.width - r, boss.y + boss.height);
                ctx.lineTo(boss.x + r, boss.y + boss.height);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height, boss.x, boss.y + boss.height - r);
                ctx.lineTo(boss.x, boss.y + boss.height * 0.8);
                ctx.quadraticCurveTo(boss.x, boss.y + boss.height * 0.8, boss.x + r, boss.y + boss.height * 0.8);
                ctx.closePath();
                ctx.fillStyle = '#ffd600'; // æ›´é®®æ˜çš„é»ƒè‰²
                ctx.fill();
                ctx.restore();
                // çœ¼ç›ï¼ˆä¸Šæ–¹å…©å€‹ï¼Œç™½è‰²çœ¼ç™½ã€ç´…è‰²çœ¼ç ï¼‰
                // å·¦çœ¼
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.32, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // å³çœ¼
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.32, 10, 14, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(boss.x + boss.width * 0.68, boss.y + boss.height * 0.36, 4, 6, 0, 0, Math.PI * 2);
                ctx.fillStyle = '#f44';
                ctx.fill();
                // é¢¨æ‰‡ï¼ˆé»ƒè‰²åœ“å½¢ï¼‰
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 20, 0, Math.PI*2);
                ctx.fillStyle = '#ffe082'; // é»ƒè‰²
                ctx.fill();
                // é¢¨æ‰‡ä¸­å¿ƒ
                ctx.beginPath();
                ctx.arc(boss.x + boss.width/2, boss.y + boss.height/2 + 10, 7, 0, Math.PI*2);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.restore();
                ctx.globalAlpha = 1;
            }
            
            // ç¹ªè£½æ•µæ–¹å­å½ˆ
            enemyBullets.forEach(bullet => {
                // Bosså­å½ˆï¼ˆtornadoï¼‰
                if (bullet.color === '#f4a') {
                    const tornadoImg = document.getElementById('tornado-img');
                    if (tornadoImg && tornadoImg.complete) {
                        ctx.save();
                        // æ—‹è½‰æ–¹å‘
                        const angle = Math.atan2(bullet.speedY, bullet.speedX);
                        ctx.translate(bullet.x + 3.4125, bullet.y + 13.65); // 6.825x27.3ä¸­å¿ƒ
                        ctx.rotate(angle + Math.PI);
                        ctx.drawImage(tornadoImg, -5, -5, 30, 30); //é¾æ²é¢¨å°ºå¯¸
                        ctx.restore();
                    } else {
                        ctx.fillStyle = bullet.color;
                        ctx.fillRect(bullet.x, bullet.y, 10, 20);
                    }
                } else {
                    ctx.fillStyle = bullet.color;
                    ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                }
            });
            
            // æ¢å¾©ç‹€æ…‹
            ctx.restore();
            
            // ç¹ªè£½UI
            updateHealthBar();
            updateBossHealthBar();
            updateScore();
            
            // èª¿è©¦ä¿¡æ¯
            cameraDebugElement.textContent = `moved: (${Math.floor(camera.x)})`;
        }
        
        // ===== å·¥å…·å‡½æ•¸ =====
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }
        
        function updateHealthBar() {
            const percent = (playerHealth / playerMaxHealth) * 100;
            healthFill.style.width = `${percent}%`;
            if (percent <= 20) {
                healthFill.style.backgroundColor = '#f44'; // ç´…è‰²
            } else {
                healthFill.style.backgroundColor = '#4af'; // è—è‰²
            }
        }
        
        function updateBossHealthBar() {
            if (window.bossHpAnimating) return;
            const percent = (boss.health / boss.maxHealth) * 100;
            bossHealthFill.style.width = `${percent}%`;
        }
        
        function updateScore() {
            scoreElement.textContent = `score: ${score}`;
        }
        
        function gameOver() {
            gameRunning = false;
            playerDeadX = player.x; // è¨˜éŒ„æ­»äº¡æ™‚ä½ç½®
            playerDeadY = player.y;
            playerDead = true; // è¨­ç‚ºæ­»äº¡ç‹€æ…‹
            finalScoreElement.textContent = `score: ${score}`;
            gameOverScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // åœæ­¢BGMä¸¦æ’­æ”¾Game OveréŸ³æ•ˆ
            if (bgm) {
                bgm.pause();
                bgm.currentTime = 0;
            }
            const gameOverAudio = document.getElementById('game-over-audio');
            if (gameOverAudio) {
                gameOverAudio.currentTime = 0;
                gameOverAudio.volume = VOLUME_GAMEOVER;
                gameOverAudio.play();
            }
        }
        
        function winGame() {
            gameRunning = false;
            if (currentLang === 'zh') {
                winScoreElement.innerHTML = '<div>score: åˆ†æ•¸é«˜åˆ°ç„¡æ³•è¨ˆç®—</div>';
            } else if (currentLang === 'ja') {
                winScoreElement.innerHTML = '<div>score: å›ã®ã‚¹ã‚³ã‚¢ã¯é«˜ã™ãã¦è¨ˆç®—ã§ããªã„ã€‚</div>';
            } else {
                winScoreElement.innerHTML = '<div>score: Your score is incalculably high.</div>';
            }
            winScreen.style.display = 'flex';
            langToggle.style.display = 'block';
            langSelect.style.display = 'none';
            // æ’­æ”¾å‹åˆ©éŸ³æ¨‚
            const outroAudio = document.getElementById('outro-audio');
            if (outroAudio) {
                outroAudio.currentTime = 0;
                outroAudio.volume = VOLUME_OUTRO;
                outroAudio.play();
                // ç¢ºä¿onendedäº‹ä»¶è¨­ç½®
                outroAudio.onended = function() {
                    setTimeout(() => {
                        outroAudio.currentTime = 0;
                        outroAudio.play();
                    }, 1000);
                };
            }
            winScoreElement.innerHTML = LANGUAGES[currentLang].winScore;
            playAgainButton.textContent = LANGUAGES[currentLang].playagain;
        }
        
        // ===== èªè¨€è³‡æ–™ =====
        const LANGUAGES = {
            zh: {
                title: 'å¥§å¤åƒè¬å¥§å¤åƒè¬',
                shoot: 'ç©ºç™½éµ å°„æ“Š',
                move: ' â† â†’ ç§»å‹•',
                jump: ' â†‘ è·³èº',
                start: 'START',
                gameover: 'ä½•å›ã‚„ã£ã¦ã‚‚ã€€ä½•å›ã‚„ã£ã¦ã‚‚ã€€ã‚¨ã‚¢ãƒ¼ã¾ã‚“ãŒ...',
                retry: 'å†trytry',
                win: '<div>å‘½é‹è©¦åœ–é˜»æ­¢ä½ ...</div><div>ä½†ä½ æˆ°å‹äº†ï¼</div><div>è«‹ç›¸ä¿¡è‡ªå·±ï¼</div><div>ä¸ç®¡å¤šå¤§å›°é›£ï¼ä½ éƒ½èƒ½å…‹æœï¼</div>',
                winScore: '<div>SCORE: ç„¡äººèƒ½å®šç¾©ä½ çš„åˆ†æ•¸ï¼Œé‚£äº›çœ‹ä¸è¦‹çš„åŠªåŠ›ï¼Œæ‰æ˜¯ä½ æœ€çœŸå¯¦çš„å¯¦åŠ›!</div>',
                playagain: 'ä½ æƒ³å†ç©ä¸€æ¬¡ä¹Ÿæ˜¯å¯ä»¥...'
            },
            ja: {
                title: 'å„„åƒä¸‡å„„åƒä¸‡',
                shoot: 'ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ ã‚·ãƒ§ãƒƒãƒˆ',
                move: ' â† â†’ ã‚­ãƒ¼ ç§»å‹•',
                jump: 'â†‘ ã‚­ãƒ¼ ã‚¸ãƒ£ãƒ³ãƒ—',
                start: 'ã‚¹ã‚¿ãƒ¼ãƒˆ',
                gameover: 'ä½•å›ã‚„ã£ã¦ã‚‚ã€€ä½•å›ã‚„ã£ã¦ã‚‚ã€€ã‚¨ã‚¢ãƒ¼ã¾ã‚“ãŒ...',
                retry: 'ã‚‚ã†ä¸€åº¦',
                win: '<div>é‹å‘½ã¯å›ã‚’æ­¢ã‚ãŸãŒã€</div><div>å›ãŒå‹ã£ãŸï¼</div><div>è‡ªåˆ†ã‚’ä¿¡ã˜ã¦ï¼</div>ã©ã‚“ãªå›°é›£ã§ã‚‚å¿…ãšä¹—ã‚Šè¶Šãˆã‚‰ã‚Œã‚‹ï¼<div></div>',
                winScore: '<div>SCORE: å›ã®ä¾¡å€¤ã‚’ç‚¹æ•°ã§æ±ºã‚ã‚‰ã‚Œã‚‹ã‚ã‘ãŒãªã„ï¼</div>',
                playagain: 'ã‚‚ã†ä¸€åº¦éŠã³ã¾ã™ã‹ï¼Ÿ'
            },
            en: {
                title: 'Mega AI',
                shoot: 'Press SPACE to Shoot',
                move: 'Press â† â†’ to Move',
                jump: 'Press â†‘ to Jump',
                start: 'START',
                gameover: 'The Untouchable Airman',
                retry: 'Retry',
                win: '<div>Fate tried to stop you...</div><div>but you prevailed !</div><div>Believe in yourself !</div><div>And overcome any difficulty !</div>',
                winScore: '<div>SCORE: Scores are for tests. You\'re not a test-you\'re a force.</div>',
                playagain: 'Play again?'
            }
        };
        let currentLang = localStorage.getItem('lang') || 'zh';
        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            const L = LANGUAGES[lang];
            document.querySelector('#start-screen h1').textContent = L.title;
            document.querySelectorAll('#start-screen p')[0].textContent = L.shoot;
            document.querySelectorAll('#start-screen p')[1].textContent = L.move;
            document.querySelectorAll('#start-screen p')[2].textContent = L.jump;
            startButton.textContent = L.start;
            document.querySelector('#game-over-screen h1').textContent = L.gameover;
            restartButton.textContent = L.retry;
            document.querySelector('#win-screen h1').innerHTML = L.win;
            winScoreElement.innerHTML = L.winScore;
            playAgainButton.textContent = L.playagain;
        }
        // ===== èªè¨€é¸æ“‡UI =====
        const langSelect = document.getElementById('language-select');
        const langToggle = document.getElementById('lang-toggle');
        langToggle.onclick = () => {
            langSelect.style.display = (langSelect.style.display === 'flex') ? 'none' : 'flex';
        };
        document.getElementById('lang-zh').onclick = () => { setLang('zh'); langSelect.style.display = 'none'; };
        document.getElementById('lang-ja').onclick = () => { setLang('ja'); langSelect.style.display = 'none'; };
        document.getElementById('lang-en').onclick = () => { setLang('en'); langSelect.style.display = 'none'; };
        // é è¨­èªè¨€
        window.addEventListener('DOMContentLoaded', () => {
            setLang(currentLang);
            langSelect.style.display = 'none';
            langToggle.style.display = 'block';
            // æ¡Œæ©Ÿè‡ªå‹•éš±è—è§¸æ§æŒ‰éˆ•
            const isDesktop = /Win32|Win64|Windows|Macintosh|MacIntel|MacPPC|Mac68K/.test(navigator.platform);
            if (isDesktop) {
                document.getElementById('touch-controls').style.display = 'none';
            }
        });
        
        // ===== è§¸æ§æ“ä½œæ¨¡æ“¬éµç›¤ =====
        function simulateKey(key, isDown) {
            const event = new KeyboardEvent(isDown ? 'keydown' : 'keyup', { key });
            document.dispatchEvent(event);
        }
        function addTouchBtnEvent(btnId, key) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            // è§¸æ§
            btn.addEventListener('touchstart', e => { if (e.cancelable) e.preventDefault(); simulateKey(key, true); });
            btn.addEventListener('touchend',   e => { if (e.cancelable) e.preventDefault(); simulateKey(key, false); });
            // æ»‘é¼ 
            btn.addEventListener('mousedown',  e => { e.preventDefault(); simulateKey(key, true); });
            btn.addEventListener('mouseup',    e => { e.preventDefault(); simulateKey(key, false); });
            btn.addEventListener('mouseleave', e => { simulateKey(key, false); });
        }
        addTouchBtnEvent('btn-left',  'ArrowLeft');
        addTouchBtnEvent('btn-right', 'ArrowRight');
        addTouchBtnEvent('btn-jump',  'ArrowUp');
        addTouchBtnEvent('btn-shoot', ' ');
        
        function resizeGame() {
            const baseWidth = 800;
            const baseHeight = 500;
            const scaleX = window.innerWidth / baseWidth;
            const scaleY = window.innerHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY);

            const wrapper = document.getElementById('game-wrapper');
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.transformOrigin = 'top left';
            wrapper.style.position = 'absolute';
            wrapper.style.left = `calc(50vw - ${(baseWidth * scale) / 2}px)`;
            wrapper.style.top = `calc(50vh - ${(baseHeight * scale) / 2}px)`;
            wrapper.style.width = baseWidth + 'px';
            wrapper.style.height = baseHeight + 'px';
        }
        window.addEventListener('resize', resizeGame);
        window.addEventListener('DOMContentLoaded', resizeGame);

        // ===== FPS è¨ˆç®—èˆ‡é¡¯ç¤º =====
        let lastFPSTime = performance.now();
        let frameCount = 0;
        let fps = 0;
        function updateFPS() {
            frameCount++;
            const now = performance.now();
            if (now - lastFPSTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFPSTime = now;
                const fpsDiv = document.getElementById('fps-display');
                if (fpsDiv) {
                    fpsDiv.textContent = `FPS: ${fps}`;
                    fpsDiv.style.display = showFPS == 1 ? 'block' : 'none';
                }
            }
            // æ¯å¹€æ›´æ–°ç©å®¶åº§æ¨™
            const xy = document.getElementById('xy-display');
            if (xy) {
                xy.textContent = `X: ${Math.round(player.x)}, Y: ${Math.round(player.y)}`;
                xy.style.display = showXY == 1 ? 'block' : 'none';
            }
            // æ¯å¹€æ›´æ–°ç©å®¶æ ¼æ•¸åº§æ¨™
            const nxy = document.getElementById('nxy-display');
            if (nxy) {
                const nx = Math.floor(player.x / 50);
                const ny = Math.floor((500 - player.y) / 50);
                nxy.textContent = `NX: ${nx}, NY: ${ny}`;
                nxy.style.display = showNXY == 1 ? 'block' : 'none';
            }
            // æ¯å¹€æ›´æ–°æ•¸é‡è³‡è¨Š
            const entityCounts = document.getElementById('entity-counts');
            if (entityCounts) {
                const bossCount = bosses.filter(b => b && bossActive).length;
                entityCounts.textContent = `P: ${players.length}, PS: ${bullets.length}, E: ${enemies.length}, EP: ${enemyBullets.length}, B: ${bossCount}`;
                entityCounts.style.display = showEntityCounts == 1 ? 'block' : 'none';
            }
        }

    </script>
</body>
</html>